<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>refactor: use spaces instead of tabs, style enhancement for target - stagit-responsive - My mobile friendly fork of stagit
</title>
<link rel="icon" type="image/png" href="/favicon.png" />
<link rel="alternate" type="application/atom+xml" title="stagit-responsive Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="/style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="/logo.png" alt="" width="32" height="32" /></a></td><td><h1>stagit-responsive</h1><span class="desc">My mobile friendly fork of stagit
</span></td></tr><tr><td></td><td>
<a href="../index.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<div id="pre-scroll">
<pre><b>commit</b> <a href="../commit/1bc04c027e39cbd2ae4b93c216eb34a5cefb3055.html">1bc04c027e39cbd2ae4b93c216eb34a5cefb3055</a>
<b>parent</b> <a href="../commit/a8318e0499e4de4b09846a99e04dec36c3c6ac0f.html">a8318e0499e4de4b09846a99e04dec36c3c6ac0f</a>
<b>Author:</b> Yohanes Bandung &lt;<a href="mailto:hi@ybbond.dev">hi@ybbond.dev</a>&gt;
<b>Date:</b>   Wed, 20 May 2020 13:29:09 +0700

refactor: use spaces instead of tabs, style enhancement for target

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">reallocarray.c</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">stagit-index.c</a></td><td> | </td><td class="num">286</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">stagit.c</a></td><td> | </td><td class="num">2108</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">strlcat.c</a></td><td> | </td><td class="num">42</td><td><span class="i">+++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">strlcpy.c</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++</span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">style.css</a></td><td> | </td><td class="num">77</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
</table></pre></div><p>6 files changed, 1282 insertions(<span id="plus">+</span>), 1281 deletions(<span id="min">-</span>)</p>
<div id="pre-scroll">
<pre>
<b>diff --git a/<a id="h0" href="../file/reallocarray.c.html">reallocarray.c</a> b/<a href="../file/reallocarray.c.html">reallocarray.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -25,15 +25,15 @@
</a>  * This is sqrt(SIZE_MAX+1), as s1*s2 &lt;= SIZE_MAX
  * if both s1 &lt; MUL_NO_OVERFLOW and s2 &lt; MUL_NO_OVERFLOW
  */
<a href="#h0-0-3" id="h0-0-3" class="d">-#define MUL_NO_OVERFLOW	(1UL &lt;&lt; (sizeof(size_t) * 4))
</a><a href="#h0-0-4" id="h0-0-4" class="i">+#define MUL_NO_OVERFLOW  (1UL &lt;&lt; (sizeof(size_t) * 4))
</a> 
 void *
 reallocarray(void *optr, size_t nmemb, size_t size)
 {
<a href="#h0-0-9" id="h0-0-9" class="d">-	if ((nmemb &gt;= MUL_NO_OVERFLOW || size &gt;= MUL_NO_OVERFLOW) &amp;&amp;
</a><a href="#h0-0-10" id="h0-0-10" class="d">-	    nmemb &gt; 0 &amp;&amp; SIZE_MAX / nmemb &lt; size) {
</a><a href="#h0-0-11" id="h0-0-11" class="d">-		errno = ENOMEM;
</a><a href="#h0-0-12" id="h0-0-12" class="d">-		return NULL;
</a><a href="#h0-0-13" id="h0-0-13" class="d">-	}
</a><a href="#h0-0-14" id="h0-0-14" class="d">-	return realloc(optr, size * nmemb);
</a><a href="#h0-0-15" id="h0-0-15" class="i">+  if ((nmemb &gt;= MUL_NO_OVERFLOW || size &gt;= MUL_NO_OVERFLOW) &amp;&amp;
</a><a href="#h0-0-16" id="h0-0-16" class="i">+      nmemb &gt; 0 &amp;&amp; SIZE_MAX / nmemb &lt; size) {
</a><a href="#h0-0-17" id="h0-0-17" class="i">+    errno = ENOMEM;
</a><a href="#h0-0-18" id="h0-0-18" class="i">+    return NULL;
</a><a href="#h0-0-19" id="h0-0-19" class="i">+  }
</a><a href="#h0-0-20" id="h0-0-20" class="i">+  return realloc(optr, size * nmemb);
</a> }
<b>diff --git a/<a id="h1" href="../file/stagit-index.c.html">stagit-index.c</a> b/<a href="../file/stagit-index.c.html">stagit-index.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -18,189 +18,189 @@ static char *name = &quot;&quot;;
</a> void
 joinpath(char *buf, size_t bufsiz, const char *path, const char *path2)
 {
<a href="#h1-0-3" id="h1-0-3" class="d">-	int r;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+  int r;
</a> 
<a href="#h1-0-6" id="h1-0-6" class="d">-	r = snprintf(buf, bufsiz, &quot;%s%s%s&quot;,
</a><a href="#h1-0-7" id="h1-0-7" class="d">-		path, path[0] &amp;&amp; path[strlen(path) - 1] != &#39;/&#39; ? &quot;/&quot; : &quot;&quot;, path2);
</a><a href="#h1-0-8" id="h1-0-8" class="d">-	if (r &lt; 0 || (size_t)r &gt;= bufsiz)
</a><a href="#h1-0-9" id="h1-0-9" class="d">-		errx(1, &quot;path truncated: &#39;%s%s%s&#39;&quot;,
</a><a href="#h1-0-10" id="h1-0-10" class="d">-			path, path[0] &amp;&amp; path[strlen(path) - 1] != &#39;/&#39; ? &quot;/&quot; : &quot;&quot;, path2);
</a><a href="#h1-0-11" id="h1-0-11" class="i">+  r = snprintf(buf, bufsiz, &quot;%s%s%s&quot;,
</a><a href="#h1-0-12" id="h1-0-12" class="i">+    path, path[0] &amp;&amp; path[strlen(path) - 1] != &#39;/&#39; ? &quot;/&quot; : &quot;&quot;, path2);
</a><a href="#h1-0-13" id="h1-0-13" class="i">+  if (r &lt; 0 || (size_t)r &gt;= bufsiz)
</a><a href="#h1-0-14" id="h1-0-14" class="i">+    errx(1, &quot;path truncated: &#39;%s%s%s&#39;&quot;,
</a><a href="#h1-0-15" id="h1-0-15" class="i">+      path, path[0] &amp;&amp; path[strlen(path) - 1] != &#39;/&#39; ? &quot;/&quot; : &quot;&quot;, path2);
</a> }
 
 /* Escape characters below as HTML 2.0 / XML 1.0. */
 void
 xmlencode(FILE *fp, const char *s, size_t len)
 {
<a href="#h1-0-22" id="h1-0-22" class="d">-	size_t i;
</a><a href="#h1-0-23" id="h1-0-23" class="d">-
</a><a href="#h1-0-24" id="h1-0-24" class="d">-	for (i = 0; *s &amp;&amp; i &lt; len; s++, i++) {
</a><a href="#h1-0-25" id="h1-0-25" class="d">-		switch(*s) {
</a><a href="#h1-0-26" id="h1-0-26" class="d">-		case &#39;&lt;&#39;:  fputs(&quot;&amp;lt;&quot;,   fp); break;
</a><a href="#h1-0-27" id="h1-0-27" class="d">-		case &#39;&gt;&#39;:  fputs(&quot;&amp;gt;&quot;,   fp); break;
</a><a href="#h1-0-28" id="h1-0-28" class="d">-		case &#39;\&#39;&#39;: fputs(&quot;&amp;#39;&quot; , fp); break;
</a><a href="#h1-0-29" id="h1-0-29" class="d">-		case &#39;&amp;&#39;:  fputs(&quot;&amp;amp;&quot;,  fp); break;
</a><a href="#h1-0-30" id="h1-0-30" class="d">-		case &#39;&quot;&#39;:  fputs(&quot;&amp;quot;&quot;, fp); break;
</a><a href="#h1-0-31" id="h1-0-31" class="d">-		default:   fputc(*s, fp);
</a><a href="#h1-0-32" id="h1-0-32" class="d">-		}
</a><a href="#h1-0-33" id="h1-0-33" class="d">-	}
</a><a href="#h1-0-34" id="h1-0-34" class="i">+  size_t i;
</a><a href="#h1-0-35" id="h1-0-35" class="i">+
</a><a href="#h1-0-36" id="h1-0-36" class="i">+  for (i = 0; *s &amp;&amp; i &lt; len; s++, i++) {
</a><a href="#h1-0-37" id="h1-0-37" class="i">+    switch(*s) {
</a><a href="#h1-0-38" id="h1-0-38" class="i">+    case &#39;&lt;&#39;:  fputs(&quot;&amp;lt;&quot;,   fp); break;
</a><a href="#h1-0-39" id="h1-0-39" class="i">+    case &#39;&gt;&#39;:  fputs(&quot;&amp;gt;&quot;,   fp); break;
</a><a href="#h1-0-40" id="h1-0-40" class="i">+    case &#39;\&#39;&#39;: fputs(&quot;&amp;#39;&quot; , fp); break;
</a><a href="#h1-0-41" id="h1-0-41" class="i">+    case &#39;&amp;&#39;:  fputs(&quot;&amp;amp;&quot;,  fp); break;
</a><a href="#h1-0-42" id="h1-0-42" class="i">+    case &#39;&quot;&#39;:  fputs(&quot;&amp;quot;&quot;, fp); break;
</a><a href="#h1-0-43" id="h1-0-43" class="i">+    default:   fputc(*s, fp);
</a><a href="#h1-0-44" id="h1-0-44" class="i">+    }
</a><a href="#h1-0-45" id="h1-0-45" class="i">+  }
</a> }
 
 void
 printtimeshort(FILE *fp, const git_time *intime)
 {
<a href="#h1-0-51" id="h1-0-51" class="d">-	struct tm *intm;
</a><a href="#h1-0-52" id="h1-0-52" class="d">-	time_t t;
</a><a href="#h1-0-53" id="h1-0-53" class="d">-	char out[32];
</a><a href="#h1-0-54" id="h1-0-54" class="d">-
</a><a href="#h1-0-55" id="h1-0-55" class="d">-	t = (time_t)intime-&gt;time;
</a><a href="#h1-0-56" id="h1-0-56" class="d">-	if (!(intm = gmtime(&amp;t)))
</a><a href="#h1-0-57" id="h1-0-57" class="d">-		return;
</a><a href="#h1-0-58" id="h1-0-58" class="d">-	strftime(out, sizeof(out), &quot;%Y-%m-%d %H:%M&quot;, intm);
</a><a href="#h1-0-59" id="h1-0-59" class="d">-	fputs(out, fp);
</a><a href="#h1-0-60" id="h1-0-60" class="i">+  struct tm *intm;
</a><a href="#h1-0-61" id="h1-0-61" class="i">+  time_t t;
</a><a href="#h1-0-62" id="h1-0-62" class="i">+  char out[32];
</a><a href="#h1-0-63" id="h1-0-63" class="i">+
</a><a href="#h1-0-64" id="h1-0-64" class="i">+  t = (time_t)intime-&gt;time;
</a><a href="#h1-0-65" id="h1-0-65" class="i">+  if (!(intm = gmtime(&amp;t)))
</a><a href="#h1-0-66" id="h1-0-66" class="i">+    return;
</a><a href="#h1-0-67" id="h1-0-67" class="i">+  strftime(out, sizeof(out), &quot;%Y-%m-%d %H:%M&quot;, intm);
</a><a href="#h1-0-68" id="h1-0-68" class="i">+  fputs(out, fp);
</a> }
 
 void
 writeheader(FILE *fp)
 {
<a href="#h1-0-74" id="h1-0-74" class="d">-	fputs(&quot;&lt;!DOCTYPE html&gt;\n&quot;
</a><a href="#h1-0-75" id="h1-0-75" class="d">-		&quot;&lt;html&gt;\n&lt;head&gt;\n&quot;
</a><a href="#h1-0-76" id="h1-0-76" class="i">+  fputs(&quot;&lt;!DOCTYPE html&gt;\n&quot;
</a><a href="#h1-0-77" id="h1-0-77" class="i">+    &quot;&lt;html&gt;\n&lt;head&gt;\n&quot;
</a>     &quot;&lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1\&quot;&gt;\n&quot;
<a href="#h1-0-79" id="h1-0-79" class="d">-		&quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=UTF-8\&quot; /&gt;\n&quot;
</a><a href="#h1-0-80" id="h1-0-80" class="d">-		&quot;&lt;title&gt;&quot;, fp);
</a><a href="#h1-0-81" id="h1-0-81" class="d">-	xmlencode(fp, description, strlen(description));
</a><a href="#h1-0-82" id="h1-0-82" class="d">-	fprintf(fp, &quot;&lt;/title&gt;\n&lt;link rel=\&quot;icon\&quot; type=\&quot;image/png\&quot; href=\&quot;/favicon.png\&quot; /&gt;\n&quot;);
</a><a href="#h1-0-83" id="h1-0-83" class="d">-	fprintf(fp, &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;/style.css\&quot; /&gt;\n&quot;);
</a><a href="#h1-0-84" id="h1-0-84" class="d">-	fputs(&quot;&lt;/head&gt;\n&lt;body&gt;\n&quot;, fp);
</a><a href="#h1-0-85" id="h1-0-85" class="d">-	fprintf(fp, &quot;&lt;table&gt;\n&lt;tr&gt;&lt;td&gt;&lt;a href=\&quot;https://ybbond.dev\&quot;&gt;&quot;
</a><a href="#h1-0-86" id="h1-0-86" class="d">-					&quot;&lt;img src=\&quot;/ybbond.png\&quot; alt=\&quot;\&quot; width=\&quot;32\&quot; height=\&quot;32\&quot; /&gt;&lt;/a&gt;&lt;/td&gt;\n&quot;
</a><a href="#h1-0-87" id="h1-0-87" class="d">-	        &quot;&lt;td&gt;&lt;span class=\&quot;desc\&quot;&gt;&quot;);
</a><a href="#h1-0-88" id="h1-0-88" class="d">-	xmlencode(fp, description, strlen(description));
</a><a href="#h1-0-89" id="h1-0-89" class="d">-	fputs(&quot;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;\n&quot;
</a><a href="#h1-0-90" id="h1-0-90" class="d">-		&quot;&lt;/td&gt;&lt;/tr&gt;\n&lt;/table&gt;\n&lt;hr/&gt;\n&lt;div id=\&quot;content\&quot;&gt;\n&quot;
</a><a href="#h1-0-91" id="h1-0-91" class="d">-		&quot;&lt;div id=\&quot;table-scroll\&quot;&gt;&lt;table id=\&quot;index\&quot;&gt;&lt;thead&gt;\n&quot;
</a><a href="#h1-0-92" id="h1-0-92" class="d">-		&quot;&lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;&quot;
</a><a href="#h1-0-93" id="h1-0-93" class="d">-		&quot;&lt;th&gt;Last commit&lt;/th&gt;&lt;/tr&gt;&quot;
</a><a href="#h1-0-94" id="h1-0-94" class="d">-		&quot;&lt;/thead&gt;&lt;tbody&gt;\n&quot;, fp);
</a><a href="#h1-0-95" id="h1-0-95" class="i">+    &quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=UTF-8\&quot; /&gt;\n&quot;
</a><a href="#h1-0-96" id="h1-0-96" class="i">+    &quot;&lt;title&gt;&quot;, fp);
</a><a href="#h1-0-97" id="h1-0-97" class="i">+  xmlencode(fp, description, strlen(description));
</a><a href="#h1-0-98" id="h1-0-98" class="i">+  fprintf(fp, &quot;&lt;/title&gt;\n&lt;link rel=\&quot;icon\&quot; type=\&quot;image/png\&quot; href=\&quot;/favicon.png\&quot; /&gt;\n&quot;);
</a><a href="#h1-0-99" id="h1-0-99" class="i">+  fprintf(fp, &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;/style.css\&quot; /&gt;\n&quot;);
</a><a href="#h1-0-100" id="h1-0-100" class="i">+  fputs(&quot;&lt;/head&gt;\n&lt;body&gt;\n&quot;, fp);
</a><a href="#h1-0-101" id="h1-0-101" class="i">+  fprintf(fp, &quot;&lt;table&gt;\n&lt;tr&gt;&lt;td&gt;&lt;a href=\&quot;https://ybbond.dev\&quot;&gt;&quot;
</a><a href="#h1-0-102" id="h1-0-102" class="i">+          &quot;&lt;img src=\&quot;/ybbond.png\&quot; alt=\&quot;\&quot; width=\&quot;32\&quot; height=\&quot;32\&quot; /&gt;&lt;/a&gt;&lt;/td&gt;\n&quot;
</a><a href="#h1-0-103" id="h1-0-103" class="i">+          &quot;&lt;td&gt;&lt;span class=\&quot;desc\&quot;&gt;&quot;);
</a><a href="#h1-0-104" id="h1-0-104" class="i">+  xmlencode(fp, description, strlen(description));
</a><a href="#h1-0-105" id="h1-0-105" class="i">+  fputs(&quot;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;\n&quot;
</a><a href="#h1-0-106" id="h1-0-106" class="i">+    &quot;&lt;/td&gt;&lt;/tr&gt;\n&lt;/table&gt;\n&lt;hr/&gt;\n&lt;div id=\&quot;content\&quot;&gt;\n&quot;
</a><a href="#h1-0-107" id="h1-0-107" class="i">+    &quot;&lt;div id=\&quot;table-scroll\&quot;&gt;&lt;table id=\&quot;index\&quot;&gt;&lt;thead&gt;\n&quot;
</a><a href="#h1-0-108" id="h1-0-108" class="i">+    &quot;&lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Description&lt;/th&gt;&quot;
</a><a href="#h1-0-109" id="h1-0-109" class="i">+    &quot;&lt;th&gt;Last commit&lt;/th&gt;&lt;/tr&gt;&quot;
</a><a href="#h1-0-110" id="h1-0-110" class="i">+    &quot;&lt;/thead&gt;&lt;tbody&gt;\n&quot;, fp);
</a> }
 
 void
 writefooter(FILE *fp)
 {
<a href="#h1-0-116" id="h1-0-116" class="d">-	fputs(&quot;&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&quot;, fp);
</a><a href="#h1-0-117" id="h1-0-117" class="i">+  fputs(&quot;&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&quot;, fp);
</a> }
 
 int
 writelog(FILE *fp)
 {
<a href="#h1-0-123" id="h1-0-123" class="d">-	git_commit *commit = NULL;
</a><a href="#h1-0-124" id="h1-0-124" class="d">-	const git_signature *author;
</a><a href="#h1-0-125" id="h1-0-125" class="d">-	git_revwalk *w = NULL;
</a><a href="#h1-0-126" id="h1-0-126" class="d">-	git_oid id;
</a><a href="#h1-0-127" id="h1-0-127" class="d">-	char *stripped_name = NULL, *p;
</a><a href="#h1-0-128" id="h1-0-128" class="d">-	int ret = 0;
</a><a href="#h1-0-129" id="h1-0-129" class="d">-
</a><a href="#h1-0-130" id="h1-0-130" class="d">-	git_revwalk_new(&amp;w, repo);
</a><a href="#h1-0-131" id="h1-0-131" class="d">-	git_revwalk_push_head(w);
</a><a href="#h1-0-132" id="h1-0-132" class="d">-	git_revwalk_simplify_first_parent(w);
</a><a href="#h1-0-133" id="h1-0-133" class="d">-
</a><a href="#h1-0-134" id="h1-0-134" class="d">-	if (git_revwalk_next(&amp;id, w) ||
</a><a href="#h1-0-135" id="h1-0-135" class="d">-	    git_commit_lookup(&amp;commit, repo, &amp;id)) {
</a><a href="#h1-0-136" id="h1-0-136" class="d">-		ret = -1;
</a><a href="#h1-0-137" id="h1-0-137" class="d">-		goto err;
</a><a href="#h1-0-138" id="h1-0-138" class="d">-	}
</a><a href="#h1-0-139" id="h1-0-139" class="d">-
</a><a href="#h1-0-140" id="h1-0-140" class="d">-	author = git_commit_author(commit);
</a><a href="#h1-0-141" id="h1-0-141" class="d">-
</a><a href="#h1-0-142" id="h1-0-142" class="d">-	/* strip .git suffix */
</a><a href="#h1-0-143" id="h1-0-143" class="d">-	if (!(stripped_name = strdup(name)))
</a><a href="#h1-0-144" id="h1-0-144" class="d">-		err(1, &quot;strdup&quot;);
</a><a href="#h1-0-145" id="h1-0-145" class="d">-	if ((p = strrchr(stripped_name, &#39;.&#39;)))
</a><a href="#h1-0-146" id="h1-0-146" class="d">-		if (!strcmp(p, &quot;.git&quot;))
</a><a href="#h1-0-147" id="h1-0-147" class="d">-			*p = &#39;\0&#39;;
</a><a href="#h1-0-148" id="h1-0-148" class="d">-
</a><a href="#h1-0-149" id="h1-0-149" class="d">-	fputs(&quot;&lt;tr&gt;&lt;td&gt;&lt;a href=\&quot;&quot;, fp);
</a><a href="#h1-0-150" id="h1-0-150" class="d">-	xmlencode(fp, stripped_name, strlen(stripped_name));
</a><a href="#h1-0-151" id="h1-0-151" class="d">-	fputs(&quot;/index.html\&quot;&gt;&quot;, fp);
</a><a href="#h1-0-152" id="h1-0-152" class="d">-	xmlencode(fp, stripped_name, strlen(stripped_name));
</a><a href="#h1-0-153" id="h1-0-153" class="d">-	fputs(&quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h1-0-154" id="h1-0-154" class="d">-	xmlencode(fp, description, strlen(description));
</a><a href="#h1-0-155" id="h1-0-155" class="d">-	fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h1-0-156" id="h1-0-156" class="d">-	if (author)
</a><a href="#h1-0-157" id="h1-0-157" class="d">-		printtimeshort(fp, &amp;(author-&gt;when));
</a><a href="#h1-0-158" id="h1-0-158" class="d">-	fputs(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;, fp);
</a><a href="#h1-0-159" id="h1-0-159" class="d">-
</a><a href="#h1-0-160" id="h1-0-160" class="d">-	git_commit_free(commit);
</a><a href="#h1-0-161" id="h1-0-161" class="i">+  git_commit *commit = NULL;
</a><a href="#h1-0-162" id="h1-0-162" class="i">+  const git_signature *author;
</a><a href="#h1-0-163" id="h1-0-163" class="i">+  git_revwalk *w = NULL;
</a><a href="#h1-0-164" id="h1-0-164" class="i">+  git_oid id;
</a><a href="#h1-0-165" id="h1-0-165" class="i">+  char *stripped_name = NULL, *p;
</a><a href="#h1-0-166" id="h1-0-166" class="i">+  int ret = 0;
</a><a href="#h1-0-167" id="h1-0-167" class="i">+
</a><a href="#h1-0-168" id="h1-0-168" class="i">+  git_revwalk_new(&amp;w, repo);
</a><a href="#h1-0-169" id="h1-0-169" class="i">+  git_revwalk_push_head(w);
</a><a href="#h1-0-170" id="h1-0-170" class="i">+  git_revwalk_simplify_first_parent(w);
</a><a href="#h1-0-171" id="h1-0-171" class="i">+
</a><a href="#h1-0-172" id="h1-0-172" class="i">+  if (git_revwalk_next(&amp;id, w) ||
</a><a href="#h1-0-173" id="h1-0-173" class="i">+      git_commit_lookup(&amp;commit, repo, &amp;id)) {
</a><a href="#h1-0-174" id="h1-0-174" class="i">+    ret = -1;
</a><a href="#h1-0-175" id="h1-0-175" class="i">+    goto err;
</a><a href="#h1-0-176" id="h1-0-176" class="i">+  }
</a><a href="#h1-0-177" id="h1-0-177" class="i">+
</a><a href="#h1-0-178" id="h1-0-178" class="i">+  author = git_commit_author(commit);
</a><a href="#h1-0-179" id="h1-0-179" class="i">+
</a><a href="#h1-0-180" id="h1-0-180" class="i">+  /* strip .git suffix */
</a><a href="#h1-0-181" id="h1-0-181" class="i">+  if (!(stripped_name = strdup(name)))
</a><a href="#h1-0-182" id="h1-0-182" class="i">+    err(1, &quot;strdup&quot;);
</a><a href="#h1-0-183" id="h1-0-183" class="i">+  if ((p = strrchr(stripped_name, &#39;.&#39;)))
</a><a href="#h1-0-184" id="h1-0-184" class="i">+    if (!strcmp(p, &quot;.git&quot;))
</a><a href="#h1-0-185" id="h1-0-185" class="i">+      *p = &#39;\0&#39;;
</a><a href="#h1-0-186" id="h1-0-186" class="i">+
</a><a href="#h1-0-187" id="h1-0-187" class="i">+  fputs(&quot;&lt;tr&gt;&lt;td&gt;&lt;a href=\&quot;&quot;, fp);
</a><a href="#h1-0-188" id="h1-0-188" class="i">+  xmlencode(fp, stripped_name, strlen(stripped_name));
</a><a href="#h1-0-189" id="h1-0-189" class="i">+  fputs(&quot;/index.html\&quot;&gt;&quot;, fp);
</a><a href="#h1-0-190" id="h1-0-190" class="i">+  xmlencode(fp, stripped_name, strlen(stripped_name));
</a><a href="#h1-0-191" id="h1-0-191" class="i">+  fputs(&quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h1-0-192" id="h1-0-192" class="i">+  xmlencode(fp, description, strlen(description));
</a><a href="#h1-0-193" id="h1-0-193" class="i">+  fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h1-0-194" id="h1-0-194" class="i">+  if (author)
</a><a href="#h1-0-195" id="h1-0-195" class="i">+    printtimeshort(fp, &amp;(author-&gt;when));
</a><a href="#h1-0-196" id="h1-0-196" class="i">+  fputs(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;, fp);
</a><a href="#h1-0-197" id="h1-0-197" class="i">+
</a><a href="#h1-0-198" id="h1-0-198" class="i">+  git_commit_free(commit);
</a> err:
<a href="#h1-0-200" id="h1-0-200" class="d">-	git_revwalk_free(w);
</a><a href="#h1-0-201" id="h1-0-201" class="d">-	free(stripped_name);
</a><a href="#h1-0-202" id="h1-0-202" class="i">+  git_revwalk_free(w);
</a><a href="#h1-0-203" id="h1-0-203" class="i">+  free(stripped_name);
</a> 
<a href="#h1-0-205" id="h1-0-205" class="d">-	return ret;
</a><a href="#h1-0-206" id="h1-0-206" class="i">+  return ret;
</a> }
 
 int
 main(int argc, char *argv[])
 {
<a href="#h1-0-212" id="h1-0-212" class="d">-	FILE *fp;
</a><a href="#h1-0-213" id="h1-0-213" class="d">-	char path[PATH_MAX], repodirabs[PATH_MAX + 1];
</a><a href="#h1-0-214" id="h1-0-214" class="d">-	const char *repodir;
</a><a href="#h1-0-215" id="h1-0-215" class="d">-	int i, ret = 0;
</a><a href="#h1-0-216" id="h1-0-216" class="i">+  FILE *fp;
</a><a href="#h1-0-217" id="h1-0-217" class="i">+  char path[PATH_MAX], repodirabs[PATH_MAX + 1];
</a><a href="#h1-0-218" id="h1-0-218" class="i">+  const char *repodir;
</a><a href="#h1-0-219" id="h1-0-219" class="i">+  int i, ret = 0;
</a> 
<a href="#h1-0-221" id="h1-0-221" class="d">-	if (argc &lt; 2) {
</a><a href="#h1-0-222" id="h1-0-222" class="d">-		fprintf(stderr, &quot;%s [repodir...]\n&quot;, argv[0]);
</a><a href="#h1-0-223" id="h1-0-223" class="d">-		return 1;
</a><a href="#h1-0-224" id="h1-0-224" class="d">-	}
</a><a href="#h1-0-225" id="h1-0-225" class="i">+  if (argc &lt; 2) {
</a><a href="#h1-0-226" id="h1-0-226" class="i">+    fprintf(stderr, &quot;%s [repodir...]\n&quot;, argv[0]);
</a><a href="#h1-0-227" id="h1-0-227" class="i">+    return 1;
</a><a href="#h1-0-228" id="h1-0-228" class="i">+  }
</a> 
<a href="#h1-0-230" id="h1-0-230" class="d">-	git_libgit2_init();
</a><a href="#h1-0-231" id="h1-0-231" class="i">+  git_libgit2_init();
</a> 
 #ifdef __OpenBSD__
<a href="#h1-0-234" id="h1-0-234" class="d">-	for (i = 1; i &lt; argc; i++)
</a><a href="#h1-0-235" id="h1-0-235" class="d">-		if (unveil(argv[i], &quot;r&quot;) == -1)
</a><a href="#h1-0-236" id="h1-0-236" class="d">-			err(1, &quot;unveil: %s&quot;, argv[i]);
</a><a href="#h1-0-237" id="h1-0-237" class="i">+  for (i = 1; i &lt; argc; i++)
</a><a href="#h1-0-238" id="h1-0-238" class="i">+    if (unveil(argv[i], &quot;r&quot;) == -1)
</a><a href="#h1-0-239" id="h1-0-239" class="i">+      err(1, &quot;unveil: %s&quot;, argv[i]);
</a> 
<a href="#h1-0-241" id="h1-0-241" class="d">-	if (pledge(&quot;stdio rpath&quot;, NULL) == -1)
</a><a href="#h1-0-242" id="h1-0-242" class="d">-		err(1, &quot;pledge&quot;);
</a><a href="#h1-0-243" id="h1-0-243" class="i">+  if (pledge(&quot;stdio rpath&quot;, NULL) == -1)
</a><a href="#h1-0-244" id="h1-0-244" class="i">+    err(1, &quot;pledge&quot;);
</a> #endif
 
<a href="#h1-0-247" id="h1-0-247" class="d">-	writeheader(stdout);
</a><a href="#h1-0-248" id="h1-0-248" class="d">-
</a><a href="#h1-0-249" id="h1-0-249" class="d">-	for (i = 1; i &lt; argc; i++) {
</a><a href="#h1-0-250" id="h1-0-250" class="d">-		repodir = argv[i];
</a><a href="#h1-0-251" id="h1-0-251" class="d">-		if (!realpath(repodir, repodirabs))
</a><a href="#h1-0-252" id="h1-0-252" class="d">-			err(1, &quot;realpath&quot;);
</a><a href="#h1-0-253" id="h1-0-253" class="d">-
</a><a href="#h1-0-254" id="h1-0-254" class="d">-		if (git_repository_open_ext(&amp;repo, repodir,
</a><a href="#h1-0-255" id="h1-0-255" class="d">-		    GIT_REPOSITORY_OPEN_NO_SEARCH, NULL)) {
</a><a href="#h1-0-256" id="h1-0-256" class="d">-			fprintf(stderr, &quot;%s: cannot open repository\n&quot;, argv[0]);
</a><a href="#h1-0-257" id="h1-0-257" class="d">-			ret = 1;
</a><a href="#h1-0-258" id="h1-0-258" class="d">-			continue;
</a><a href="#h1-0-259" id="h1-0-259" class="d">-		}
</a><a href="#h1-0-260" id="h1-0-260" class="d">-
</a><a href="#h1-0-261" id="h1-0-261" class="d">-		/* use directory name as name */
</a><a href="#h1-0-262" id="h1-0-262" class="d">-		if ((name = strrchr(repodirabs, &#39;/&#39;)))
</a><a href="#h1-0-263" id="h1-0-263" class="d">-			name++;
</a><a href="#h1-0-264" id="h1-0-264" class="d">-		else
</a><a href="#h1-0-265" id="h1-0-265" class="d">-			name = &quot;&quot;;
</a><a href="#h1-0-266" id="h1-0-266" class="d">-
</a><a href="#h1-0-267" id="h1-0-267" class="d">-		/* read description or .git/description */
</a><a href="#h1-0-268" id="h1-0-268" class="d">-		joinpath(path, sizeof(path), repodir, &quot;description&quot;);
</a><a href="#h1-0-269" id="h1-0-269" class="d">-		if (!(fp = fopen(path, &quot;r&quot;))) {
</a><a href="#h1-0-270" id="h1-0-270" class="d">-			joinpath(path, sizeof(path), repodir, &quot;.git/description&quot;);
</a><a href="#h1-0-271" id="h1-0-271" class="d">-			fp = fopen(path, &quot;r&quot;);
</a><a href="#h1-0-272" id="h1-0-272" class="d">-		}
</a><a href="#h1-0-273" id="h1-0-273" class="d">-		description[0] = &#39;\0&#39;;
</a><a href="#h1-0-274" id="h1-0-274" class="d">-		if (fp) {
</a><a href="#h1-0-275" id="h1-0-275" class="d">-			if (!fgets(description, sizeof(description), fp))
</a><a href="#h1-0-276" id="h1-0-276" class="d">-				description[0] = &#39;\0&#39;;
</a><a href="#h1-0-277" id="h1-0-277" class="d">-			fclose(fp);
</a><a href="#h1-0-278" id="h1-0-278" class="d">-		}
</a><a href="#h1-0-279" id="h1-0-279" class="d">-
</a><a href="#h1-0-280" id="h1-0-280" class="d">-		writelog(stdout);
</a><a href="#h1-0-281" id="h1-0-281" class="d">-	}
</a><a href="#h1-0-282" id="h1-0-282" class="d">-	writefooter(stdout);
</a><a href="#h1-0-283" id="h1-0-283" class="d">-
</a><a href="#h1-0-284" id="h1-0-284" class="d">-	/* cleanup */
</a><a href="#h1-0-285" id="h1-0-285" class="d">-	git_repository_free(repo);
</a><a href="#h1-0-286" id="h1-0-286" class="d">-	git_libgit2_shutdown();
</a><a href="#h1-0-287" id="h1-0-287" class="d">-
</a><a href="#h1-0-288" id="h1-0-288" class="d">-	return ret;
</a><a href="#h1-0-289" id="h1-0-289" class="i">+  writeheader(stdout);
</a><a href="#h1-0-290" id="h1-0-290" class="i">+
</a><a href="#h1-0-291" id="h1-0-291" class="i">+  for (i = 1; i &lt; argc; i++) {
</a><a href="#h1-0-292" id="h1-0-292" class="i">+    repodir = argv[i];
</a><a href="#h1-0-293" id="h1-0-293" class="i">+    if (!realpath(repodir, repodirabs))
</a><a href="#h1-0-294" id="h1-0-294" class="i">+      err(1, &quot;realpath&quot;);
</a><a href="#h1-0-295" id="h1-0-295" class="i">+
</a><a href="#h1-0-296" id="h1-0-296" class="i">+    if (git_repository_open_ext(&amp;repo, repodir,
</a><a href="#h1-0-297" id="h1-0-297" class="i">+        GIT_REPOSITORY_OPEN_NO_SEARCH, NULL)) {
</a><a href="#h1-0-298" id="h1-0-298" class="i">+      fprintf(stderr, &quot;%s: cannot open repository\n&quot;, argv[0]);
</a><a href="#h1-0-299" id="h1-0-299" class="i">+      ret = 1;
</a><a href="#h1-0-300" id="h1-0-300" class="i">+      continue;
</a><a href="#h1-0-301" id="h1-0-301" class="i">+    }
</a><a href="#h1-0-302" id="h1-0-302" class="i">+
</a><a href="#h1-0-303" id="h1-0-303" class="i">+    /* use directory name as name */
</a><a href="#h1-0-304" id="h1-0-304" class="i">+    if ((name = strrchr(repodirabs, &#39;/&#39;)))
</a><a href="#h1-0-305" id="h1-0-305" class="i">+      name++;
</a><a href="#h1-0-306" id="h1-0-306" class="i">+    else
</a><a href="#h1-0-307" id="h1-0-307" class="i">+      name = &quot;&quot;;
</a><a href="#h1-0-308" id="h1-0-308" class="i">+
</a><a href="#h1-0-309" id="h1-0-309" class="i">+    /* read description or .git/description */
</a><a href="#h1-0-310" id="h1-0-310" class="i">+    joinpath(path, sizeof(path), repodir, &quot;description&quot;);
</a><a href="#h1-0-311" id="h1-0-311" class="i">+    if (!(fp = fopen(path, &quot;r&quot;))) {
</a><a href="#h1-0-312" id="h1-0-312" class="i">+      joinpath(path, sizeof(path), repodir, &quot;.git/description&quot;);
</a><a href="#h1-0-313" id="h1-0-313" class="i">+      fp = fopen(path, &quot;r&quot;);
</a><a href="#h1-0-314" id="h1-0-314" class="i">+    }
</a><a href="#h1-0-315" id="h1-0-315" class="i">+    description[0] = &#39;\0&#39;;
</a><a href="#h1-0-316" id="h1-0-316" class="i">+    if (fp) {
</a><a href="#h1-0-317" id="h1-0-317" class="i">+      if (!fgets(description, sizeof(description), fp))
</a><a href="#h1-0-318" id="h1-0-318" class="i">+        description[0] = &#39;\0&#39;;
</a><a href="#h1-0-319" id="h1-0-319" class="i">+      fclose(fp);
</a><a href="#h1-0-320" id="h1-0-320" class="i">+    }
</a><a href="#h1-0-321" id="h1-0-321" class="i">+
</a><a href="#h1-0-322" id="h1-0-322" class="i">+    writelog(stdout);
</a><a href="#h1-0-323" id="h1-0-323" class="i">+  }
</a><a href="#h1-0-324" id="h1-0-324" class="i">+  writefooter(stdout);
</a><a href="#h1-0-325" id="h1-0-325" class="i">+
</a><a href="#h1-0-326" id="h1-0-326" class="i">+  /* cleanup */
</a><a href="#h1-0-327" id="h1-0-327" class="i">+  git_repository_free(repo);
</a><a href="#h1-0-328" id="h1-0-328" class="i">+  git_libgit2_shutdown();
</a><a href="#h1-0-329" id="h1-0-329" class="i">+
</a><a href="#h1-0-330" id="h1-0-330" class="i">+  return ret;
</a> }
<b>diff --git a/<a id="h2" href="../file/stagit.c.html">stagit.c</a> b/<a href="../file/stagit.c.html">stagit.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -17,35 +17,35 @@
</a> #include &quot;compat.h&quot;
 
 struct deltainfo {
<a href="#h2-0-3" id="h2-0-3" class="d">-	git_patch *patch;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+  git_patch *patch;
</a> 
<a href="#h2-0-6" id="h2-0-6" class="d">-	size_t addcount;
</a><a href="#h2-0-7" id="h2-0-7" class="d">-	size_t delcount;
</a><a href="#h2-0-8" id="h2-0-8" class="i">+  size_t addcount;
</a><a href="#h2-0-9" id="h2-0-9" class="i">+  size_t delcount;
</a> };
 
 struct commitinfo {
<a href="#h2-0-13" id="h2-0-13" class="d">-	const git_oid *id;
</a><a href="#h2-0-14" id="h2-0-14" class="i">+  const git_oid *id;
</a> 
<a href="#h2-0-16" id="h2-0-16" class="d">-	char oid[GIT_OID_HEXSZ + 1];
</a><a href="#h2-0-17" id="h2-0-17" class="d">-	char parentoid[GIT_OID_HEXSZ + 1];
</a><a href="#h2-0-18" id="h2-0-18" class="i">+  char oid[GIT_OID_HEXSZ + 1];
</a><a href="#h2-0-19" id="h2-0-19" class="i">+  char parentoid[GIT_OID_HEXSZ + 1];
</a> 
<a href="#h2-0-21" id="h2-0-21" class="d">-	const git_signature *author;
</a><a href="#h2-0-22" id="h2-0-22" class="d">-	const git_signature *committer;
</a><a href="#h2-0-23" id="h2-0-23" class="d">-	const char          *summary;
</a><a href="#h2-0-24" id="h2-0-24" class="d">-	const char          *msg;
</a><a href="#h2-0-25" id="h2-0-25" class="i">+  const git_signature *author;
</a><a href="#h2-0-26" id="h2-0-26" class="i">+  const git_signature *committer;
</a><a href="#h2-0-27" id="h2-0-27" class="i">+  const char          *summary;
</a><a href="#h2-0-28" id="h2-0-28" class="i">+  const char          *msg;
</a> 
<a href="#h2-0-30" id="h2-0-30" class="d">-	git_diff   *diff;
</a><a href="#h2-0-31" id="h2-0-31" class="d">-	git_commit *commit;
</a><a href="#h2-0-32" id="h2-0-32" class="d">-	git_commit *parent;
</a><a href="#h2-0-33" id="h2-0-33" class="d">-	git_tree   *commit_tree;
</a><a href="#h2-0-34" id="h2-0-34" class="d">-	git_tree   *parent_tree;
</a><a href="#h2-0-35" id="h2-0-35" class="i">+  git_diff   *diff;
</a><a href="#h2-0-36" id="h2-0-36" class="i">+  git_commit *commit;
</a><a href="#h2-0-37" id="h2-0-37" class="i">+  git_commit *parent;
</a><a href="#h2-0-38" id="h2-0-38" class="i">+  git_tree   *commit_tree;
</a><a href="#h2-0-39" id="h2-0-39" class="i">+  git_tree   *parent_tree;
</a> 
<a href="#h2-0-41" id="h2-0-41" class="d">-	size_t addcount;
</a><a href="#h2-0-42" id="h2-0-42" class="d">-	size_t delcount;
</a><a href="#h2-0-43" id="h2-0-43" class="d">-	size_t filecount;
</a><a href="#h2-0-44" id="h2-0-44" class="i">+  size_t addcount;
</a><a href="#h2-0-45" id="h2-0-45" class="i">+  size_t delcount;
</a><a href="#h2-0-46" id="h2-0-46" class="i">+  size_t filecount;
</a> 
<a href="#h2-0-48" id="h2-0-48" class="d">-	struct deltainfo **deltas;
</a><a href="#h2-0-49" id="h2-0-49" class="d">-	size_t ndeltas;
</a><a href="#h2-0-50" id="h2-0-50" class="i">+  struct deltainfo **deltas;
</a><a href="#h2-0-51" id="h2-0-51" class="i">+  size_t ndeltas;
</a> };
 
 static git_repository *repo;
<a href="#h2-1" id="h2-1" class="h">@@ -73,1206 +73,1206 @@ static const char *cachefile;
</a> void
 joinpath(char *buf, size_t bufsiz, const char *path, const char *path2)
 {
<a href="#h2-1-3" id="h2-1-3" class="d">-	int r;
</a><a href="#h2-1-4" id="h2-1-4" class="i">+  int r;
</a> 
<a href="#h2-1-6" id="h2-1-6" class="d">-	r = snprintf(buf, bufsiz, &quot;%s%s%s&quot;,
</a><a href="#h2-1-7" id="h2-1-7" class="d">-		path, path[0] &amp;&amp; path[strlen(path) - 1] != &#39;/&#39; ? &quot;/&quot; : &quot;&quot;, path2);
</a><a href="#h2-1-8" id="h2-1-8" class="d">-	if (r &lt; 0 || (size_t)r &gt;= bufsiz)
</a><a href="#h2-1-9" id="h2-1-9" class="d">-		errx(1, &quot;path truncated: &#39;%s%s%s&#39;&quot;,
</a><a href="#h2-1-10" id="h2-1-10" class="d">-			path, path[0] &amp;&amp; path[strlen(path) - 1] != &#39;/&#39; ? &quot;/&quot; : &quot;&quot;, path2);
</a><a href="#h2-1-11" id="h2-1-11" class="i">+  r = snprintf(buf, bufsiz, &quot;%s%s%s&quot;,
</a><a href="#h2-1-12" id="h2-1-12" class="i">+    path, path[0] &amp;&amp; path[strlen(path) - 1] != &#39;/&#39; ? &quot;/&quot; : &quot;&quot;, path2);
</a><a href="#h2-1-13" id="h2-1-13" class="i">+  if (r &lt; 0 || (size_t)r &gt;= bufsiz)
</a><a href="#h2-1-14" id="h2-1-14" class="i">+    errx(1, &quot;path truncated: &#39;%s%s%s&#39;&quot;,
</a><a href="#h2-1-15" id="h2-1-15" class="i">+      path, path[0] &amp;&amp; path[strlen(path) - 1] != &#39;/&#39; ? &quot;/&quot; : &quot;&quot;, path2);
</a> }
 
 void
 deltainfo_free(struct deltainfo *di)
 {
<a href="#h2-1-21" id="h2-1-21" class="d">-	if (!di)
</a><a href="#h2-1-22" id="h2-1-22" class="d">-		return;
</a><a href="#h2-1-23" id="h2-1-23" class="d">-	git_patch_free(di-&gt;patch);
</a><a href="#h2-1-24" id="h2-1-24" class="d">-	memset(di, 0, sizeof(*di));
</a><a href="#h2-1-25" id="h2-1-25" class="d">-	free(di);
</a><a href="#h2-1-26" id="h2-1-26" class="i">+  if (!di)
</a><a href="#h2-1-27" id="h2-1-27" class="i">+    return;
</a><a href="#h2-1-28" id="h2-1-28" class="i">+  git_patch_free(di-&gt;patch);
</a><a href="#h2-1-29" id="h2-1-29" class="i">+  memset(di, 0, sizeof(*di));
</a><a href="#h2-1-30" id="h2-1-30" class="i">+  free(di);
</a> }
 
 int
 commitinfo_getstats(struct commitinfo *ci)
 {
<a href="#h2-1-36" id="h2-1-36" class="d">-	struct deltainfo *di;
</a><a href="#h2-1-37" id="h2-1-37" class="d">-	git_diff_options opts;
</a><a href="#h2-1-38" id="h2-1-38" class="d">-	git_diff_find_options fopts;
</a><a href="#h2-1-39" id="h2-1-39" class="d">-	const git_diff_delta *delta;
</a><a href="#h2-1-40" id="h2-1-40" class="d">-	const git_diff_hunk *hunk;
</a><a href="#h2-1-41" id="h2-1-41" class="d">-	const git_diff_line *line;
</a><a href="#h2-1-42" id="h2-1-42" class="d">-	git_patch *patch = NULL;
</a><a href="#h2-1-43" id="h2-1-43" class="d">-	size_t ndeltas, nhunks, nhunklines;
</a><a href="#h2-1-44" id="h2-1-44" class="d">-	size_t i, j, k;
</a><a href="#h2-1-45" id="h2-1-45" class="d">-
</a><a href="#h2-1-46" id="h2-1-46" class="d">-	if (git_tree_lookup(&amp;(ci-&gt;commit_tree), repo, git_commit_tree_id(ci-&gt;commit)))
</a><a href="#h2-1-47" id="h2-1-47" class="d">-		goto err;
</a><a href="#h2-1-48" id="h2-1-48" class="d">-	if (!git_commit_parent(&amp;(ci-&gt;parent), ci-&gt;commit, 0)) {
</a><a href="#h2-1-49" id="h2-1-49" class="d">-		if (git_tree_lookup(&amp;(ci-&gt;parent_tree), repo, git_commit_tree_id(ci-&gt;parent))) {
</a><a href="#h2-1-50" id="h2-1-50" class="d">-			ci-&gt;parent = NULL;
</a><a href="#h2-1-51" id="h2-1-51" class="d">-			ci-&gt;parent_tree = NULL;
</a><a href="#h2-1-52" id="h2-1-52" class="d">-		}
</a><a href="#h2-1-53" id="h2-1-53" class="d">-	}
</a><a href="#h2-1-54" id="h2-1-54" class="d">-
</a><a href="#h2-1-55" id="h2-1-55" class="d">-	git_diff_init_options(&amp;opts, GIT_DIFF_OPTIONS_VERSION);
</a><a href="#h2-1-56" id="h2-1-56" class="d">-	opts.flags |= GIT_DIFF_DISABLE_PATHSPEC_MATCH |
</a><a href="#h2-1-57" id="h2-1-57" class="d">-	              GIT_DIFF_IGNORE_SUBMODULES |
</a><a href="#h2-1-58" id="h2-1-58" class="d">-		      GIT_DIFF_INCLUDE_TYPECHANGE;
</a><a href="#h2-1-59" id="h2-1-59" class="d">-	if (git_diff_tree_to_tree(&amp;(ci-&gt;diff), repo, ci-&gt;parent_tree, ci-&gt;commit_tree, &amp;opts))
</a><a href="#h2-1-60" id="h2-1-60" class="d">-		goto err;
</a><a href="#h2-1-61" id="h2-1-61" class="d">-
</a><a href="#h2-1-62" id="h2-1-62" class="d">-	if (git_diff_find_init_options(&amp;fopts, GIT_DIFF_FIND_OPTIONS_VERSION))
</a><a href="#h2-1-63" id="h2-1-63" class="d">-		goto err;
</a><a href="#h2-1-64" id="h2-1-64" class="d">-	/* find renames and copies, exact matches (no heuristic) for renames. */
</a><a href="#h2-1-65" id="h2-1-65" class="d">-	fopts.flags |= GIT_DIFF_FIND_RENAMES | GIT_DIFF_FIND_COPIES |
</a><a href="#h2-1-66" id="h2-1-66" class="d">-	               GIT_DIFF_FIND_EXACT_MATCH_ONLY;
</a><a href="#h2-1-67" id="h2-1-67" class="d">-	if (git_diff_find_similar(ci-&gt;diff, &amp;fopts))
</a><a href="#h2-1-68" id="h2-1-68" class="d">-		goto err;
</a><a href="#h2-1-69" id="h2-1-69" class="d">-
</a><a href="#h2-1-70" id="h2-1-70" class="d">-	ndeltas = git_diff_num_deltas(ci-&gt;diff);
</a><a href="#h2-1-71" id="h2-1-71" class="d">-	if (ndeltas &amp;&amp; !(ci-&gt;deltas = calloc(ndeltas, sizeof(struct deltainfo *))))
</a><a href="#h2-1-72" id="h2-1-72" class="d">-		err(1, &quot;calloc&quot;);
</a><a href="#h2-1-73" id="h2-1-73" class="d">-
</a><a href="#h2-1-74" id="h2-1-74" class="d">-	for (i = 0; i &lt; ndeltas; i++) {
</a><a href="#h2-1-75" id="h2-1-75" class="d">-		if (git_patch_from_diff(&amp;patch, ci-&gt;diff, i))
</a><a href="#h2-1-76" id="h2-1-76" class="d">-			goto err;
</a><a href="#h2-1-77" id="h2-1-77" class="d">-
</a><a href="#h2-1-78" id="h2-1-78" class="d">-		if (!(di = calloc(1, sizeof(struct deltainfo))))
</a><a href="#h2-1-79" id="h2-1-79" class="d">-			err(1, &quot;calloc&quot;);
</a><a href="#h2-1-80" id="h2-1-80" class="d">-		di-&gt;patch = patch;
</a><a href="#h2-1-81" id="h2-1-81" class="d">-		ci-&gt;deltas[i] = di;
</a><a href="#h2-1-82" id="h2-1-82" class="d">-
</a><a href="#h2-1-83" id="h2-1-83" class="d">-		delta = git_patch_get_delta(patch);
</a><a href="#h2-1-84" id="h2-1-84" class="d">-
</a><a href="#h2-1-85" id="h2-1-85" class="d">-		/* skip stats for binary data */
</a><a href="#h2-1-86" id="h2-1-86" class="d">-		if (delta-&gt;flags &amp; GIT_DIFF_FLAG_BINARY)
</a><a href="#h2-1-87" id="h2-1-87" class="d">-			continue;
</a><a href="#h2-1-88" id="h2-1-88" class="d">-
</a><a href="#h2-1-89" id="h2-1-89" class="d">-		nhunks = git_patch_num_hunks(patch);
</a><a href="#h2-1-90" id="h2-1-90" class="d">-		for (j = 0; j &lt; nhunks; j++) {
</a><a href="#h2-1-91" id="h2-1-91" class="d">-			if (git_patch_get_hunk(&amp;hunk, &amp;nhunklines, patch, j))
</a><a href="#h2-1-92" id="h2-1-92" class="d">-				break;
</a><a href="#h2-1-93" id="h2-1-93" class="d">-			for (k = 0; ; k++) {
</a><a href="#h2-1-94" id="h2-1-94" class="d">-				if (git_patch_get_line_in_hunk(&amp;line, patch, j, k))
</a><a href="#h2-1-95" id="h2-1-95" class="d">-					break;
</a><a href="#h2-1-96" id="h2-1-96" class="d">-				if (line-&gt;old_lineno == -1) {
</a><a href="#h2-1-97" id="h2-1-97" class="d">-					di-&gt;addcount++;
</a><a href="#h2-1-98" id="h2-1-98" class="d">-					ci-&gt;addcount++;
</a><a href="#h2-1-99" id="h2-1-99" class="d">-				} else if (line-&gt;new_lineno == -1) {
</a><a href="#h2-1-100" id="h2-1-100" class="d">-					di-&gt;delcount++;
</a><a href="#h2-1-101" id="h2-1-101" class="d">-					ci-&gt;delcount++;
</a><a href="#h2-1-102" id="h2-1-102" class="d">-				}
</a><a href="#h2-1-103" id="h2-1-103" class="d">-			}
</a><a href="#h2-1-104" id="h2-1-104" class="d">-		}
</a><a href="#h2-1-105" id="h2-1-105" class="d">-	}
</a><a href="#h2-1-106" id="h2-1-106" class="d">-	ci-&gt;ndeltas = i;
</a><a href="#h2-1-107" id="h2-1-107" class="d">-	ci-&gt;filecount = i;
</a><a href="#h2-1-108" id="h2-1-108" class="d">-
</a><a href="#h2-1-109" id="h2-1-109" class="d">-	return 0;
</a><a href="#h2-1-110" id="h2-1-110" class="i">+  struct deltainfo *di;
</a><a href="#h2-1-111" id="h2-1-111" class="i">+  git_diff_options opts;
</a><a href="#h2-1-112" id="h2-1-112" class="i">+  git_diff_find_options fopts;
</a><a href="#h2-1-113" id="h2-1-113" class="i">+  const git_diff_delta *delta;
</a><a href="#h2-1-114" id="h2-1-114" class="i">+  const git_diff_hunk *hunk;
</a><a href="#h2-1-115" id="h2-1-115" class="i">+  const git_diff_line *line;
</a><a href="#h2-1-116" id="h2-1-116" class="i">+  git_patch *patch = NULL;
</a><a href="#h2-1-117" id="h2-1-117" class="i">+  size_t ndeltas, nhunks, nhunklines;
</a><a href="#h2-1-118" id="h2-1-118" class="i">+  size_t i, j, k;
</a><a href="#h2-1-119" id="h2-1-119" class="i">+
</a><a href="#h2-1-120" id="h2-1-120" class="i">+  if (git_tree_lookup(&amp;(ci-&gt;commit_tree), repo, git_commit_tree_id(ci-&gt;commit)))
</a><a href="#h2-1-121" id="h2-1-121" class="i">+    goto err;
</a><a href="#h2-1-122" id="h2-1-122" class="i">+  if (!git_commit_parent(&amp;(ci-&gt;parent), ci-&gt;commit, 0)) {
</a><a href="#h2-1-123" id="h2-1-123" class="i">+    if (git_tree_lookup(&amp;(ci-&gt;parent_tree), repo, git_commit_tree_id(ci-&gt;parent))) {
</a><a href="#h2-1-124" id="h2-1-124" class="i">+      ci-&gt;parent = NULL;
</a><a href="#h2-1-125" id="h2-1-125" class="i">+      ci-&gt;parent_tree = NULL;
</a><a href="#h2-1-126" id="h2-1-126" class="i">+    }
</a><a href="#h2-1-127" id="h2-1-127" class="i">+  }
</a><a href="#h2-1-128" id="h2-1-128" class="i">+
</a><a href="#h2-1-129" id="h2-1-129" class="i">+  git_diff_init_options(&amp;opts, GIT_DIFF_OPTIONS_VERSION);
</a><a href="#h2-1-130" id="h2-1-130" class="i">+  opts.flags |= GIT_DIFF_DISABLE_PATHSPEC_MATCH |
</a><a href="#h2-1-131" id="h2-1-131" class="i">+                GIT_DIFF_IGNORE_SUBMODULES |
</a><a href="#h2-1-132" id="h2-1-132" class="i">+          GIT_DIFF_INCLUDE_TYPECHANGE;
</a><a href="#h2-1-133" id="h2-1-133" class="i">+  if (git_diff_tree_to_tree(&amp;(ci-&gt;diff), repo, ci-&gt;parent_tree, ci-&gt;commit_tree, &amp;opts))
</a><a href="#h2-1-134" id="h2-1-134" class="i">+    goto err;
</a><a href="#h2-1-135" id="h2-1-135" class="i">+
</a><a href="#h2-1-136" id="h2-1-136" class="i">+  if (git_diff_find_init_options(&amp;fopts, GIT_DIFF_FIND_OPTIONS_VERSION))
</a><a href="#h2-1-137" id="h2-1-137" class="i">+    goto err;
</a><a href="#h2-1-138" id="h2-1-138" class="i">+  /* find renames and copies, exact matches (no heuristic) for renames. */
</a><a href="#h2-1-139" id="h2-1-139" class="i">+  fopts.flags |= GIT_DIFF_FIND_RENAMES | GIT_DIFF_FIND_COPIES |
</a><a href="#h2-1-140" id="h2-1-140" class="i">+                 GIT_DIFF_FIND_EXACT_MATCH_ONLY;
</a><a href="#h2-1-141" id="h2-1-141" class="i">+  if (git_diff_find_similar(ci-&gt;diff, &amp;fopts))
</a><a href="#h2-1-142" id="h2-1-142" class="i">+    goto err;
</a><a href="#h2-1-143" id="h2-1-143" class="i">+
</a><a href="#h2-1-144" id="h2-1-144" class="i">+  ndeltas = git_diff_num_deltas(ci-&gt;diff);
</a><a href="#h2-1-145" id="h2-1-145" class="i">+  if (ndeltas &amp;&amp; !(ci-&gt;deltas = calloc(ndeltas, sizeof(struct deltainfo *))))
</a><a href="#h2-1-146" id="h2-1-146" class="i">+    err(1, &quot;calloc&quot;);
</a><a href="#h2-1-147" id="h2-1-147" class="i">+
</a><a href="#h2-1-148" id="h2-1-148" class="i">+  for (i = 0; i &lt; ndeltas; i++) {
</a><a href="#h2-1-149" id="h2-1-149" class="i">+    if (git_patch_from_diff(&amp;patch, ci-&gt;diff, i))
</a><a href="#h2-1-150" id="h2-1-150" class="i">+      goto err;
</a><a href="#h2-1-151" id="h2-1-151" class="i">+
</a><a href="#h2-1-152" id="h2-1-152" class="i">+    if (!(di = calloc(1, sizeof(struct deltainfo))))
</a><a href="#h2-1-153" id="h2-1-153" class="i">+      err(1, &quot;calloc&quot;);
</a><a href="#h2-1-154" id="h2-1-154" class="i">+    di-&gt;patch = patch;
</a><a href="#h2-1-155" id="h2-1-155" class="i">+    ci-&gt;deltas[i] = di;
</a><a href="#h2-1-156" id="h2-1-156" class="i">+
</a><a href="#h2-1-157" id="h2-1-157" class="i">+    delta = git_patch_get_delta(patch);
</a><a href="#h2-1-158" id="h2-1-158" class="i">+
</a><a href="#h2-1-159" id="h2-1-159" class="i">+    /* skip stats for binary data */
</a><a href="#h2-1-160" id="h2-1-160" class="i">+    if (delta-&gt;flags &amp; GIT_DIFF_FLAG_BINARY)
</a><a href="#h2-1-161" id="h2-1-161" class="i">+      continue;
</a><a href="#h2-1-162" id="h2-1-162" class="i">+
</a><a href="#h2-1-163" id="h2-1-163" class="i">+    nhunks = git_patch_num_hunks(patch);
</a><a href="#h2-1-164" id="h2-1-164" class="i">+    for (j = 0; j &lt; nhunks; j++) {
</a><a href="#h2-1-165" id="h2-1-165" class="i">+      if (git_patch_get_hunk(&amp;hunk, &amp;nhunklines, patch, j))
</a><a href="#h2-1-166" id="h2-1-166" class="i">+        break;
</a><a href="#h2-1-167" id="h2-1-167" class="i">+      for (k = 0; ; k++) {
</a><a href="#h2-1-168" id="h2-1-168" class="i">+        if (git_patch_get_line_in_hunk(&amp;line, patch, j, k))
</a><a href="#h2-1-169" id="h2-1-169" class="i">+          break;
</a><a href="#h2-1-170" id="h2-1-170" class="i">+        if (line-&gt;old_lineno == -1) {
</a><a href="#h2-1-171" id="h2-1-171" class="i">+          di-&gt;addcount++;
</a><a href="#h2-1-172" id="h2-1-172" class="i">+          ci-&gt;addcount++;
</a><a href="#h2-1-173" id="h2-1-173" class="i">+        } else if (line-&gt;new_lineno == -1) {
</a><a href="#h2-1-174" id="h2-1-174" class="i">+          di-&gt;delcount++;
</a><a href="#h2-1-175" id="h2-1-175" class="i">+          ci-&gt;delcount++;
</a><a href="#h2-1-176" id="h2-1-176" class="i">+        }
</a><a href="#h2-1-177" id="h2-1-177" class="i">+      }
</a><a href="#h2-1-178" id="h2-1-178" class="i">+    }
</a><a href="#h2-1-179" id="h2-1-179" class="i">+  }
</a><a href="#h2-1-180" id="h2-1-180" class="i">+  ci-&gt;ndeltas = i;
</a><a href="#h2-1-181" id="h2-1-181" class="i">+  ci-&gt;filecount = i;
</a><a href="#h2-1-182" id="h2-1-182" class="i">+
</a><a href="#h2-1-183" id="h2-1-183" class="i">+  return 0;
</a> 
 err:
<a href="#h2-1-186" id="h2-1-186" class="d">-	git_diff_free(ci-&gt;diff);
</a><a href="#h2-1-187" id="h2-1-187" class="d">-	ci-&gt;diff = NULL;
</a><a href="#h2-1-188" id="h2-1-188" class="d">-	git_tree_free(ci-&gt;commit_tree);
</a><a href="#h2-1-189" id="h2-1-189" class="d">-	ci-&gt;commit_tree = NULL;
</a><a href="#h2-1-190" id="h2-1-190" class="d">-	git_tree_free(ci-&gt;parent_tree);
</a><a href="#h2-1-191" id="h2-1-191" class="d">-	ci-&gt;parent_tree = NULL;
</a><a href="#h2-1-192" id="h2-1-192" class="d">-	git_commit_free(ci-&gt;parent);
</a><a href="#h2-1-193" id="h2-1-193" class="d">-	ci-&gt;parent = NULL;
</a><a href="#h2-1-194" id="h2-1-194" class="d">-
</a><a href="#h2-1-195" id="h2-1-195" class="d">-	if (ci-&gt;deltas)
</a><a href="#h2-1-196" id="h2-1-196" class="d">-		for (i = 0; i &lt; ci-&gt;ndeltas; i++)
</a><a href="#h2-1-197" id="h2-1-197" class="d">-			deltainfo_free(ci-&gt;deltas[i]);
</a><a href="#h2-1-198" id="h2-1-198" class="d">-	free(ci-&gt;deltas);
</a><a href="#h2-1-199" id="h2-1-199" class="d">-	ci-&gt;deltas = NULL;
</a><a href="#h2-1-200" id="h2-1-200" class="d">-	ci-&gt;ndeltas = 0;
</a><a href="#h2-1-201" id="h2-1-201" class="d">-	ci-&gt;addcount = 0;
</a><a href="#h2-1-202" id="h2-1-202" class="d">-	ci-&gt;delcount = 0;
</a><a href="#h2-1-203" id="h2-1-203" class="d">-	ci-&gt;filecount = 0;
</a><a href="#h2-1-204" id="h2-1-204" class="d">-
</a><a href="#h2-1-205" id="h2-1-205" class="d">-	return -1;
</a><a href="#h2-1-206" id="h2-1-206" class="i">+  git_diff_free(ci-&gt;diff);
</a><a href="#h2-1-207" id="h2-1-207" class="i">+  ci-&gt;diff = NULL;
</a><a href="#h2-1-208" id="h2-1-208" class="i">+  git_tree_free(ci-&gt;commit_tree);
</a><a href="#h2-1-209" id="h2-1-209" class="i">+  ci-&gt;commit_tree = NULL;
</a><a href="#h2-1-210" id="h2-1-210" class="i">+  git_tree_free(ci-&gt;parent_tree);
</a><a href="#h2-1-211" id="h2-1-211" class="i">+  ci-&gt;parent_tree = NULL;
</a><a href="#h2-1-212" id="h2-1-212" class="i">+  git_commit_free(ci-&gt;parent);
</a><a href="#h2-1-213" id="h2-1-213" class="i">+  ci-&gt;parent = NULL;
</a><a href="#h2-1-214" id="h2-1-214" class="i">+
</a><a href="#h2-1-215" id="h2-1-215" class="i">+  if (ci-&gt;deltas)
</a><a href="#h2-1-216" id="h2-1-216" class="i">+    for (i = 0; i &lt; ci-&gt;ndeltas; i++)
</a><a href="#h2-1-217" id="h2-1-217" class="i">+      deltainfo_free(ci-&gt;deltas[i]);
</a><a href="#h2-1-218" id="h2-1-218" class="i">+  free(ci-&gt;deltas);
</a><a href="#h2-1-219" id="h2-1-219" class="i">+  ci-&gt;deltas = NULL;
</a><a href="#h2-1-220" id="h2-1-220" class="i">+  ci-&gt;ndeltas = 0;
</a><a href="#h2-1-221" id="h2-1-221" class="i">+  ci-&gt;addcount = 0;
</a><a href="#h2-1-222" id="h2-1-222" class="i">+  ci-&gt;delcount = 0;
</a><a href="#h2-1-223" id="h2-1-223" class="i">+  ci-&gt;filecount = 0;
</a><a href="#h2-1-224" id="h2-1-224" class="i">+
</a><a href="#h2-1-225" id="h2-1-225" class="i">+  return -1;
</a> }
 
 void
 commitinfo_free(struct commitinfo *ci)
 {
<a href="#h2-1-231" id="h2-1-231" class="d">-	size_t i;
</a><a href="#h2-1-232" id="h2-1-232" class="d">-
</a><a href="#h2-1-233" id="h2-1-233" class="d">-	if (!ci)
</a><a href="#h2-1-234" id="h2-1-234" class="d">-		return;
</a><a href="#h2-1-235" id="h2-1-235" class="d">-	if (ci-&gt;deltas)
</a><a href="#h2-1-236" id="h2-1-236" class="d">-		for (i = 0; i &lt; ci-&gt;ndeltas; i++)
</a><a href="#h2-1-237" id="h2-1-237" class="d">-			deltainfo_free(ci-&gt;deltas[i]);
</a><a href="#h2-1-238" id="h2-1-238" class="d">-
</a><a href="#h2-1-239" id="h2-1-239" class="d">-	free(ci-&gt;deltas);
</a><a href="#h2-1-240" id="h2-1-240" class="d">-	git_diff_free(ci-&gt;diff);
</a><a href="#h2-1-241" id="h2-1-241" class="d">-	git_tree_free(ci-&gt;commit_tree);
</a><a href="#h2-1-242" id="h2-1-242" class="d">-	git_tree_free(ci-&gt;parent_tree);
</a><a href="#h2-1-243" id="h2-1-243" class="d">-	git_commit_free(ci-&gt;commit);
</a><a href="#h2-1-244" id="h2-1-244" class="d">-	git_commit_free(ci-&gt;parent);
</a><a href="#h2-1-245" id="h2-1-245" class="d">-	memset(ci, 0, sizeof(*ci));
</a><a href="#h2-1-246" id="h2-1-246" class="d">-	free(ci);
</a><a href="#h2-1-247" id="h2-1-247" class="i">+  size_t i;
</a><a href="#h2-1-248" id="h2-1-248" class="i">+
</a><a href="#h2-1-249" id="h2-1-249" class="i">+  if (!ci)
</a><a href="#h2-1-250" id="h2-1-250" class="i">+    return;
</a><a href="#h2-1-251" id="h2-1-251" class="i">+  if (ci-&gt;deltas)
</a><a href="#h2-1-252" id="h2-1-252" class="i">+    for (i = 0; i &lt; ci-&gt;ndeltas; i++)
</a><a href="#h2-1-253" id="h2-1-253" class="i">+      deltainfo_free(ci-&gt;deltas[i]);
</a><a href="#h2-1-254" id="h2-1-254" class="i">+
</a><a href="#h2-1-255" id="h2-1-255" class="i">+  free(ci-&gt;deltas);
</a><a href="#h2-1-256" id="h2-1-256" class="i">+  git_diff_free(ci-&gt;diff);
</a><a href="#h2-1-257" id="h2-1-257" class="i">+  git_tree_free(ci-&gt;commit_tree);
</a><a href="#h2-1-258" id="h2-1-258" class="i">+  git_tree_free(ci-&gt;parent_tree);
</a><a href="#h2-1-259" id="h2-1-259" class="i">+  git_commit_free(ci-&gt;commit);
</a><a href="#h2-1-260" id="h2-1-260" class="i">+  git_commit_free(ci-&gt;parent);
</a><a href="#h2-1-261" id="h2-1-261" class="i">+  memset(ci, 0, sizeof(*ci));
</a><a href="#h2-1-262" id="h2-1-262" class="i">+  free(ci);
</a> }
 
 struct commitinfo *
 commitinfo_getbyoid(const git_oid *id)
 {
<a href="#h2-1-268" id="h2-1-268" class="d">-	struct commitinfo *ci;
</a><a href="#h2-1-269" id="h2-1-269" class="i">+  struct commitinfo *ci;
</a> 
<a href="#h2-1-271" id="h2-1-271" class="d">-	if (!(ci = calloc(1, sizeof(struct commitinfo))))
</a><a href="#h2-1-272" id="h2-1-272" class="d">-		err(1, &quot;calloc&quot;);
</a><a href="#h2-1-273" id="h2-1-273" class="i">+  if (!(ci = calloc(1, sizeof(struct commitinfo))))
</a><a href="#h2-1-274" id="h2-1-274" class="i">+    err(1, &quot;calloc&quot;);
</a> 
<a href="#h2-1-276" id="h2-1-276" class="d">-	if (git_commit_lookup(&amp;(ci-&gt;commit), repo, id))
</a><a href="#h2-1-277" id="h2-1-277" class="d">-		goto err;
</a><a href="#h2-1-278" id="h2-1-278" class="d">-	ci-&gt;id = id;
</a><a href="#h2-1-279" id="h2-1-279" class="i">+  if (git_commit_lookup(&amp;(ci-&gt;commit), repo, id))
</a><a href="#h2-1-280" id="h2-1-280" class="i">+    goto err;
</a><a href="#h2-1-281" id="h2-1-281" class="i">+  ci-&gt;id = id;
</a> 
<a href="#h2-1-283" id="h2-1-283" class="d">-	git_oid_tostr(ci-&gt;oid, sizeof(ci-&gt;oid), git_commit_id(ci-&gt;commit));
</a><a href="#h2-1-284" id="h2-1-284" class="d">-	git_oid_tostr(ci-&gt;parentoid, sizeof(ci-&gt;parentoid), git_commit_parent_id(ci-&gt;commit, 0));
</a><a href="#h2-1-285" id="h2-1-285" class="i">+  git_oid_tostr(ci-&gt;oid, sizeof(ci-&gt;oid), git_commit_id(ci-&gt;commit));
</a><a href="#h2-1-286" id="h2-1-286" class="i">+  git_oid_tostr(ci-&gt;parentoid, sizeof(ci-&gt;parentoid), git_commit_parent_id(ci-&gt;commit, 0));
</a> 
<a href="#h2-1-288" id="h2-1-288" class="d">-	ci-&gt;author = git_commit_author(ci-&gt;commit);
</a><a href="#h2-1-289" id="h2-1-289" class="d">-	ci-&gt;committer = git_commit_committer(ci-&gt;commit);
</a><a href="#h2-1-290" id="h2-1-290" class="d">-	ci-&gt;summary = git_commit_summary(ci-&gt;commit);
</a><a href="#h2-1-291" id="h2-1-291" class="d">-	ci-&gt;msg = git_commit_message(ci-&gt;commit);
</a><a href="#h2-1-292" id="h2-1-292" class="i">+  ci-&gt;author = git_commit_author(ci-&gt;commit);
</a><a href="#h2-1-293" id="h2-1-293" class="i">+  ci-&gt;committer = git_commit_committer(ci-&gt;commit);
</a><a href="#h2-1-294" id="h2-1-294" class="i">+  ci-&gt;summary = git_commit_summary(ci-&gt;commit);
</a><a href="#h2-1-295" id="h2-1-295" class="i">+  ci-&gt;msg = git_commit_message(ci-&gt;commit);
</a> 
<a href="#h2-1-297" id="h2-1-297" class="d">-	return ci;
</a><a href="#h2-1-298" id="h2-1-298" class="i">+  return ci;
</a> 
 err:
<a href="#h2-1-301" id="h2-1-301" class="d">-	commitinfo_free(ci);
</a><a href="#h2-1-302" id="h2-1-302" class="i">+  commitinfo_free(ci);
</a> 
<a href="#h2-1-304" id="h2-1-304" class="d">-	return NULL;
</a><a href="#h2-1-305" id="h2-1-305" class="i">+  return NULL;
</a> }
 
 FILE *
 efopen(const char *name, const char *flags)
 {
<a href="#h2-1-311" id="h2-1-311" class="d">-	FILE *fp;
</a><a href="#h2-1-312" id="h2-1-312" class="i">+  FILE *fp;
</a> 
<a href="#h2-1-314" id="h2-1-314" class="d">-	if (!(fp = fopen(name, flags)))
</a><a href="#h2-1-315" id="h2-1-315" class="d">-		err(1, &quot;fopen: &#39;%s&#39;&quot;, name);
</a><a href="#h2-1-316" id="h2-1-316" class="i">+  if (!(fp = fopen(name, flags)))
</a><a href="#h2-1-317" id="h2-1-317" class="i">+    err(1, &quot;fopen: &#39;%s&#39;&quot;, name);
</a> 
<a href="#h2-1-319" id="h2-1-319" class="d">-	return fp;
</a><a href="#h2-1-320" id="h2-1-320" class="i">+  return fp;
</a> }
 
 /* Escape characters below as HTML 2.0 / XML 1.0. */
 void
 xmlencode(FILE *fp, const char *s, size_t len)
 {
<a href="#h2-1-327" id="h2-1-327" class="d">-	size_t i;
</a><a href="#h2-1-328" id="h2-1-328" class="d">-
</a><a href="#h2-1-329" id="h2-1-329" class="d">-	for (i = 0; *s &amp;&amp; i &lt; len; s++, i++) {
</a><a href="#h2-1-330" id="h2-1-330" class="d">-		switch(*s) {
</a><a href="#h2-1-331" id="h2-1-331" class="d">-		case &#39;&lt;&#39;:  fputs(&quot;&amp;lt;&quot;,   fp); break;
</a><a href="#h2-1-332" id="h2-1-332" class="d">-		case &#39;&gt;&#39;:  fputs(&quot;&amp;gt;&quot;,   fp); break;
</a><a href="#h2-1-333" id="h2-1-333" class="d">-		case &#39;\&#39;&#39;: fputs(&quot;&amp;#39;&quot;,  fp); break;
</a><a href="#h2-1-334" id="h2-1-334" class="d">-		case &#39;&amp;&#39;:  fputs(&quot;&amp;amp;&quot;,  fp); break;
</a><a href="#h2-1-335" id="h2-1-335" class="d">-		case &#39;&quot;&#39;:  fputs(&quot;&amp;quot;&quot;, fp); break;
</a><a href="#h2-1-336" id="h2-1-336" class="d">-		default:   fputc(*s, fp);
</a><a href="#h2-1-337" id="h2-1-337" class="d">-		}
</a><a href="#h2-1-338" id="h2-1-338" class="d">-	}
</a><a href="#h2-1-339" id="h2-1-339" class="i">+  size_t i;
</a><a href="#h2-1-340" id="h2-1-340" class="i">+
</a><a href="#h2-1-341" id="h2-1-341" class="i">+  for (i = 0; *s &amp;&amp; i &lt; len; s++, i++) {
</a><a href="#h2-1-342" id="h2-1-342" class="i">+    switch(*s) {
</a><a href="#h2-1-343" id="h2-1-343" class="i">+    case &#39;&lt;&#39;:  fputs(&quot;&amp;lt;&quot;,   fp); break;
</a><a href="#h2-1-344" id="h2-1-344" class="i">+    case &#39;&gt;&#39;:  fputs(&quot;&amp;gt;&quot;,   fp); break;
</a><a href="#h2-1-345" id="h2-1-345" class="i">+    case &#39;\&#39;&#39;: fputs(&quot;&amp;#39;&quot;,  fp); break;
</a><a href="#h2-1-346" id="h2-1-346" class="i">+    case &#39;&amp;&#39;:  fputs(&quot;&amp;amp;&quot;,  fp); break;
</a><a href="#h2-1-347" id="h2-1-347" class="i">+    case &#39;&quot;&#39;:  fputs(&quot;&amp;quot;&quot;, fp); break;
</a><a href="#h2-1-348" id="h2-1-348" class="i">+    default:   fputc(*s, fp);
</a><a href="#h2-1-349" id="h2-1-349" class="i">+    }
</a><a href="#h2-1-350" id="h2-1-350" class="i">+  }
</a> }
 
 int
 mkdirp(const char *path)
 {
<a href="#h2-1-356" id="h2-1-356" class="d">-	char tmp[PATH_MAX], *p;
</a><a href="#h2-1-357" id="h2-1-357" class="d">-
</a><a href="#h2-1-358" id="h2-1-358" class="d">-	if (strlcpy(tmp, path, sizeof(tmp)) &gt;= sizeof(tmp))
</a><a href="#h2-1-359" id="h2-1-359" class="d">-		errx(1, &quot;path truncated: &#39;%s&#39;&quot;, path);
</a><a href="#h2-1-360" id="h2-1-360" class="d">-	for (p = tmp + (tmp[0] == &#39;/&#39;); *p; p++) {
</a><a href="#h2-1-361" id="h2-1-361" class="d">-		if (*p != &#39;/&#39;)
</a><a href="#h2-1-362" id="h2-1-362" class="d">-			continue;
</a><a href="#h2-1-363" id="h2-1-363" class="d">-		*p = &#39;\0&#39;;
</a><a href="#h2-1-364" id="h2-1-364" class="d">-		if (mkdir(tmp, S_IRWXU | S_IRWXG | S_IRWXO) &lt; 0 &amp;&amp; errno != EEXIST)
</a><a href="#h2-1-365" id="h2-1-365" class="d">-			return -1;
</a><a href="#h2-1-366" id="h2-1-366" class="d">-		*p = &#39;/&#39;;
</a><a href="#h2-1-367" id="h2-1-367" class="d">-	}
</a><a href="#h2-1-368" id="h2-1-368" class="d">-	if (mkdir(tmp, S_IRWXU | S_IRWXG | S_IRWXO) &lt; 0 &amp;&amp; errno != EEXIST)
</a><a href="#h2-1-369" id="h2-1-369" class="d">-		return -1;
</a><a href="#h2-1-370" id="h2-1-370" class="d">-	return 0;
</a><a href="#h2-1-371" id="h2-1-371" class="i">+  char tmp[PATH_MAX], *p;
</a><a href="#h2-1-372" id="h2-1-372" class="i">+
</a><a href="#h2-1-373" id="h2-1-373" class="i">+  if (strlcpy(tmp, path, sizeof(tmp)) &gt;= sizeof(tmp))
</a><a href="#h2-1-374" id="h2-1-374" class="i">+    errx(1, &quot;path truncated: &#39;%s&#39;&quot;, path);
</a><a href="#h2-1-375" id="h2-1-375" class="i">+  for (p = tmp + (tmp[0] == &#39;/&#39;); *p; p++) {
</a><a href="#h2-1-376" id="h2-1-376" class="i">+    if (*p != &#39;/&#39;)
</a><a href="#h2-1-377" id="h2-1-377" class="i">+      continue;
</a><a href="#h2-1-378" id="h2-1-378" class="i">+    *p = &#39;\0&#39;;
</a><a href="#h2-1-379" id="h2-1-379" class="i">+    if (mkdir(tmp, S_IRWXU | S_IRWXG | S_IRWXO) &lt; 0 &amp;&amp; errno != EEXIST)
</a><a href="#h2-1-380" id="h2-1-380" class="i">+      return -1;
</a><a href="#h2-1-381" id="h2-1-381" class="i">+    *p = &#39;/&#39;;
</a><a href="#h2-1-382" id="h2-1-382" class="i">+  }
</a><a href="#h2-1-383" id="h2-1-383" class="i">+  if (mkdir(tmp, S_IRWXU | S_IRWXG | S_IRWXO) &lt; 0 &amp;&amp; errno != EEXIST)
</a><a href="#h2-1-384" id="h2-1-384" class="i">+    return -1;
</a><a href="#h2-1-385" id="h2-1-385" class="i">+  return 0;
</a> }
 
 void
 printtimez(FILE *fp, const git_time *intime)
 {
<a href="#h2-1-391" id="h2-1-391" class="d">-	struct tm *intm;
</a><a href="#h2-1-392" id="h2-1-392" class="d">-	time_t t;
</a><a href="#h2-1-393" id="h2-1-393" class="d">-	char out[32];
</a><a href="#h2-1-394" id="h2-1-394" class="d">-
</a><a href="#h2-1-395" id="h2-1-395" class="d">-	t = (time_t)intime-&gt;time;
</a><a href="#h2-1-396" id="h2-1-396" class="d">-	if (!(intm = gmtime(&amp;t)))
</a><a href="#h2-1-397" id="h2-1-397" class="d">-		return;
</a><a href="#h2-1-398" id="h2-1-398" class="d">-	strftime(out, sizeof(out), &quot;%Y-%m-%dT%H:%M:%SZ&quot;, intm);
</a><a href="#h2-1-399" id="h2-1-399" class="d">-	fputs(out, fp);
</a><a href="#h2-1-400" id="h2-1-400" class="i">+  struct tm *intm;
</a><a href="#h2-1-401" id="h2-1-401" class="i">+  time_t t;
</a><a href="#h2-1-402" id="h2-1-402" class="i">+  char out[32];
</a><a href="#h2-1-403" id="h2-1-403" class="i">+
</a><a href="#h2-1-404" id="h2-1-404" class="i">+  t = (time_t)intime-&gt;time;
</a><a href="#h2-1-405" id="h2-1-405" class="i">+  if (!(intm = gmtime(&amp;t)))
</a><a href="#h2-1-406" id="h2-1-406" class="i">+    return;
</a><a href="#h2-1-407" id="h2-1-407" class="i">+  strftime(out, sizeof(out), &quot;%Y-%m-%dT%H:%M:%SZ&quot;, intm);
</a><a href="#h2-1-408" id="h2-1-408" class="i">+  fputs(out, fp);
</a> }
 
 void
 printtime(FILE *fp, const git_time *intime)
 {
<a href="#h2-1-414" id="h2-1-414" class="d">-	struct tm *intm;
</a><a href="#h2-1-415" id="h2-1-415" class="d">-	time_t t;
</a><a href="#h2-1-416" id="h2-1-416" class="d">-	char out[32];
</a><a href="#h2-1-417" id="h2-1-417" class="d">-
</a><a href="#h2-1-418" id="h2-1-418" class="d">-	t = (time_t)intime-&gt;time + (intime-&gt;offset * 60);
</a><a href="#h2-1-419" id="h2-1-419" class="d">-	if (!(intm = gmtime(&amp;t)))
</a><a href="#h2-1-420" id="h2-1-420" class="d">-		return;
</a><a href="#h2-1-421" id="h2-1-421" class="d">-	strftime(out, sizeof(out), &quot;%a, %e %b %Y %H:%M:%S&quot;, intm);
</a><a href="#h2-1-422" id="h2-1-422" class="d">-	if (intime-&gt;offset &lt; 0)
</a><a href="#h2-1-423" id="h2-1-423" class="d">-		fprintf(fp, &quot;%s -%02d%02d&quot;, out,
</a><a href="#h2-1-424" id="h2-1-424" class="d">-		            -(intime-&gt;offset) / 60, -(intime-&gt;offset) % 60);
</a><a href="#h2-1-425" id="h2-1-425" class="d">-	else
</a><a href="#h2-1-426" id="h2-1-426" class="d">-		fprintf(fp, &quot;%s +%02d%02d&quot;, out,
</a><a href="#h2-1-427" id="h2-1-427" class="d">-		            intime-&gt;offset / 60, intime-&gt;offset % 60);
</a><a href="#h2-1-428" id="h2-1-428" class="i">+  struct tm *intm;
</a><a href="#h2-1-429" id="h2-1-429" class="i">+  time_t t;
</a><a href="#h2-1-430" id="h2-1-430" class="i">+  char out[32];
</a><a href="#h2-1-431" id="h2-1-431" class="i">+
</a><a href="#h2-1-432" id="h2-1-432" class="i">+  t = (time_t)intime-&gt;time + (intime-&gt;offset * 60);
</a><a href="#h2-1-433" id="h2-1-433" class="i">+  if (!(intm = gmtime(&amp;t)))
</a><a href="#h2-1-434" id="h2-1-434" class="i">+    return;
</a><a href="#h2-1-435" id="h2-1-435" class="i">+  strftime(out, sizeof(out), &quot;%a, %e %b %Y %H:%M:%S&quot;, intm);
</a><a href="#h2-1-436" id="h2-1-436" class="i">+  if (intime-&gt;offset &lt; 0)
</a><a href="#h2-1-437" id="h2-1-437" class="i">+    fprintf(fp, &quot;%s -%02d%02d&quot;, out,
</a><a href="#h2-1-438" id="h2-1-438" class="i">+                -(intime-&gt;offset) / 60, -(intime-&gt;offset) % 60);
</a><a href="#h2-1-439" id="h2-1-439" class="i">+  else
</a><a href="#h2-1-440" id="h2-1-440" class="i">+    fprintf(fp, &quot;%s +%02d%02d&quot;, out,
</a><a href="#h2-1-441" id="h2-1-441" class="i">+                intime-&gt;offset / 60, intime-&gt;offset % 60);
</a> }
 
 void
 printtimeshort(FILE *fp, const git_time *intime)
 {
<a href="#h2-1-447" id="h2-1-447" class="d">-	struct tm *intm;
</a><a href="#h2-1-448" id="h2-1-448" class="d">-	time_t t;
</a><a href="#h2-1-449" id="h2-1-449" class="d">-	char out[32];
</a><a href="#h2-1-450" id="h2-1-450" class="d">-
</a><a href="#h2-1-451" id="h2-1-451" class="d">-	t = (time_t)intime-&gt;time;
</a><a href="#h2-1-452" id="h2-1-452" class="d">-	if (!(intm = gmtime(&amp;t)))
</a><a href="#h2-1-453" id="h2-1-453" class="d">-		return;
</a><a href="#h2-1-454" id="h2-1-454" class="d">-	strftime(out, sizeof(out), &quot;%Y-%m-%d %H:%M&quot;, intm);
</a><a href="#h2-1-455" id="h2-1-455" class="d">-	fputs(out, fp);
</a><a href="#h2-1-456" id="h2-1-456" class="i">+  struct tm *intm;
</a><a href="#h2-1-457" id="h2-1-457" class="i">+  time_t t;
</a><a href="#h2-1-458" id="h2-1-458" class="i">+  char out[32];
</a><a href="#h2-1-459" id="h2-1-459" class="i">+
</a><a href="#h2-1-460" id="h2-1-460" class="i">+  t = (time_t)intime-&gt;time;
</a><a href="#h2-1-461" id="h2-1-461" class="i">+  if (!(intm = gmtime(&amp;t)))
</a><a href="#h2-1-462" id="h2-1-462" class="i">+    return;
</a><a href="#h2-1-463" id="h2-1-463" class="i">+  strftime(out, sizeof(out), &quot;%Y-%m-%d %H:%M&quot;, intm);
</a><a href="#h2-1-464" id="h2-1-464" class="i">+  fputs(out, fp);
</a> }
 
 void
 writeheader(FILE *fp, const char *title)
 {
<a href="#h2-1-470" id="h2-1-470" class="d">-	fputs(&quot;&lt;!DOCTYPE html&gt;\n&quot;
</a><a href="#h2-1-471" id="h2-1-471" class="d">-		&quot;&lt;html&gt;\n&lt;head&gt;\n&quot;
</a><a href="#h2-1-472" id="h2-1-472" class="i">+  fputs(&quot;&lt;!DOCTYPE html&gt;\n&quot;
</a><a href="#h2-1-473" id="h2-1-473" class="i">+    &quot;&lt;html&gt;\n&lt;head&gt;\n&quot;
</a>     &quot;&lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1\&quot;&gt;\n&quot;
<a href="#h2-1-475" id="h2-1-475" class="d">-		&quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=UTF-8\&quot; /&gt;\n&quot;
</a><a href="#h2-1-476" id="h2-1-476" class="d">-		&quot;&lt;title&gt;&quot;, fp);
</a><a href="#h2-1-477" id="h2-1-477" class="d">-	xmlencode(fp, title, strlen(title));
</a><a href="#h2-1-478" id="h2-1-478" class="d">-	if (title[0] &amp;&amp; strippedname[0])
</a><a href="#h2-1-479" id="h2-1-479" class="d">-		fputs(&quot; - &quot;, fp);
</a><a href="#h2-1-480" id="h2-1-480" class="d">-	xmlencode(fp, strippedname, strlen(strippedname));
</a><a href="#h2-1-481" id="h2-1-481" class="d">-	if (description[0])
</a><a href="#h2-1-482" id="h2-1-482" class="d">-		fputs(&quot; - &quot;, fp);
</a><a href="#h2-1-483" id="h2-1-483" class="d">-	xmlencode(fp, description, strlen(description));
</a><a href="#h2-1-484" id="h2-1-484" class="d">-	fprintf(fp, &quot;&lt;/title&gt;\n&lt;link rel=\&quot;icon\&quot; type=\&quot;image/png\&quot; href=\&quot;/favicon.png\&quot; /&gt;\n&quot;);
</a><a href="#h2-1-485" id="h2-1-485" class="d">-	fprintf(fp, &quot;&lt;link rel=\&quot;alternate\&quot; type=\&quot;application/atom+xml\&quot; title=\&quot;%s Atom Feed\&quot; href=\&quot;%satom.xml\&quot; /&gt;\n&quot;,
</a><a href="#h2-1-486" id="h2-1-486" class="d">-		name, relpath);
</a><a href="#h2-1-487" id="h2-1-487" class="d">-	fprintf(fp, &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;/style.css\&quot; /&gt;\n&quot;);
</a><a href="#h2-1-488" id="h2-1-488" class="d">-	fputs(&quot;&lt;/head&gt;\n&lt;body&gt;\n&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-489" id="h2-1-489" class="d">-	fprintf(fp, &quot;&lt;a href=\&quot;../%s\&quot;&gt;&lt;img src=\&quot;/logo.png\&quot; alt=\&quot;\&quot; width=\&quot;32\&quot; height=\&quot;32\&quot; /&gt;&lt;/a&gt;&quot;,
</a><a href="#h2-1-490" id="h2-1-490" class="d">-	        relpath);
</a><a href="#h2-1-491" id="h2-1-491" class="d">-	fputs(&quot;&lt;/td&gt;&lt;td&gt;&lt;h1&gt;&quot;, fp);
</a><a href="#h2-1-492" id="h2-1-492" class="d">-	xmlencode(fp, strippedname, strlen(strippedname));
</a><a href="#h2-1-493" id="h2-1-493" class="d">-	fputs(&quot;&lt;/h1&gt;&lt;span class=\&quot;desc\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-494" id="h2-1-494" class="d">-	xmlencode(fp, description, strlen(description));
</a><a href="#h2-1-495" id="h2-1-495" class="d">-	fputs(&quot;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&quot;, fp);
</a><a href="#h2-1-496" id="h2-1-496" class="d">-	if (cloneurl[0]) {
</a><a href="#h2-1-497" id="h2-1-497" class="d">-		fputs(&quot;&lt;tr class=\&quot;url\&quot;&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;git clone &lt;a href=\&quot;&quot;, fp);
</a><a href="#h2-1-498" id="h2-1-498" class="d">-		xmlencode(fp, cloneurl, strlen(cloneurl));
</a><a href="#h2-1-499" id="h2-1-499" class="d">-		fputs(&quot;\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-500" id="h2-1-500" class="d">-		xmlencode(fp, cloneurl, strlen(cloneurl));
</a><a href="#h2-1-501" id="h2-1-501" class="d">-		fputs(&quot;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&quot;, fp);
</a><a href="#h2-1-502" id="h2-1-502" class="d">-	}
</a><a href="#h2-1-503" id="h2-1-503" class="d">-	fputs(&quot;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;\n&quot;, fp);
</a><a href="#h2-1-504" id="h2-1-504" class="d">-	fprintf(fp, &quot;&lt;a href=\&quot;%sindex.html\&quot;&gt;Log&lt;/a&gt; | &quot;, relpath);
</a><a href="#h2-1-505" id="h2-1-505" class="d">-	fprintf(fp, &quot;&lt;a href=\&quot;%sfiles.html\&quot;&gt;Files&lt;/a&gt; | &quot;, relpath);
</a><a href="#h2-1-506" id="h2-1-506" class="d">-	fprintf(fp, &quot;&lt;a href=\&quot;%srefs.html\&quot;&gt;Refs&lt;/a&gt;&quot;, relpath);
</a><a href="#h2-1-507" id="h2-1-507" class="d">-	if (submodules)
</a><a href="#h2-1-508" id="h2-1-508" class="d">-		fprintf(fp, &quot; | &lt;a href=\&quot;%sfile/%s.html\&quot;&gt;Submodules&lt;/a&gt;&quot;,
</a><a href="#h2-1-509" id="h2-1-509" class="d">-		        relpath, submodules);
</a><a href="#h2-1-510" id="h2-1-510" class="d">-	if (readme)
</a><a href="#h2-1-511" id="h2-1-511" class="d">-		fprintf(fp, &quot; | &lt;a href=\&quot;%sfile/%s.html\&quot;&gt;README&lt;/a&gt;&quot;,
</a><a href="#h2-1-512" id="h2-1-512" class="d">-		        relpath, readme);
</a><a href="#h2-1-513" id="h2-1-513" class="d">-	if (license)
</a><a href="#h2-1-514" id="h2-1-514" class="d">-		fprintf(fp, &quot; | &lt;a href=\&quot;%sfile/%s.html\&quot;&gt;LICENSE&lt;/a&gt;&quot;,
</a><a href="#h2-1-515" id="h2-1-515" class="d">-		        relpath, license);
</a><a href="#h2-1-516" id="h2-1-516" class="d">-	fputs(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&lt;hr/&gt;\n&lt;div id=\&quot;content\&quot;&gt;\n&quot;, fp);
</a><a href="#h2-1-517" id="h2-1-517" class="i">+    &quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=UTF-8\&quot; /&gt;\n&quot;
</a><a href="#h2-1-518" id="h2-1-518" class="i">+    &quot;&lt;title&gt;&quot;, fp);
</a><a href="#h2-1-519" id="h2-1-519" class="i">+  xmlencode(fp, title, strlen(title));
</a><a href="#h2-1-520" id="h2-1-520" class="i">+  if (title[0] &amp;&amp; strippedname[0])
</a><a href="#h2-1-521" id="h2-1-521" class="i">+    fputs(&quot; - &quot;, fp);
</a><a href="#h2-1-522" id="h2-1-522" class="i">+  xmlencode(fp, strippedname, strlen(strippedname));
</a><a href="#h2-1-523" id="h2-1-523" class="i">+  if (description[0])
</a><a href="#h2-1-524" id="h2-1-524" class="i">+    fputs(&quot; - &quot;, fp);
</a><a href="#h2-1-525" id="h2-1-525" class="i">+  xmlencode(fp, description, strlen(description));
</a><a href="#h2-1-526" id="h2-1-526" class="i">+  fprintf(fp, &quot;&lt;/title&gt;\n&lt;link rel=\&quot;icon\&quot; type=\&quot;image/png\&quot; href=\&quot;/favicon.png\&quot; /&gt;\n&quot;);
</a><a href="#h2-1-527" id="h2-1-527" class="i">+  fprintf(fp, &quot;&lt;link rel=\&quot;alternate\&quot; type=\&quot;application/atom+xml\&quot; title=\&quot;%s Atom Feed\&quot; href=\&quot;%satom.xml\&quot; /&gt;\n&quot;,
</a><a href="#h2-1-528" id="h2-1-528" class="i">+    name, relpath);
</a><a href="#h2-1-529" id="h2-1-529" class="i">+  fprintf(fp, &quot;&lt;link rel=\&quot;stylesheet\&quot; type=\&quot;text/css\&quot; href=\&quot;/style.css\&quot; /&gt;\n&quot;);
</a><a href="#h2-1-530" id="h2-1-530" class="i">+  fputs(&quot;&lt;/head&gt;\n&lt;body&gt;\n&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-531" id="h2-1-531" class="i">+  fprintf(fp, &quot;&lt;a href=\&quot;../%s\&quot;&gt;&lt;img src=\&quot;/logo.png\&quot; alt=\&quot;\&quot; width=\&quot;32\&quot; height=\&quot;32\&quot; /&gt;&lt;/a&gt;&quot;,
</a><a href="#h2-1-532" id="h2-1-532" class="i">+          relpath);
</a><a href="#h2-1-533" id="h2-1-533" class="i">+  fputs(&quot;&lt;/td&gt;&lt;td&gt;&lt;h1&gt;&quot;, fp);
</a><a href="#h2-1-534" id="h2-1-534" class="i">+  xmlencode(fp, strippedname, strlen(strippedname));
</a><a href="#h2-1-535" id="h2-1-535" class="i">+  fputs(&quot;&lt;/h1&gt;&lt;span class=\&quot;desc\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-536" id="h2-1-536" class="i">+  xmlencode(fp, description, strlen(description));
</a><a href="#h2-1-537" id="h2-1-537" class="i">+  fputs(&quot;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&quot;, fp);
</a><a href="#h2-1-538" id="h2-1-538" class="i">+  if (cloneurl[0]) {
</a><a href="#h2-1-539" id="h2-1-539" class="i">+    fputs(&quot;&lt;tr class=\&quot;url\&quot;&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;git clone &lt;a href=\&quot;&quot;, fp);
</a><a href="#h2-1-540" id="h2-1-540" class="i">+    xmlencode(fp, cloneurl, strlen(cloneurl));
</a><a href="#h2-1-541" id="h2-1-541" class="i">+    fputs(&quot;\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-542" id="h2-1-542" class="i">+    xmlencode(fp, cloneurl, strlen(cloneurl));
</a><a href="#h2-1-543" id="h2-1-543" class="i">+    fputs(&quot;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&quot;, fp);
</a><a href="#h2-1-544" id="h2-1-544" class="i">+  }
</a><a href="#h2-1-545" id="h2-1-545" class="i">+  fputs(&quot;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;\n&quot;, fp);
</a><a href="#h2-1-546" id="h2-1-546" class="i">+  fprintf(fp, &quot;&lt;a href=\&quot;%sindex.html\&quot;&gt;Log&lt;/a&gt; | &quot;, relpath);
</a><a href="#h2-1-547" id="h2-1-547" class="i">+  fprintf(fp, &quot;&lt;a href=\&quot;%sfiles.html\&quot;&gt;Files&lt;/a&gt; | &quot;, relpath);
</a><a href="#h2-1-548" id="h2-1-548" class="i">+  fprintf(fp, &quot;&lt;a href=\&quot;%srefs.html\&quot;&gt;Refs&lt;/a&gt;&quot;, relpath);
</a><a href="#h2-1-549" id="h2-1-549" class="i">+  if (submodules)
</a><a href="#h2-1-550" id="h2-1-550" class="i">+    fprintf(fp, &quot; | &lt;a href=\&quot;%sfile/%s.html\&quot;&gt;Submodules&lt;/a&gt;&quot;,
</a><a href="#h2-1-551" id="h2-1-551" class="i">+            relpath, submodules);
</a><a href="#h2-1-552" id="h2-1-552" class="i">+  if (readme)
</a><a href="#h2-1-553" id="h2-1-553" class="i">+    fprintf(fp, &quot; | &lt;a href=\&quot;%sfile/%s.html\&quot;&gt;README&lt;/a&gt;&quot;,
</a><a href="#h2-1-554" id="h2-1-554" class="i">+            relpath, readme);
</a><a href="#h2-1-555" id="h2-1-555" class="i">+  if (license)
</a><a href="#h2-1-556" id="h2-1-556" class="i">+    fprintf(fp, &quot; | &lt;a href=\&quot;%sfile/%s.html\&quot;&gt;LICENSE&lt;/a&gt;&quot;,
</a><a href="#h2-1-557" id="h2-1-557" class="i">+            relpath, license);
</a><a href="#h2-1-558" id="h2-1-558" class="i">+  fputs(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&lt;hr/&gt;\n&lt;div id=\&quot;content\&quot;&gt;\n&quot;, fp);
</a> }
 
 void
 writefooter(FILE *fp)
 {
<a href="#h2-1-564" id="h2-1-564" class="d">-	fputs(&quot;&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&quot;, fp);
</a><a href="#h2-1-565" id="h2-1-565" class="i">+  fputs(&quot;&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&quot;, fp);
</a> }
 
 int
 writeblobhtml(FILE *fp, const git_blob *blob)
 {
<a href="#h2-1-571" id="h2-1-571" class="d">-	size_t n = 0, i, prev;
</a><a href="#h2-1-572" id="h2-1-572" class="d">-	const char *nfmt = &quot;&lt;a href=\&quot;#l%d\&quot; class=\&quot;line\&quot; id=\&quot;l%d\&quot;&gt;%7d&lt;/a&gt; &quot;;
</a><a href="#h2-1-573" id="h2-1-573" class="d">-	const char *s = git_blob_rawcontent(blob);
</a><a href="#h2-1-574" id="h2-1-574" class="d">-	git_off_t len = git_blob_rawsize(blob);
</a><a href="#h2-1-575" id="h2-1-575" class="d">-
</a><a href="#h2-1-576" id="h2-1-576" class="d">-	fputs(&quot;&lt;pre id=\&quot;blob\&quot;&gt;\n&quot;, fp);
</a><a href="#h2-1-577" id="h2-1-577" class="d">-
</a><a href="#h2-1-578" id="h2-1-578" class="d">-	if (len &gt; 0) {
</a><a href="#h2-1-579" id="h2-1-579" class="d">-		for (i = 0, prev = 0; i &lt; (size_t)len; i++) {
</a><a href="#h2-1-580" id="h2-1-580" class="d">-			if (s[i] != &#39;\n&#39;)
</a><a href="#h2-1-581" id="h2-1-581" class="d">-				continue;
</a><a href="#h2-1-582" id="h2-1-582" class="d">-			n++;
</a><a href="#h2-1-583" id="h2-1-583" class="d">-			fprintf(fp, nfmt, n, n, n);
</a><a href="#h2-1-584" id="h2-1-584" class="d">-			xmlencode(fp, &amp;s[prev], i - prev + 1);
</a><a href="#h2-1-585" id="h2-1-585" class="d">-			prev = i + 1;
</a><a href="#h2-1-586" id="h2-1-586" class="d">-		}
</a><a href="#h2-1-587" id="h2-1-587" class="d">-		/* trailing data */
</a><a href="#h2-1-588" id="h2-1-588" class="d">-		if ((len - prev) &gt; 0) {
</a><a href="#h2-1-589" id="h2-1-589" class="d">-			n++;
</a><a href="#h2-1-590" id="h2-1-590" class="d">-			fprintf(fp, nfmt, n, n, n);
</a><a href="#h2-1-591" id="h2-1-591" class="d">-			xmlencode(fp, &amp;s[prev], len - prev);
</a><a href="#h2-1-592" id="h2-1-592" class="d">-		}
</a><a href="#h2-1-593" id="h2-1-593" class="d">-	}
</a><a href="#h2-1-594" id="h2-1-594" class="d">-
</a><a href="#h2-1-595" id="h2-1-595" class="d">-	fputs(&quot;&lt;/pre&gt;\n&quot;, fp);
</a><a href="#h2-1-596" id="h2-1-596" class="d">-
</a><a href="#h2-1-597" id="h2-1-597" class="d">-	return n;
</a><a href="#h2-1-598" id="h2-1-598" class="i">+  size_t n = 0, i, prev;
</a><a href="#h2-1-599" id="h2-1-599" class="i">+  const char *nfmt = &quot;&lt;a href=\&quot;#l%d\&quot; class=\&quot;line\&quot; id=\&quot;l%d\&quot;&gt;%7d&lt;/a&gt; &quot;;
</a><a href="#h2-1-600" id="h2-1-600" class="i">+  const char *s = git_blob_rawcontent(blob);
</a><a href="#h2-1-601" id="h2-1-601" class="i">+  git_off_t len = git_blob_rawsize(blob);
</a><a href="#h2-1-602" id="h2-1-602" class="i">+
</a><a href="#h2-1-603" id="h2-1-603" class="i">+  fputs(&quot;&lt;pre id=\&quot;blob\&quot;&gt;\n&quot;, fp);
</a><a href="#h2-1-604" id="h2-1-604" class="i">+
</a><a href="#h2-1-605" id="h2-1-605" class="i">+  if (len &gt; 0) {
</a><a href="#h2-1-606" id="h2-1-606" class="i">+    for (i = 0, prev = 0; i &lt; (size_t)len; i++) {
</a><a href="#h2-1-607" id="h2-1-607" class="i">+      if (s[i] != &#39;\n&#39;)
</a><a href="#h2-1-608" id="h2-1-608" class="i">+        continue;
</a><a href="#h2-1-609" id="h2-1-609" class="i">+      n++;
</a><a href="#h2-1-610" id="h2-1-610" class="i">+      fprintf(fp, nfmt, n, n, n);
</a><a href="#h2-1-611" id="h2-1-611" class="i">+      xmlencode(fp, &amp;s[prev], i - prev + 1);
</a><a href="#h2-1-612" id="h2-1-612" class="i">+      prev = i + 1;
</a><a href="#h2-1-613" id="h2-1-613" class="i">+    }
</a><a href="#h2-1-614" id="h2-1-614" class="i">+    /* trailing data */
</a><a href="#h2-1-615" id="h2-1-615" class="i">+    if ((len - prev) &gt; 0) {
</a><a href="#h2-1-616" id="h2-1-616" class="i">+      n++;
</a><a href="#h2-1-617" id="h2-1-617" class="i">+      fprintf(fp, nfmt, n, n, n);
</a><a href="#h2-1-618" id="h2-1-618" class="i">+      xmlencode(fp, &amp;s[prev], len - prev);
</a><a href="#h2-1-619" id="h2-1-619" class="i">+    }
</a><a href="#h2-1-620" id="h2-1-620" class="i">+  }
</a><a href="#h2-1-621" id="h2-1-621" class="i">+
</a><a href="#h2-1-622" id="h2-1-622" class="i">+  fputs(&quot;&lt;/pre&gt;\n&quot;, fp);
</a><a href="#h2-1-623" id="h2-1-623" class="i">+
</a><a href="#h2-1-624" id="h2-1-624" class="i">+  return n;
</a> }
 
 void
 printcommit(FILE *fp, struct commitinfo *ci)
 {
<a href="#h2-1-630" id="h2-1-630" class="d">-	fprintf(fp, &quot;&lt;b&gt;commit&lt;/b&gt; &lt;a href=\&quot;%scommit/%s.html\&quot;&gt;%s&lt;/a&gt;\n&quot;,
</a><a href="#h2-1-631" id="h2-1-631" class="d">-		relpath, ci-&gt;oid, ci-&gt;oid);
</a><a href="#h2-1-632" id="h2-1-632" class="d">-
</a><a href="#h2-1-633" id="h2-1-633" class="d">-	if (ci-&gt;parentoid[0])
</a><a href="#h2-1-634" id="h2-1-634" class="d">-		fprintf(fp, &quot;&lt;b&gt;parent&lt;/b&gt; &lt;a href=\&quot;%scommit/%s.html\&quot;&gt;%s&lt;/a&gt;\n&quot;,
</a><a href="#h2-1-635" id="h2-1-635" class="d">-			relpath, ci-&gt;parentoid, ci-&gt;parentoid);
</a><a href="#h2-1-636" id="h2-1-636" class="d">-
</a><a href="#h2-1-637" id="h2-1-637" class="d">-	if (ci-&gt;author) {
</a><a href="#h2-1-638" id="h2-1-638" class="d">-		fputs(&quot;&lt;b&gt;Author:&lt;/b&gt; &quot;, fp);
</a><a href="#h2-1-639" id="h2-1-639" class="d">-		xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-640" id="h2-1-640" class="d">-		fputs(&quot; &amp;lt;&lt;a href=\&quot;mailto:&quot;, fp);
</a><a href="#h2-1-641" id="h2-1-641" class="d">-		xmlencode(fp, ci-&gt;author-&gt;email, strlen(ci-&gt;author-&gt;email));
</a><a href="#h2-1-642" id="h2-1-642" class="d">-		fputs(&quot;\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-643" id="h2-1-643" class="d">-		xmlencode(fp, ci-&gt;author-&gt;email, strlen(ci-&gt;author-&gt;email));
</a><a href="#h2-1-644" id="h2-1-644" class="d">-		fputs(&quot;&lt;/a&gt;&amp;gt;\n&lt;b&gt;Date:&lt;/b&gt;   &quot;, fp);
</a><a href="#h2-1-645" id="h2-1-645" class="d">-		printtime(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-646" id="h2-1-646" class="d">-		fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-647" id="h2-1-647" class="d">-	}
</a><a href="#h2-1-648" id="h2-1-648" class="d">-	if (ci-&gt;msg) {
</a><a href="#h2-1-649" id="h2-1-649" class="d">-		fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-650" id="h2-1-650" class="d">-		xmlencode(fp, ci-&gt;msg, strlen(ci-&gt;msg));
</a><a href="#h2-1-651" id="h2-1-651" class="d">-		fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-652" id="h2-1-652" class="d">-	}
</a><a href="#h2-1-653" id="h2-1-653" class="i">+  fprintf(fp, &quot;&lt;b&gt;commit&lt;/b&gt; &lt;a href=\&quot;%scommit/%s.html\&quot;&gt;%s&lt;/a&gt;\n&quot;,
</a><a href="#h2-1-654" id="h2-1-654" class="i">+    relpath, ci-&gt;oid, ci-&gt;oid);
</a><a href="#h2-1-655" id="h2-1-655" class="i">+
</a><a href="#h2-1-656" id="h2-1-656" class="i">+  if (ci-&gt;parentoid[0])
</a><a href="#h2-1-657" id="h2-1-657" class="i">+    fprintf(fp, &quot;&lt;b&gt;parent&lt;/b&gt; &lt;a href=\&quot;%scommit/%s.html\&quot;&gt;%s&lt;/a&gt;\n&quot;,
</a><a href="#h2-1-658" id="h2-1-658" class="i">+      relpath, ci-&gt;parentoid, ci-&gt;parentoid);
</a><a href="#h2-1-659" id="h2-1-659" class="i">+
</a><a href="#h2-1-660" id="h2-1-660" class="i">+  if (ci-&gt;author) {
</a><a href="#h2-1-661" id="h2-1-661" class="i">+    fputs(&quot;&lt;b&gt;Author:&lt;/b&gt; &quot;, fp);
</a><a href="#h2-1-662" id="h2-1-662" class="i">+    xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-663" id="h2-1-663" class="i">+    fputs(&quot; &amp;lt;&lt;a href=\&quot;mailto:&quot;, fp);
</a><a href="#h2-1-664" id="h2-1-664" class="i">+    xmlencode(fp, ci-&gt;author-&gt;email, strlen(ci-&gt;author-&gt;email));
</a><a href="#h2-1-665" id="h2-1-665" class="i">+    fputs(&quot;\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-666" id="h2-1-666" class="i">+    xmlencode(fp, ci-&gt;author-&gt;email, strlen(ci-&gt;author-&gt;email));
</a><a href="#h2-1-667" id="h2-1-667" class="i">+    fputs(&quot;&lt;/a&gt;&amp;gt;\n&lt;b&gt;Date:&lt;/b&gt;   &quot;, fp);
</a><a href="#h2-1-668" id="h2-1-668" class="i">+    printtime(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-669" id="h2-1-669" class="i">+    fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-670" id="h2-1-670" class="i">+  }
</a><a href="#h2-1-671" id="h2-1-671" class="i">+  if (ci-&gt;msg) {
</a><a href="#h2-1-672" id="h2-1-672" class="i">+    fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-673" id="h2-1-673" class="i">+    xmlencode(fp, ci-&gt;msg, strlen(ci-&gt;msg));
</a><a href="#h2-1-674" id="h2-1-674" class="i">+    fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-675" id="h2-1-675" class="i">+  }
</a> }
 
 void
 printshowfile(FILE *fp, struct commitinfo *ci)
 {
<a href="#h2-1-681" id="h2-1-681" class="d">-	const git_diff_delta *delta;
</a><a href="#h2-1-682" id="h2-1-682" class="d">-	const git_diff_hunk *hunk;
</a><a href="#h2-1-683" id="h2-1-683" class="d">-	const git_diff_line *line;
</a><a href="#h2-1-684" id="h2-1-684" class="d">-	git_patch *patch;
</a><a href="#h2-1-685" id="h2-1-685" class="d">-	size_t nhunks, nhunklines, changed, add, del, total, i, j, k;
</a><a href="#h2-1-686" id="h2-1-686" class="d">-	char linestr[80];
</a><a href="#h2-1-687" id="h2-1-687" class="d">-	int c;
</a><a href="#h2-1-688" id="h2-1-688" class="d">-
</a><a href="#h2-1-689" id="h2-1-689" class="d">-	printcommit(fp, ci);
</a><a href="#h2-1-690" id="h2-1-690" class="d">-
</a><a href="#h2-1-691" id="h2-1-691" class="d">-	if (!ci-&gt;deltas)
</a><a href="#h2-1-692" id="h2-1-692" class="d">-		return;
</a><a href="#h2-1-693" id="h2-1-693" class="d">-
</a><a href="#h2-1-694" id="h2-1-694" class="d">-	if (ci-&gt;filecount &gt; 1000   ||
</a><a href="#h2-1-695" id="h2-1-695" class="d">-	    ci-&gt;ndeltas   &gt; 1000   ||
</a><a href="#h2-1-696" id="h2-1-696" class="d">-	    ci-&gt;addcount  &gt; 100000 ||
</a><a href="#h2-1-697" id="h2-1-697" class="d">-	    ci-&gt;delcount  &gt; 100000) {
</a><a href="#h2-1-698" id="h2-1-698" class="d">-		fputs(&quot;Diff is too large, output suppressed.\n&quot;, fp);
</a><a href="#h2-1-699" id="h2-1-699" class="d">-		return;
</a><a href="#h2-1-700" id="h2-1-700" class="d">-	}
</a><a href="#h2-1-701" id="h2-1-701" class="d">-
</a><a href="#h2-1-702" id="h2-1-702" class="d">-	/* diff stat */
</a><a href="#h2-1-703" id="h2-1-703" class="d">-	fputs(&quot;&lt;b&gt;Diffstat:&lt;/b&gt;\n&lt;table&gt;&quot;, fp);
</a><a href="#h2-1-704" id="h2-1-704" class="d">-	for (i = 0; i &lt; ci-&gt;ndeltas; i++) {
</a><a href="#h2-1-705" id="h2-1-705" class="d">-		delta = git_patch_get_delta(ci-&gt;deltas[i]-&gt;patch);
</a><a href="#h2-1-706" id="h2-1-706" class="d">-
</a><a href="#h2-1-707" id="h2-1-707" class="d">-		switch (delta-&gt;status) {
</a><a href="#h2-1-708" id="h2-1-708" class="d">-		case GIT_DELTA_ADDED:      c = &#39;A&#39;; break;
</a><a href="#h2-1-709" id="h2-1-709" class="d">-		case GIT_DELTA_COPIED:     c = &#39;C&#39;; break;
</a><a href="#h2-1-710" id="h2-1-710" class="d">-		case GIT_DELTA_DELETED:    c = &#39;D&#39;; break;
</a><a href="#h2-1-711" id="h2-1-711" class="d">-		case GIT_DELTA_MODIFIED:   c = &#39;M&#39;; break;
</a><a href="#h2-1-712" id="h2-1-712" class="d">-		case GIT_DELTA_RENAMED:    c = &#39;R&#39;; break;
</a><a href="#h2-1-713" id="h2-1-713" class="d">-		case GIT_DELTA_TYPECHANGE: c = &#39;T&#39;; break;
</a><a href="#h2-1-714" id="h2-1-714" class="d">-		default:                   c = &#39; &#39;; break;
</a><a href="#h2-1-715" id="h2-1-715" class="d">-		}
</a><a href="#h2-1-716" id="h2-1-716" class="d">-		if (c == &#39; &#39;)
</a><a href="#h2-1-717" id="h2-1-717" class="d">-			fprintf(fp, &quot;&lt;tr&gt;&lt;td&gt;%c&quot;, c);
</a><a href="#h2-1-718" id="h2-1-718" class="d">-		else
</a><a href="#h2-1-719" id="h2-1-719" class="d">-			fprintf(fp, &quot;&lt;tr&gt;&lt;td class=\&quot;%c\&quot;&gt;%c&quot;, c, c);
</a><a href="#h2-1-720" id="h2-1-720" class="d">-
</a><a href="#h2-1-721" id="h2-1-721" class="d">-		fprintf(fp, &quot;&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;#h%zu\&quot;&gt;&quot;, i);
</a><a href="#h2-1-722" id="h2-1-722" class="d">-		xmlencode(fp, delta-&gt;old_file.path, strlen(delta-&gt;old_file.path));
</a><a href="#h2-1-723" id="h2-1-723" class="d">-		if (strcmp(delta-&gt;old_file.path, delta-&gt;new_file.path)) {
</a><a href="#h2-1-724" id="h2-1-724" class="d">-			fputs(&quot; -&amp;gt; &quot;, fp);
</a><a href="#h2-1-725" id="h2-1-725" class="d">-			xmlencode(fp, delta-&gt;new_file.path, strlen(delta-&gt;new_file.path));
</a><a href="#h2-1-726" id="h2-1-726" class="d">-		}
</a><a href="#h2-1-727" id="h2-1-727" class="d">-
</a><a href="#h2-1-728" id="h2-1-728" class="d">-		add = ci-&gt;deltas[i]-&gt;addcount;
</a><a href="#h2-1-729" id="h2-1-729" class="d">-		del = ci-&gt;deltas[i]-&gt;delcount;
</a><a href="#h2-1-730" id="h2-1-730" class="d">-		changed = add + del;
</a><a href="#h2-1-731" id="h2-1-731" class="d">-		total = sizeof(linestr) - 2;
</a><a href="#h2-1-732" id="h2-1-732" class="d">-		if (changed &gt; total) {
</a><a href="#h2-1-733" id="h2-1-733" class="d">-			if (add)
</a><a href="#h2-1-734" id="h2-1-734" class="d">-				add = ((float)total / changed * add) + 1;
</a><a href="#h2-1-735" id="h2-1-735" class="d">-			if (del)
</a><a href="#h2-1-736" id="h2-1-736" class="d">-				del = ((float)total / changed * del) + 1;
</a><a href="#h2-1-737" id="h2-1-737" class="d">-		}
</a><a href="#h2-1-738" id="h2-1-738" class="d">-		memset(&amp;linestr, &#39;+&#39;, add);
</a><a href="#h2-1-739" id="h2-1-739" class="d">-		memset(&amp;linestr[add], &#39;-&#39;, del);
</a><a href="#h2-1-740" id="h2-1-740" class="d">-
</a><a href="#h2-1-741" id="h2-1-741" class="d">-		fprintf(fp, &quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt; | &lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;%zu&lt;/td&gt;&lt;td&gt;&lt;span class=\&quot;i\&quot;&gt;&quot;,
</a><a href="#h2-1-742" id="h2-1-742" class="d">-		        ci-&gt;deltas[i]-&gt;addcount + ci-&gt;deltas[i]-&gt;delcount);
</a><a href="#h2-1-743" id="h2-1-743" class="d">-		fwrite(&amp;linestr, 1, add, fp);
</a><a href="#h2-1-744" id="h2-1-744" class="d">-		fputs(&quot;&lt;/span&gt;&lt;span class=\&quot;d\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-745" id="h2-1-745" class="d">-		fwrite(&amp;linestr[add], 1, del, fp);
</a><a href="#h2-1-746" id="h2-1-746" class="d">-		fputs(&quot;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-747" id="h2-1-747" class="d">-	}
</a><a href="#h2-1-748" id="h2-1-748" class="d">-	fprintf(fp, &quot;&lt;/table&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;%zu file%s changed, %zu insertion%s(&lt;span id=\&quot;plus\&quot;&gt;+&lt;/span&gt;)&quot;
</a><a href="#h2-1-749" id="h2-1-749" class="d">-		&quot;, %zu deletion%s(&lt;span id=\&quot;min\&quot;&gt;-&lt;/span&gt;)&lt;/p&gt;\n&quot;,
</a><a href="#h2-1-750" id="h2-1-750" class="d">-					ci-&gt;filecount, ci-&gt;filecount == 1 ? &quot;&quot; : &quot;s&quot;,
</a><a href="#h2-1-751" id="h2-1-751" class="d">-	        ci-&gt;addcount,  ci-&gt;addcount  == 1 ? &quot;&quot; : &quot;s&quot;,
</a><a href="#h2-1-752" id="h2-1-752" class="d">-	        ci-&gt;delcount,  ci-&gt;delcount  == 1 ? &quot;&quot; : &quot;s&quot;);
</a><a href="#h2-1-753" id="h2-1-753" class="d">-
</a><a href="#h2-1-754" id="h2-1-754" class="d">-	fputs(&quot;&lt;div id=\&quot;pre-scroll\&quot;&gt;\n&lt;pre&gt;\n&quot;, fp);
</a><a href="#h2-1-755" id="h2-1-755" class="d">-
</a><a href="#h2-1-756" id="h2-1-756" class="d">-	for (i = 0; i &lt; ci-&gt;ndeltas; i++) {
</a><a href="#h2-1-757" id="h2-1-757" class="d">-		patch = ci-&gt;deltas[i]-&gt;patch;
</a><a href="#h2-1-758" id="h2-1-758" class="d">-		delta = git_patch_get_delta(patch);
</a><a href="#h2-1-759" id="h2-1-759" class="d">-		fprintf(fp, &quot;&lt;b&gt;diff --git a/&lt;a id=\&quot;h%zu\&quot; href=\&quot;%sfile/&quot;, i, relpath);
</a><a href="#h2-1-760" id="h2-1-760" class="d">-		xmlencode(fp, delta-&gt;old_file.path, strlen(delta-&gt;old_file.path));
</a><a href="#h2-1-761" id="h2-1-761" class="d">-		fputs(&quot;.html\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-762" id="h2-1-762" class="d">-		xmlencode(fp, delta-&gt;old_file.path, strlen(delta-&gt;old_file.path));
</a><a href="#h2-1-763" id="h2-1-763" class="d">-		fprintf(fp, &quot;&lt;/a&gt; b/&lt;a href=\&quot;%sfile/&quot;, relpath);
</a><a href="#h2-1-764" id="h2-1-764" class="d">-		xmlencode(fp, delta-&gt;new_file.path, strlen(delta-&gt;new_file.path));
</a><a href="#h2-1-765" id="h2-1-765" class="d">-		fprintf(fp, &quot;.html\&quot;&gt;&quot;);
</a><a href="#h2-1-766" id="h2-1-766" class="d">-		xmlencode(fp, delta-&gt;new_file.path, strlen(delta-&gt;new_file.path));
</a><a href="#h2-1-767" id="h2-1-767" class="d">-		fprintf(fp, &quot;&lt;/a&gt;&lt;/b&gt;\n&quot;);
</a><a href="#h2-1-768" id="h2-1-768" class="d">-
</a><a href="#h2-1-769" id="h2-1-769" class="d">-		/* check binary data */
</a><a href="#h2-1-770" id="h2-1-770" class="d">-		if (delta-&gt;flags &amp; GIT_DIFF_FLAG_BINARY) {
</a><a href="#h2-1-771" id="h2-1-771" class="d">-			fputs(&quot;Binary files differ.\n&quot;, fp);
</a><a href="#h2-1-772" id="h2-1-772" class="d">-			continue;
</a><a href="#h2-1-773" id="h2-1-773" class="d">-		}
</a><a href="#h2-1-774" id="h2-1-774" class="d">-
</a><a href="#h2-1-775" id="h2-1-775" class="d">-		nhunks = git_patch_num_hunks(patch);
</a><a href="#h2-1-776" id="h2-1-776" class="d">-		for (j = 0; j &lt; nhunks; j++) {
</a><a href="#h2-1-777" id="h2-1-777" class="d">-			if (git_patch_get_hunk(&amp;hunk, &amp;nhunklines, patch, j))
</a><a href="#h2-1-778" id="h2-1-778" class="d">-				break;
</a><a href="#h2-1-779" id="h2-1-779" class="d">-
</a><a href="#h2-1-780" id="h2-1-780" class="d">-			fprintf(fp, &quot;&lt;a href=\&quot;#h%zu-%zu\&quot; id=\&quot;h%zu-%zu\&quot; class=\&quot;h\&quot;&gt;&quot;, i, j, i, j);
</a><a href="#h2-1-781" id="h2-1-781" class="d">-			xmlencode(fp, hunk-&gt;header, hunk-&gt;header_len);
</a><a href="#h2-1-782" id="h2-1-782" class="d">-			fputs(&quot;&lt;/a&gt;&quot;, fp);
</a><a href="#h2-1-783" id="h2-1-783" class="d">-
</a><a href="#h2-1-784" id="h2-1-784" class="d">-			for (k = 0; ; k++) {
</a><a href="#h2-1-785" id="h2-1-785" class="d">-				if (git_patch_get_line_in_hunk(&amp;line, patch, j, k))
</a><a href="#h2-1-786" id="h2-1-786" class="d">-					break;
</a><a href="#h2-1-787" id="h2-1-787" class="d">-				if (line-&gt;old_lineno == -1)
</a><a href="#h2-1-788" id="h2-1-788" class="d">-					fprintf(fp, &quot;&lt;a href=\&quot;#h%zu-%zu-%zu\&quot; id=\&quot;h%zu-%zu-%zu\&quot; class=\&quot;i\&quot;&gt;+&quot;,
</a><a href="#h2-1-789" id="h2-1-789" class="d">-						i, j, k, i, j, k);
</a><a href="#h2-1-790" id="h2-1-790" class="d">-				else if (line-&gt;new_lineno == -1)
</a><a href="#h2-1-791" id="h2-1-791" class="d">-					fprintf(fp, &quot;&lt;a href=\&quot;#h%zu-%zu-%zu\&quot; id=\&quot;h%zu-%zu-%zu\&quot; class=\&quot;d\&quot;&gt;-&quot;,
</a><a href="#h2-1-792" id="h2-1-792" class="d">-						i, j, k, i, j, k);
</a><a href="#h2-1-793" id="h2-1-793" class="d">-				else
</a><a href="#h2-1-794" id="h2-1-794" class="d">-					fputc(&#39; &#39;, fp);
</a><a href="#h2-1-795" id="h2-1-795" class="d">-				xmlencode(fp, line-&gt;content, line-&gt;content_len);
</a><a href="#h2-1-796" id="h2-1-796" class="d">-				if (line-&gt;old_lineno == -1 || line-&gt;new_lineno == -1)
</a><a href="#h2-1-797" id="h2-1-797" class="d">-					fputs(&quot;&lt;/a&gt;&quot;, fp);
</a><a href="#h2-1-798" id="h2-1-798" class="d">-			}
</a><a href="#h2-1-799" id="h2-1-799" class="d">-		}
</a><a href="#h2-1-800" id="h2-1-800" class="d">-	}
</a><a href="#h2-1-801" id="h2-1-801" class="i">+  const git_diff_delta *delta;
</a><a href="#h2-1-802" id="h2-1-802" class="i">+  const git_diff_hunk *hunk;
</a><a href="#h2-1-803" id="h2-1-803" class="i">+  const git_diff_line *line;
</a><a href="#h2-1-804" id="h2-1-804" class="i">+  git_patch *patch;
</a><a href="#h2-1-805" id="h2-1-805" class="i">+  size_t nhunks, nhunklines, changed, add, del, total, i, j, k;
</a><a href="#h2-1-806" id="h2-1-806" class="i">+  char linestr[80];
</a><a href="#h2-1-807" id="h2-1-807" class="i">+  int c;
</a><a href="#h2-1-808" id="h2-1-808" class="i">+
</a><a href="#h2-1-809" id="h2-1-809" class="i">+  printcommit(fp, ci);
</a><a href="#h2-1-810" id="h2-1-810" class="i">+
</a><a href="#h2-1-811" id="h2-1-811" class="i">+  if (!ci-&gt;deltas)
</a><a href="#h2-1-812" id="h2-1-812" class="i">+    return;
</a><a href="#h2-1-813" id="h2-1-813" class="i">+
</a><a href="#h2-1-814" id="h2-1-814" class="i">+  if (ci-&gt;filecount &gt; 1000   ||
</a><a href="#h2-1-815" id="h2-1-815" class="i">+      ci-&gt;ndeltas   &gt; 1000   ||
</a><a href="#h2-1-816" id="h2-1-816" class="i">+      ci-&gt;addcount  &gt; 100000 ||
</a><a href="#h2-1-817" id="h2-1-817" class="i">+      ci-&gt;delcount  &gt; 100000) {
</a><a href="#h2-1-818" id="h2-1-818" class="i">+    fputs(&quot;Diff is too large, output suppressed.\n&quot;, fp);
</a><a href="#h2-1-819" id="h2-1-819" class="i">+    return;
</a><a href="#h2-1-820" id="h2-1-820" class="i">+  }
</a><a href="#h2-1-821" id="h2-1-821" class="i">+
</a><a href="#h2-1-822" id="h2-1-822" class="i">+  /* diff stat */
</a><a href="#h2-1-823" id="h2-1-823" class="i">+  fputs(&quot;&lt;b&gt;Diffstat:&lt;/b&gt;\n&lt;table&gt;&quot;, fp);
</a><a href="#h2-1-824" id="h2-1-824" class="i">+  for (i = 0; i &lt; ci-&gt;ndeltas; i++) {
</a><a href="#h2-1-825" id="h2-1-825" class="i">+    delta = git_patch_get_delta(ci-&gt;deltas[i]-&gt;patch);
</a><a href="#h2-1-826" id="h2-1-826" class="i">+
</a><a href="#h2-1-827" id="h2-1-827" class="i">+    switch (delta-&gt;status) {
</a><a href="#h2-1-828" id="h2-1-828" class="i">+    case GIT_DELTA_ADDED:      c = &#39;A&#39;; break;
</a><a href="#h2-1-829" id="h2-1-829" class="i">+    case GIT_DELTA_COPIED:     c = &#39;C&#39;; break;
</a><a href="#h2-1-830" id="h2-1-830" class="i">+    case GIT_DELTA_DELETED:    c = &#39;D&#39;; break;
</a><a href="#h2-1-831" id="h2-1-831" class="i">+    case GIT_DELTA_MODIFIED:   c = &#39;M&#39;; break;
</a><a href="#h2-1-832" id="h2-1-832" class="i">+    case GIT_DELTA_RENAMED:    c = &#39;R&#39;; break;
</a><a href="#h2-1-833" id="h2-1-833" class="i">+    case GIT_DELTA_TYPECHANGE: c = &#39;T&#39;; break;
</a><a href="#h2-1-834" id="h2-1-834" class="i">+    default:                   c = &#39; &#39;; break;
</a><a href="#h2-1-835" id="h2-1-835" class="i">+    }
</a><a href="#h2-1-836" id="h2-1-836" class="i">+    if (c == &#39; &#39;)
</a><a href="#h2-1-837" id="h2-1-837" class="i">+      fprintf(fp, &quot;&lt;tr&gt;&lt;td&gt;%c&quot;, c);
</a><a href="#h2-1-838" id="h2-1-838" class="i">+    else
</a><a href="#h2-1-839" id="h2-1-839" class="i">+      fprintf(fp, &quot;&lt;tr&gt;&lt;td class=\&quot;%c\&quot;&gt;%c&quot;, c, c);
</a><a href="#h2-1-840" id="h2-1-840" class="i">+
</a><a href="#h2-1-841" id="h2-1-841" class="i">+    fprintf(fp, &quot;&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;#h%zu\&quot;&gt;&quot;, i);
</a><a href="#h2-1-842" id="h2-1-842" class="i">+    xmlencode(fp, delta-&gt;old_file.path, strlen(delta-&gt;old_file.path));
</a><a href="#h2-1-843" id="h2-1-843" class="i">+    if (strcmp(delta-&gt;old_file.path, delta-&gt;new_file.path)) {
</a><a href="#h2-1-844" id="h2-1-844" class="i">+      fputs(&quot; -&amp;gt; &quot;, fp);
</a><a href="#h2-1-845" id="h2-1-845" class="i">+      xmlencode(fp, delta-&gt;new_file.path, strlen(delta-&gt;new_file.path));
</a><a href="#h2-1-846" id="h2-1-846" class="i">+    }
</a><a href="#h2-1-847" id="h2-1-847" class="i">+
</a><a href="#h2-1-848" id="h2-1-848" class="i">+    add = ci-&gt;deltas[i]-&gt;addcount;
</a><a href="#h2-1-849" id="h2-1-849" class="i">+    del = ci-&gt;deltas[i]-&gt;delcount;
</a><a href="#h2-1-850" id="h2-1-850" class="i">+    changed = add + del;
</a><a href="#h2-1-851" id="h2-1-851" class="i">+    total = sizeof(linestr) - 2;
</a><a href="#h2-1-852" id="h2-1-852" class="i">+    if (changed &gt; total) {
</a><a href="#h2-1-853" id="h2-1-853" class="i">+      if (add)
</a><a href="#h2-1-854" id="h2-1-854" class="i">+        add = ((float)total / changed * add) + 1;
</a><a href="#h2-1-855" id="h2-1-855" class="i">+      if (del)
</a><a href="#h2-1-856" id="h2-1-856" class="i">+        del = ((float)total / changed * del) + 1;
</a><a href="#h2-1-857" id="h2-1-857" class="i">+    }
</a><a href="#h2-1-858" id="h2-1-858" class="i">+    memset(&amp;linestr, &#39;+&#39;, add);
</a><a href="#h2-1-859" id="h2-1-859" class="i">+    memset(&amp;linestr[add], &#39;-&#39;, del);
</a><a href="#h2-1-860" id="h2-1-860" class="i">+
</a><a href="#h2-1-861" id="h2-1-861" class="i">+    fprintf(fp, &quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt; | &lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;%zu&lt;/td&gt;&lt;td&gt;&lt;span class=\&quot;i\&quot;&gt;&quot;,
</a><a href="#h2-1-862" id="h2-1-862" class="i">+            ci-&gt;deltas[i]-&gt;addcount + ci-&gt;deltas[i]-&gt;delcount);
</a><a href="#h2-1-863" id="h2-1-863" class="i">+    fwrite(&amp;linestr, 1, add, fp);
</a><a href="#h2-1-864" id="h2-1-864" class="i">+    fputs(&quot;&lt;/span&gt;&lt;span class=\&quot;d\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-865" id="h2-1-865" class="i">+    fwrite(&amp;linestr[add], 1, del, fp);
</a><a href="#h2-1-866" id="h2-1-866" class="i">+    fputs(&quot;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-867" id="h2-1-867" class="i">+  }
</a><a href="#h2-1-868" id="h2-1-868" class="i">+  fprintf(fp, &quot;&lt;/table&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;%zu file%s changed, %zu insertion%s(&lt;span id=\&quot;plus\&quot;&gt;+&lt;/span&gt;)&quot;
</a><a href="#h2-1-869" id="h2-1-869" class="i">+    &quot;, %zu deletion%s(&lt;span id=\&quot;min\&quot;&gt;-&lt;/span&gt;)&lt;/p&gt;\n&quot;,
</a><a href="#h2-1-870" id="h2-1-870" class="i">+          ci-&gt;filecount, ci-&gt;filecount == 1 ? &quot;&quot; : &quot;s&quot;,
</a><a href="#h2-1-871" id="h2-1-871" class="i">+          ci-&gt;addcount,  ci-&gt;addcount  == 1 ? &quot;&quot; : &quot;s&quot;,
</a><a href="#h2-1-872" id="h2-1-872" class="i">+          ci-&gt;delcount,  ci-&gt;delcount  == 1 ? &quot;&quot; : &quot;s&quot;);
</a><a href="#h2-1-873" id="h2-1-873" class="i">+
</a><a href="#h2-1-874" id="h2-1-874" class="i">+  fputs(&quot;&lt;div id=\&quot;pre-scroll\&quot;&gt;\n&lt;pre&gt;\n&quot;, fp);
</a><a href="#h2-1-875" id="h2-1-875" class="i">+
</a><a href="#h2-1-876" id="h2-1-876" class="i">+  for (i = 0; i &lt; ci-&gt;ndeltas; i++) {
</a><a href="#h2-1-877" id="h2-1-877" class="i">+    patch = ci-&gt;deltas[i]-&gt;patch;
</a><a href="#h2-1-878" id="h2-1-878" class="i">+    delta = git_patch_get_delta(patch);
</a><a href="#h2-1-879" id="h2-1-879" class="i">+    fprintf(fp, &quot;&lt;b&gt;diff --git a/&lt;a id=\&quot;h%zu\&quot; href=\&quot;%sfile/&quot;, i, relpath);
</a><a href="#h2-1-880" id="h2-1-880" class="i">+    xmlencode(fp, delta-&gt;old_file.path, strlen(delta-&gt;old_file.path));
</a><a href="#h2-1-881" id="h2-1-881" class="i">+    fputs(&quot;.html\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-882" id="h2-1-882" class="i">+    xmlencode(fp, delta-&gt;old_file.path, strlen(delta-&gt;old_file.path));
</a><a href="#h2-1-883" id="h2-1-883" class="i">+    fprintf(fp, &quot;&lt;/a&gt; b/&lt;a href=\&quot;%sfile/&quot;, relpath);
</a><a href="#h2-1-884" id="h2-1-884" class="i">+    xmlencode(fp, delta-&gt;new_file.path, strlen(delta-&gt;new_file.path));
</a><a href="#h2-1-885" id="h2-1-885" class="i">+    fprintf(fp, &quot;.html\&quot;&gt;&quot;);
</a><a href="#h2-1-886" id="h2-1-886" class="i">+    xmlencode(fp, delta-&gt;new_file.path, strlen(delta-&gt;new_file.path));
</a><a href="#h2-1-887" id="h2-1-887" class="i">+    fprintf(fp, &quot;&lt;/a&gt;&lt;/b&gt;\n&quot;);
</a><a href="#h2-1-888" id="h2-1-888" class="i">+
</a><a href="#h2-1-889" id="h2-1-889" class="i">+    /* check binary data */
</a><a href="#h2-1-890" id="h2-1-890" class="i">+    if (delta-&gt;flags &amp; GIT_DIFF_FLAG_BINARY) {
</a><a href="#h2-1-891" id="h2-1-891" class="i">+      fputs(&quot;Binary files differ.\n&quot;, fp);
</a><a href="#h2-1-892" id="h2-1-892" class="i">+      continue;
</a><a href="#h2-1-893" id="h2-1-893" class="i">+    }
</a><a href="#h2-1-894" id="h2-1-894" class="i">+
</a><a href="#h2-1-895" id="h2-1-895" class="i">+    nhunks = git_patch_num_hunks(patch);
</a><a href="#h2-1-896" id="h2-1-896" class="i">+    for (j = 0; j &lt; nhunks; j++) {
</a><a href="#h2-1-897" id="h2-1-897" class="i">+      if (git_patch_get_hunk(&amp;hunk, &amp;nhunklines, patch, j))
</a><a href="#h2-1-898" id="h2-1-898" class="i">+        break;
</a><a href="#h2-1-899" id="h2-1-899" class="i">+
</a><a href="#h2-1-900" id="h2-1-900" class="i">+      fprintf(fp, &quot;&lt;a href=\&quot;#h%zu-%zu\&quot; id=\&quot;h%zu-%zu\&quot; class=\&quot;h\&quot;&gt;&quot;, i, j, i, j);
</a><a href="#h2-1-901" id="h2-1-901" class="i">+      xmlencode(fp, hunk-&gt;header, hunk-&gt;header_len);
</a><a href="#h2-1-902" id="h2-1-902" class="i">+      fputs(&quot;&lt;/a&gt;&quot;, fp);
</a><a href="#h2-1-903" id="h2-1-903" class="i">+
</a><a href="#h2-1-904" id="h2-1-904" class="i">+      for (k = 0; ; k++) {
</a><a href="#h2-1-905" id="h2-1-905" class="i">+        if (git_patch_get_line_in_hunk(&amp;line, patch, j, k))
</a><a href="#h2-1-906" id="h2-1-906" class="i">+          break;
</a><a href="#h2-1-907" id="h2-1-907" class="i">+        if (line-&gt;old_lineno == -1)
</a><a href="#h2-1-908" id="h2-1-908" class="i">+          fprintf(fp, &quot;&lt;a href=\&quot;#h%zu-%zu-%zu\&quot; id=\&quot;h%zu-%zu-%zu\&quot; class=\&quot;i\&quot;&gt;+&quot;,
</a><a href="#h2-1-909" id="h2-1-909" class="i">+            i, j, k, i, j, k);
</a><a href="#h2-1-910" id="h2-1-910" class="i">+        else if (line-&gt;new_lineno == -1)
</a><a href="#h2-1-911" id="h2-1-911" class="i">+          fprintf(fp, &quot;&lt;a href=\&quot;#h%zu-%zu-%zu\&quot; id=\&quot;h%zu-%zu-%zu\&quot; class=\&quot;d\&quot;&gt;-&quot;,
</a><a href="#h2-1-912" id="h2-1-912" class="i">+            i, j, k, i, j, k);
</a><a href="#h2-1-913" id="h2-1-913" class="i">+        else
</a><a href="#h2-1-914" id="h2-1-914" class="i">+          fputc(&#39; &#39;, fp);
</a><a href="#h2-1-915" id="h2-1-915" class="i">+        xmlencode(fp, line-&gt;content, line-&gt;content_len);
</a><a href="#h2-1-916" id="h2-1-916" class="i">+        if (line-&gt;old_lineno == -1 || line-&gt;new_lineno == -1)
</a><a href="#h2-1-917" id="h2-1-917" class="i">+          fputs(&quot;&lt;/a&gt;&quot;, fp);
</a><a href="#h2-1-918" id="h2-1-918" class="i">+      }
</a><a href="#h2-1-919" id="h2-1-919" class="i">+    }
</a><a href="#h2-1-920" id="h2-1-920" class="i">+  }
</a> }
 
 void
 writelogline(FILE *fp, struct commitinfo *ci)
 {
<a href="#h2-1-926" id="h2-1-926" class="d">-	fprintf(fp, &quot;&lt;tr id=\&quot;%s\&quot;&gt;&quot;
</a><a href="#h2-1-927" id="h2-1-927" class="d">-		&quot;&lt;td&gt;&lt;a href=\&quot;#%s\&quot;&gt;#&lt;/a&gt;&lt;/td&gt;&quot;
</a><a href="#h2-1-928" id="h2-1-928" class="d">-		&quot;&lt;td&gt;&quot;, ci-&gt;oid, ci-&gt;oid);
</a><a href="#h2-1-929" id="h2-1-929" class="d">-	if (ci-&gt;author)
</a><a href="#h2-1-930" id="h2-1-930" class="d">-		printtimeshort(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-931" id="h2-1-931" class="d">-	fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-932" id="h2-1-932" class="d">-	if (ci-&gt;summary) {
</a><a href="#h2-1-933" id="h2-1-933" class="d">-		fprintf(fp, &quot;&lt;a href=\&quot;%scommit/%s.html\&quot;&gt;&quot;, relpath, ci-&gt;oid);
</a><a href="#h2-1-934" id="h2-1-934" class="d">-		xmlencode(fp, ci-&gt;summary, strlen(ci-&gt;summary));
</a><a href="#h2-1-935" id="h2-1-935" class="d">-		fputs(&quot;&lt;/a&gt;&quot;, fp);
</a><a href="#h2-1-936" id="h2-1-936" class="d">-	}
</a><a href="#h2-1-937" id="h2-1-937" class="d">-	fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-938" id="h2-1-938" class="d">-	if (ci-&gt;author)
</a><a href="#h2-1-939" id="h2-1-939" class="d">-		xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-940" id="h2-1-940" class="d">-	fputs(&quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-941" id="h2-1-941" class="d">-	fprintf(fp, &quot;%zu&quot;, ci-&gt;filecount);
</a><a href="#h2-1-942" id="h2-1-942" class="d">-	fputs(&quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-943" id="h2-1-943" class="d">-	fprintf(fp, &quot;+%zu&quot;, ci-&gt;addcount);
</a><a href="#h2-1-944" id="h2-1-944" class="d">-	fputs(&quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-945" id="h2-1-945" class="d">-	fprintf(fp, &quot;-%zu&quot;, ci-&gt;delcount);
</a><a href="#h2-1-946" id="h2-1-946" class="d">-	fputs(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-947" id="h2-1-947" class="i">+  fprintf(fp, &quot;&lt;tr id=\&quot;%s\&quot;&gt;&quot;
</a><a href="#h2-1-948" id="h2-1-948" class="i">+    &quot;&lt;td&gt;&lt;a href=\&quot;#%s\&quot;&gt;#&lt;/a&gt;&lt;/td&gt;&quot;
</a><a href="#h2-1-949" id="h2-1-949" class="i">+    &quot;&lt;td&gt;&quot;, ci-&gt;oid, ci-&gt;oid);
</a><a href="#h2-1-950" id="h2-1-950" class="i">+  if (ci-&gt;author)
</a><a href="#h2-1-951" id="h2-1-951" class="i">+    printtimeshort(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-952" id="h2-1-952" class="i">+  fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-953" id="h2-1-953" class="i">+  if (ci-&gt;summary) {
</a><a href="#h2-1-954" id="h2-1-954" class="i">+    fprintf(fp, &quot;&lt;a href=\&quot;%scommit/%s.html\&quot;&gt;&quot;, relpath, ci-&gt;oid);
</a><a href="#h2-1-955" id="h2-1-955" class="i">+    xmlencode(fp, ci-&gt;summary, strlen(ci-&gt;summary));
</a><a href="#h2-1-956" id="h2-1-956" class="i">+    fputs(&quot;&lt;/a&gt;&quot;, fp);
</a><a href="#h2-1-957" id="h2-1-957" class="i">+  }
</a><a href="#h2-1-958" id="h2-1-958" class="i">+  fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-959" id="h2-1-959" class="i">+  if (ci-&gt;author)
</a><a href="#h2-1-960" id="h2-1-960" class="i">+    xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-961" id="h2-1-961" class="i">+  fputs(&quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-962" id="h2-1-962" class="i">+  fprintf(fp, &quot;%zu&quot;, ci-&gt;filecount);
</a><a href="#h2-1-963" id="h2-1-963" class="i">+  fputs(&quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-964" id="h2-1-964" class="i">+  fprintf(fp, &quot;+%zu&quot;, ci-&gt;addcount);
</a><a href="#h2-1-965" id="h2-1-965" class="i">+  fputs(&quot;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-966" id="h2-1-966" class="i">+  fprintf(fp, &quot;-%zu&quot;, ci-&gt;delcount);
</a><a href="#h2-1-967" id="h2-1-967" class="i">+  fputs(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a> }
 
 int
 writelog(FILE *fp, const git_oid *oid)
 {
<a href="#h2-1-973" id="h2-1-973" class="d">-	struct commitinfo *ci;
</a><a href="#h2-1-974" id="h2-1-974" class="d">-	git_revwalk *w = NULL;
</a><a href="#h2-1-975" id="h2-1-975" class="d">-	git_oid id;
</a><a href="#h2-1-976" id="h2-1-976" class="d">-	char path[PATH_MAX], oidstr[GIT_OID_HEXSZ + 1];
</a><a href="#h2-1-977" id="h2-1-977" class="d">-	FILE *fpfile;
</a><a href="#h2-1-978" id="h2-1-978" class="d">-	int r;
</a><a href="#h2-1-979" id="h2-1-979" class="d">-
</a><a href="#h2-1-980" id="h2-1-980" class="d">-	git_revwalk_new(&amp;w, repo);
</a><a href="#h2-1-981" id="h2-1-981" class="d">-	git_revwalk_push(w, oid);
</a><a href="#h2-1-982" id="h2-1-982" class="d">-	git_revwalk_simplify_first_parent(w);
</a><a href="#h2-1-983" id="h2-1-983" class="d">-
</a><a href="#h2-1-984" id="h2-1-984" class="d">-	while (!git_revwalk_next(&amp;id, w)) {
</a><a href="#h2-1-985" id="h2-1-985" class="d">-		relpath = &quot;&quot;;
</a><a href="#h2-1-986" id="h2-1-986" class="d">-
</a><a href="#h2-1-987" id="h2-1-987" class="d">-		if (cachefile &amp;&amp; !memcmp(&amp;id, &amp;lastoid, sizeof(id)))
</a><a href="#h2-1-988" id="h2-1-988" class="d">-			break;
</a><a href="#h2-1-989" id="h2-1-989" class="d">-
</a><a href="#h2-1-990" id="h2-1-990" class="d">-		git_oid_tostr(oidstr, sizeof(oidstr), &amp;id);
</a><a href="#h2-1-991" id="h2-1-991" class="d">-		r = snprintf(path, sizeof(path), &quot;commit/%s.html&quot;, oidstr);
</a><a href="#h2-1-992" id="h2-1-992" class="d">-		if (r &lt; 0 || (size_t)r &gt;= sizeof(path))
</a><a href="#h2-1-993" id="h2-1-993" class="d">-			errx(1, &quot;path truncated: &#39;commit/%s.html&#39;&quot;, oidstr);
</a><a href="#h2-1-994" id="h2-1-994" class="d">-		r = access(path, F_OK);
</a><a href="#h2-1-995" id="h2-1-995" class="d">-
</a><a href="#h2-1-996" id="h2-1-996" class="d">-		/* optimization: if there are no log lines to write and
</a><a href="#h2-1-997" id="h2-1-997" class="d">-		   the commit file already exists: skip the diffstat */
</a><a href="#h2-1-998" id="h2-1-998" class="d">-		if (!nlogcommits &amp;&amp; !r)
</a><a href="#h2-1-999" id="h2-1-999" class="d">-			continue;
</a><a href="#h2-1-1000" id="h2-1-1000" class="d">-
</a><a href="#h2-1-1001" id="h2-1-1001" class="d">-		if (!(ci = commitinfo_getbyoid(&amp;id)))
</a><a href="#h2-1-1002" id="h2-1-1002" class="d">-			break;
</a><a href="#h2-1-1003" id="h2-1-1003" class="d">-		/* diffstat: for stagit HTML required for the index.html line */
</a><a href="#h2-1-1004" id="h2-1-1004" class="d">-		if (commitinfo_getstats(ci) == -1)
</a><a href="#h2-1-1005" id="h2-1-1005" class="d">-			goto err;
</a><a href="#h2-1-1006" id="h2-1-1006" class="d">-
</a><a href="#h2-1-1007" id="h2-1-1007" class="d">-		if (nlogcommits &lt; 0) {
</a><a href="#h2-1-1008" id="h2-1-1008" class="d">-			writelogline(fp, ci);
</a><a href="#h2-1-1009" id="h2-1-1009" class="d">-		} else if (nlogcommits &gt; 0) {
</a><a href="#h2-1-1010" id="h2-1-1010" class="d">-			writelogline(fp, ci);
</a><a href="#h2-1-1011" id="h2-1-1011" class="d">-			nlogcommits--;
</a><a href="#h2-1-1012" id="h2-1-1012" class="d">-			if (!nlogcommits &amp;&amp; ci-&gt;parentoid[0])
</a><a href="#h2-1-1013" id="h2-1-1013" class="d">-				fputs(&quot;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td colspan=\&quot;5\&quot;&gt;&quot;
</a><a href="#h2-1-1014" id="h2-1-1014" class="d">-				      &quot;More commits remaining [...]&lt;/td&gt;&quot;
</a><a href="#h2-1-1015" id="h2-1-1015" class="d">-				      &quot;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-1016" id="h2-1-1016" class="d">-		}
</a><a href="#h2-1-1017" id="h2-1-1017" class="d">-
</a><a href="#h2-1-1018" id="h2-1-1018" class="d">-		if (cachefile)
</a><a href="#h2-1-1019" id="h2-1-1019" class="d">-			writelogline(wcachefp, ci);
</a><a href="#h2-1-1020" id="h2-1-1020" class="d">-
</a><a href="#h2-1-1021" id="h2-1-1021" class="d">-		/* check if file exists if so skip it */
</a><a href="#h2-1-1022" id="h2-1-1022" class="d">-		if (r) {
</a><a href="#h2-1-1023" id="h2-1-1023" class="d">-			relpath = &quot;../&quot;;
</a><a href="#h2-1-1024" id="h2-1-1024" class="d">-			fpfile = efopen(path, &quot;w&quot;);
</a><a href="#h2-1-1025" id="h2-1-1025" class="d">-			writeheader(fpfile, ci-&gt;summary);
</a><a href="#h2-1-1026" id="h2-1-1026" class="d">-			fputs(&quot;&lt;div id=\&quot;pre-scroll\&quot;&gt;\n&lt;pre&gt;&quot;, fpfile);
</a><a href="#h2-1-1027" id="h2-1-1027" class="d">-			printshowfile(fpfile, ci);
</a><a href="#h2-1-1028" id="h2-1-1028" class="d">-			fputs(&quot;&lt;/pre&gt;\n&lt;/div&gt;\n&quot;, fpfile);
</a><a href="#h2-1-1029" id="h2-1-1029" class="d">-			writefooter(fpfile);
</a><a href="#h2-1-1030" id="h2-1-1030" class="d">-			fclose(fpfile);
</a><a href="#h2-1-1031" id="h2-1-1031" class="d">-		}
</a><a href="#h2-1-1032" id="h2-1-1032" class="i">+  struct commitinfo *ci;
</a><a href="#h2-1-1033" id="h2-1-1033" class="i">+  git_revwalk *w = NULL;
</a><a href="#h2-1-1034" id="h2-1-1034" class="i">+  git_oid id;
</a><a href="#h2-1-1035" id="h2-1-1035" class="i">+  char path[PATH_MAX], oidstr[GIT_OID_HEXSZ + 1];
</a><a href="#h2-1-1036" id="h2-1-1036" class="i">+  FILE *fpfile;
</a><a href="#h2-1-1037" id="h2-1-1037" class="i">+  int r;
</a><a href="#h2-1-1038" id="h2-1-1038" class="i">+
</a><a href="#h2-1-1039" id="h2-1-1039" class="i">+  git_revwalk_new(&amp;w, repo);
</a><a href="#h2-1-1040" id="h2-1-1040" class="i">+  git_revwalk_push(w, oid);
</a><a href="#h2-1-1041" id="h2-1-1041" class="i">+  git_revwalk_simplify_first_parent(w);
</a><a href="#h2-1-1042" id="h2-1-1042" class="i">+
</a><a href="#h2-1-1043" id="h2-1-1043" class="i">+  while (!git_revwalk_next(&amp;id, w)) {
</a><a href="#h2-1-1044" id="h2-1-1044" class="i">+    relpath = &quot;&quot;;
</a><a href="#h2-1-1045" id="h2-1-1045" class="i">+
</a><a href="#h2-1-1046" id="h2-1-1046" class="i">+    if (cachefile &amp;&amp; !memcmp(&amp;id, &amp;lastoid, sizeof(id)))
</a><a href="#h2-1-1047" id="h2-1-1047" class="i">+      break;
</a><a href="#h2-1-1048" id="h2-1-1048" class="i">+
</a><a href="#h2-1-1049" id="h2-1-1049" class="i">+    git_oid_tostr(oidstr, sizeof(oidstr), &amp;id);
</a><a href="#h2-1-1050" id="h2-1-1050" class="i">+    r = snprintf(path, sizeof(path), &quot;commit/%s.html&quot;, oidstr);
</a><a href="#h2-1-1051" id="h2-1-1051" class="i">+    if (r &lt; 0 || (size_t)r &gt;= sizeof(path))
</a><a href="#h2-1-1052" id="h2-1-1052" class="i">+      errx(1, &quot;path truncated: &#39;commit/%s.html&#39;&quot;, oidstr);
</a><a href="#h2-1-1053" id="h2-1-1053" class="i">+    r = access(path, F_OK);
</a><a href="#h2-1-1054" id="h2-1-1054" class="i">+
</a><a href="#h2-1-1055" id="h2-1-1055" class="i">+    /* optimization: if there are no log lines to write and
</a><a href="#h2-1-1056" id="h2-1-1056" class="i">+       the commit file already exists: skip the diffstat */
</a><a href="#h2-1-1057" id="h2-1-1057" class="i">+    if (!nlogcommits &amp;&amp; !r)
</a><a href="#h2-1-1058" id="h2-1-1058" class="i">+      continue;
</a><a href="#h2-1-1059" id="h2-1-1059" class="i">+
</a><a href="#h2-1-1060" id="h2-1-1060" class="i">+    if (!(ci = commitinfo_getbyoid(&amp;id)))
</a><a href="#h2-1-1061" id="h2-1-1061" class="i">+      break;
</a><a href="#h2-1-1062" id="h2-1-1062" class="i">+    /* diffstat: for stagit HTML required for the index.html line */
</a><a href="#h2-1-1063" id="h2-1-1063" class="i">+    if (commitinfo_getstats(ci) == -1)
</a><a href="#h2-1-1064" id="h2-1-1064" class="i">+      goto err;
</a><a href="#h2-1-1065" id="h2-1-1065" class="i">+
</a><a href="#h2-1-1066" id="h2-1-1066" class="i">+    if (nlogcommits &lt; 0) {
</a><a href="#h2-1-1067" id="h2-1-1067" class="i">+      writelogline(fp, ci);
</a><a href="#h2-1-1068" id="h2-1-1068" class="i">+    } else if (nlogcommits &gt; 0) {
</a><a href="#h2-1-1069" id="h2-1-1069" class="i">+      writelogline(fp, ci);
</a><a href="#h2-1-1070" id="h2-1-1070" class="i">+      nlogcommits--;
</a><a href="#h2-1-1071" id="h2-1-1071" class="i">+      if (!nlogcommits &amp;&amp; ci-&gt;parentoid[0])
</a><a href="#h2-1-1072" id="h2-1-1072" class="i">+        fputs(&quot;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td colspan=\&quot;5\&quot;&gt;&quot;
</a><a href="#h2-1-1073" id="h2-1-1073" class="i">+              &quot;More commits remaining [...]&lt;/td&gt;&quot;
</a><a href="#h2-1-1074" id="h2-1-1074" class="i">+              &quot;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-1075" id="h2-1-1075" class="i">+    }
</a><a href="#h2-1-1076" id="h2-1-1076" class="i">+
</a><a href="#h2-1-1077" id="h2-1-1077" class="i">+    if (cachefile)
</a><a href="#h2-1-1078" id="h2-1-1078" class="i">+      writelogline(wcachefp, ci);
</a><a href="#h2-1-1079" id="h2-1-1079" class="i">+
</a><a href="#h2-1-1080" id="h2-1-1080" class="i">+    /* check if file exists if so skip it */
</a><a href="#h2-1-1081" id="h2-1-1081" class="i">+    if (r) {
</a><a href="#h2-1-1082" id="h2-1-1082" class="i">+      relpath = &quot;../&quot;;
</a><a href="#h2-1-1083" id="h2-1-1083" class="i">+      fpfile = efopen(path, &quot;w&quot;);
</a><a href="#h2-1-1084" id="h2-1-1084" class="i">+      writeheader(fpfile, ci-&gt;summary);
</a><a href="#h2-1-1085" id="h2-1-1085" class="i">+      fputs(&quot;&lt;div id=\&quot;pre-scroll\&quot;&gt;\n&lt;pre&gt;&quot;, fpfile);
</a><a href="#h2-1-1086" id="h2-1-1086" class="i">+      printshowfile(fpfile, ci);
</a><a href="#h2-1-1087" id="h2-1-1087" class="i">+      fputs(&quot;&lt;/pre&gt;\n&lt;/div&gt;\n&quot;, fpfile);
</a><a href="#h2-1-1088" id="h2-1-1088" class="i">+      writefooter(fpfile);
</a><a href="#h2-1-1089" id="h2-1-1089" class="i">+      fclose(fpfile);
</a><a href="#h2-1-1090" id="h2-1-1090" class="i">+    }
</a> err:
<a href="#h2-1-1092" id="h2-1-1092" class="d">-		commitinfo_free(ci);
</a><a href="#h2-1-1093" id="h2-1-1093" class="d">-	}
</a><a href="#h2-1-1094" id="h2-1-1094" class="d">-	git_revwalk_free(w);
</a><a href="#h2-1-1095" id="h2-1-1095" class="i">+    commitinfo_free(ci);
</a><a href="#h2-1-1096" id="h2-1-1096" class="i">+  }
</a><a href="#h2-1-1097" id="h2-1-1097" class="i">+  git_revwalk_free(w);
</a> 
<a href="#h2-1-1099" id="h2-1-1099" class="d">-	relpath = &quot;&quot;;
</a><a href="#h2-1-1100" id="h2-1-1100" class="i">+  relpath = &quot;&quot;;
</a> 
<a href="#h2-1-1102" id="h2-1-1102" class="d">-	return 0;
</a><a href="#h2-1-1103" id="h2-1-1103" class="i">+  return 0;
</a> }
 
 void
 printcommitatom(FILE *fp, struct commitinfo *ci)
 {
<a href="#h2-1-1109" id="h2-1-1109" class="d">-	fputs(&quot;&lt;entry&gt;\n&quot;, fp);
</a><a href="#h2-1-1110" id="h2-1-1110" class="d">-
</a><a href="#h2-1-1111" id="h2-1-1111" class="d">-	fprintf(fp, &quot;&lt;id&gt;%s&lt;/id&gt;\n&quot;, ci-&gt;oid);
</a><a href="#h2-1-1112" id="h2-1-1112" class="d">-	if (ci-&gt;author) {
</a><a href="#h2-1-1113" id="h2-1-1113" class="d">-		fputs(&quot;&lt;published&gt;&quot;, fp);
</a><a href="#h2-1-1114" id="h2-1-1114" class="d">-		printtimez(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-1115" id="h2-1-1115" class="d">-		fputs(&quot;&lt;/published&gt;\n&quot;, fp);
</a><a href="#h2-1-1116" id="h2-1-1116" class="d">-	}
</a><a href="#h2-1-1117" id="h2-1-1117" class="d">-	if (ci-&gt;committer) {
</a><a href="#h2-1-1118" id="h2-1-1118" class="d">-		fputs(&quot;&lt;updated&gt;&quot;, fp);
</a><a href="#h2-1-1119" id="h2-1-1119" class="d">-		printtimez(fp, &amp;(ci-&gt;committer-&gt;when));
</a><a href="#h2-1-1120" id="h2-1-1120" class="d">-		fputs(&quot;&lt;/updated&gt;\n&quot;, fp);
</a><a href="#h2-1-1121" id="h2-1-1121" class="d">-	}
</a><a href="#h2-1-1122" id="h2-1-1122" class="d">-	if (ci-&gt;summary) {
</a><a href="#h2-1-1123" id="h2-1-1123" class="d">-		fputs(&quot;&lt;title type=\&quot;text\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-1124" id="h2-1-1124" class="d">-		xmlencode(fp, ci-&gt;summary, strlen(ci-&gt;summary));
</a><a href="#h2-1-1125" id="h2-1-1125" class="d">-		fputs(&quot;&lt;/title&gt;\n&quot;, fp);
</a><a href="#h2-1-1126" id="h2-1-1126" class="d">-	}
</a><a href="#h2-1-1127" id="h2-1-1127" class="d">-	fprintf(fp, &quot;&lt;link rel=\&quot;alternate\&quot; type=\&quot;text/html\&quot; href=\&quot;commit/%s.html\&quot; /&gt;\n&quot;,
</a><a href="#h2-1-1128" id="h2-1-1128" class="d">-	        ci-&gt;oid);
</a><a href="#h2-1-1129" id="h2-1-1129" class="d">-
</a><a href="#h2-1-1130" id="h2-1-1130" class="d">-	if (ci-&gt;author) {
</a><a href="#h2-1-1131" id="h2-1-1131" class="d">-		fputs(&quot;&lt;author&gt;\n&lt;name&gt;&quot;, fp);
</a><a href="#h2-1-1132" id="h2-1-1132" class="d">-		xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-1133" id="h2-1-1133" class="d">-		fputs(&quot;&lt;/name&gt;\n&lt;email&gt;&quot;, fp);
</a><a href="#h2-1-1134" id="h2-1-1134" class="d">-		xmlencode(fp, ci-&gt;author-&gt;email, strlen(ci-&gt;author-&gt;email));
</a><a href="#h2-1-1135" id="h2-1-1135" class="d">-		fputs(&quot;&lt;/email&gt;\n&lt;/author&gt;\n&quot;, fp);
</a><a href="#h2-1-1136" id="h2-1-1136" class="d">-	}
</a><a href="#h2-1-1137" id="h2-1-1137" class="d">-
</a><a href="#h2-1-1138" id="h2-1-1138" class="d">-	fputs(&quot;&lt;content type=\&quot;text\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-1139" id="h2-1-1139" class="d">-	fprintf(fp, &quot;commit %s\n&quot;, ci-&gt;oid);
</a><a href="#h2-1-1140" id="h2-1-1140" class="d">-	if (ci-&gt;parentoid[0])
</a><a href="#h2-1-1141" id="h2-1-1141" class="d">-		fprintf(fp, &quot;parent %s\n&quot;, ci-&gt;parentoid);
</a><a href="#h2-1-1142" id="h2-1-1142" class="d">-	if (ci-&gt;author) {
</a><a href="#h2-1-1143" id="h2-1-1143" class="d">-		fputs(&quot;Author: &quot;, fp);
</a><a href="#h2-1-1144" id="h2-1-1144" class="d">-		xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-1145" id="h2-1-1145" class="d">-		fputs(&quot; &amp;lt;&quot;, fp);
</a><a href="#h2-1-1146" id="h2-1-1146" class="d">-		xmlencode(fp, ci-&gt;author-&gt;email, strlen(ci-&gt;author-&gt;email));
</a><a href="#h2-1-1147" id="h2-1-1147" class="d">-		fputs(&quot;&amp;gt;\nDate:   &quot;, fp);
</a><a href="#h2-1-1148" id="h2-1-1148" class="d">-		printtime(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-1149" id="h2-1-1149" class="d">-		fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-1150" id="h2-1-1150" class="d">-	}
</a><a href="#h2-1-1151" id="h2-1-1151" class="d">-	if (ci-&gt;msg) {
</a><a href="#h2-1-1152" id="h2-1-1152" class="d">-		fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-1153" id="h2-1-1153" class="d">-		xmlencode(fp, ci-&gt;msg, strlen(ci-&gt;msg));
</a><a href="#h2-1-1154" id="h2-1-1154" class="d">-	}
</a><a href="#h2-1-1155" id="h2-1-1155" class="d">-	fputs(&quot;\n&lt;/content&gt;\n&lt;/entry&gt;\n&quot;, fp);
</a><a href="#h2-1-1156" id="h2-1-1156" class="i">+  fputs(&quot;&lt;entry&gt;\n&quot;, fp);
</a><a href="#h2-1-1157" id="h2-1-1157" class="i">+
</a><a href="#h2-1-1158" id="h2-1-1158" class="i">+  fprintf(fp, &quot;&lt;id&gt;%s&lt;/id&gt;\n&quot;, ci-&gt;oid);
</a><a href="#h2-1-1159" id="h2-1-1159" class="i">+  if (ci-&gt;author) {
</a><a href="#h2-1-1160" id="h2-1-1160" class="i">+    fputs(&quot;&lt;published&gt;&quot;, fp);
</a><a href="#h2-1-1161" id="h2-1-1161" class="i">+    printtimez(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-1162" id="h2-1-1162" class="i">+    fputs(&quot;&lt;/published&gt;\n&quot;, fp);
</a><a href="#h2-1-1163" id="h2-1-1163" class="i">+  }
</a><a href="#h2-1-1164" id="h2-1-1164" class="i">+  if (ci-&gt;committer) {
</a><a href="#h2-1-1165" id="h2-1-1165" class="i">+    fputs(&quot;&lt;updated&gt;&quot;, fp);
</a><a href="#h2-1-1166" id="h2-1-1166" class="i">+    printtimez(fp, &amp;(ci-&gt;committer-&gt;when));
</a><a href="#h2-1-1167" id="h2-1-1167" class="i">+    fputs(&quot;&lt;/updated&gt;\n&quot;, fp);
</a><a href="#h2-1-1168" id="h2-1-1168" class="i">+  }
</a><a href="#h2-1-1169" id="h2-1-1169" class="i">+  if (ci-&gt;summary) {
</a><a href="#h2-1-1170" id="h2-1-1170" class="i">+    fputs(&quot;&lt;title type=\&quot;text\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-1171" id="h2-1-1171" class="i">+    xmlencode(fp, ci-&gt;summary, strlen(ci-&gt;summary));
</a><a href="#h2-1-1172" id="h2-1-1172" class="i">+    fputs(&quot;&lt;/title&gt;\n&quot;, fp);
</a><a href="#h2-1-1173" id="h2-1-1173" class="i">+  }
</a><a href="#h2-1-1174" id="h2-1-1174" class="i">+  fprintf(fp, &quot;&lt;link rel=\&quot;alternate\&quot; type=\&quot;text/html\&quot; href=\&quot;commit/%s.html\&quot; /&gt;\n&quot;,
</a><a href="#h2-1-1175" id="h2-1-1175" class="i">+          ci-&gt;oid);
</a><a href="#h2-1-1176" id="h2-1-1176" class="i">+
</a><a href="#h2-1-1177" id="h2-1-1177" class="i">+  if (ci-&gt;author) {
</a><a href="#h2-1-1178" id="h2-1-1178" class="i">+    fputs(&quot;&lt;author&gt;\n&lt;name&gt;&quot;, fp);
</a><a href="#h2-1-1179" id="h2-1-1179" class="i">+    xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-1180" id="h2-1-1180" class="i">+    fputs(&quot;&lt;/name&gt;\n&lt;email&gt;&quot;, fp);
</a><a href="#h2-1-1181" id="h2-1-1181" class="i">+    xmlencode(fp, ci-&gt;author-&gt;email, strlen(ci-&gt;author-&gt;email));
</a><a href="#h2-1-1182" id="h2-1-1182" class="i">+    fputs(&quot;&lt;/email&gt;\n&lt;/author&gt;\n&quot;, fp);
</a><a href="#h2-1-1183" id="h2-1-1183" class="i">+  }
</a><a href="#h2-1-1184" id="h2-1-1184" class="i">+
</a><a href="#h2-1-1185" id="h2-1-1185" class="i">+  fputs(&quot;&lt;content type=\&quot;text\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-1186" id="h2-1-1186" class="i">+  fprintf(fp, &quot;commit %s\n&quot;, ci-&gt;oid);
</a><a href="#h2-1-1187" id="h2-1-1187" class="i">+  if (ci-&gt;parentoid[0])
</a><a href="#h2-1-1188" id="h2-1-1188" class="i">+    fprintf(fp, &quot;parent %s\n&quot;, ci-&gt;parentoid);
</a><a href="#h2-1-1189" id="h2-1-1189" class="i">+  if (ci-&gt;author) {
</a><a href="#h2-1-1190" id="h2-1-1190" class="i">+    fputs(&quot;Author: &quot;, fp);
</a><a href="#h2-1-1191" id="h2-1-1191" class="i">+    xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-1192" id="h2-1-1192" class="i">+    fputs(&quot; &amp;lt;&quot;, fp);
</a><a href="#h2-1-1193" id="h2-1-1193" class="i">+    xmlencode(fp, ci-&gt;author-&gt;email, strlen(ci-&gt;author-&gt;email));
</a><a href="#h2-1-1194" id="h2-1-1194" class="i">+    fputs(&quot;&amp;gt;\nDate:   &quot;, fp);
</a><a href="#h2-1-1195" id="h2-1-1195" class="i">+    printtime(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-1196" id="h2-1-1196" class="i">+    fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-1197" id="h2-1-1197" class="i">+  }
</a><a href="#h2-1-1198" id="h2-1-1198" class="i">+  if (ci-&gt;msg) {
</a><a href="#h2-1-1199" id="h2-1-1199" class="i">+    fputc(&#39;\n&#39;, fp);
</a><a href="#h2-1-1200" id="h2-1-1200" class="i">+    xmlencode(fp, ci-&gt;msg, strlen(ci-&gt;msg));
</a><a href="#h2-1-1201" id="h2-1-1201" class="i">+  }
</a><a href="#h2-1-1202" id="h2-1-1202" class="i">+  fputs(&quot;\n&lt;/content&gt;\n&lt;/entry&gt;\n&quot;, fp);
</a> }
 
 int
 writeatom(FILE *fp)
 {
<a href="#h2-1-1208" id="h2-1-1208" class="d">-	struct commitinfo *ci;
</a><a href="#h2-1-1209" id="h2-1-1209" class="d">-	git_revwalk *w = NULL;
</a><a href="#h2-1-1210" id="h2-1-1210" class="d">-	git_oid id;
</a><a href="#h2-1-1211" id="h2-1-1211" class="d">-	size_t i, m = 100; /* last &#39;m&#39; commits */
</a><a href="#h2-1-1212" id="h2-1-1212" class="d">-
</a><a href="#h2-1-1213" id="h2-1-1213" class="d">-	fputs(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;
</a><a href="#h2-1-1214" id="h2-1-1214" class="d">-	      &quot;&lt;feed xmlns=\&quot;http://www.w3.org/2005/Atom\&quot;&gt;\n&lt;title&gt;&quot;, fp);
</a><a href="#h2-1-1215" id="h2-1-1215" class="d">-	xmlencode(fp, strippedname, strlen(strippedname));
</a><a href="#h2-1-1216" id="h2-1-1216" class="d">-	fputs(&quot;, branch HEAD&lt;/title&gt;\n&lt;subtitle&gt;&quot;, fp);
</a><a href="#h2-1-1217" id="h2-1-1217" class="d">-	xmlencode(fp, description, strlen(description));
</a><a href="#h2-1-1218" id="h2-1-1218" class="d">-	fputs(&quot;&lt;/subtitle&gt;\n&quot;, fp);
</a><a href="#h2-1-1219" id="h2-1-1219" class="d">-
</a><a href="#h2-1-1220" id="h2-1-1220" class="d">-	git_revwalk_new(&amp;w, repo);
</a><a href="#h2-1-1221" id="h2-1-1221" class="d">-	git_revwalk_push_head(w);
</a><a href="#h2-1-1222" id="h2-1-1222" class="d">-	git_revwalk_simplify_first_parent(w);
</a><a href="#h2-1-1223" id="h2-1-1223" class="d">-
</a><a href="#h2-1-1224" id="h2-1-1224" class="d">-	for (i = 0; i &lt; m &amp;&amp; !git_revwalk_next(&amp;id, w); i++) {
</a><a href="#h2-1-1225" id="h2-1-1225" class="d">-		if (!(ci = commitinfo_getbyoid(&amp;id)))
</a><a href="#h2-1-1226" id="h2-1-1226" class="d">-			break;
</a><a href="#h2-1-1227" id="h2-1-1227" class="d">-		printcommitatom(fp, ci);
</a><a href="#h2-1-1228" id="h2-1-1228" class="d">-		commitinfo_free(ci);
</a><a href="#h2-1-1229" id="h2-1-1229" class="d">-	}
</a><a href="#h2-1-1230" id="h2-1-1230" class="d">-	git_revwalk_free(w);
</a><a href="#h2-1-1231" id="h2-1-1231" class="d">-
</a><a href="#h2-1-1232" id="h2-1-1232" class="d">-	fputs(&quot;&lt;/feed&gt;\n&quot;, fp);
</a><a href="#h2-1-1233" id="h2-1-1233" class="d">-
</a><a href="#h2-1-1234" id="h2-1-1234" class="d">-	return 0;
</a><a href="#h2-1-1235" id="h2-1-1235" class="i">+  struct commitinfo *ci;
</a><a href="#h2-1-1236" id="h2-1-1236" class="i">+  git_revwalk *w = NULL;
</a><a href="#h2-1-1237" id="h2-1-1237" class="i">+  git_oid id;
</a><a href="#h2-1-1238" id="h2-1-1238" class="i">+  size_t i, m = 100; /* last &#39;m&#39; commits */
</a><a href="#h2-1-1239" id="h2-1-1239" class="i">+
</a><a href="#h2-1-1240" id="h2-1-1240" class="i">+  fputs(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;
</a><a href="#h2-1-1241" id="h2-1-1241" class="i">+        &quot;&lt;feed xmlns=\&quot;http://www.w3.org/2005/Atom\&quot;&gt;\n&lt;title&gt;&quot;, fp);
</a><a href="#h2-1-1242" id="h2-1-1242" class="i">+  xmlencode(fp, strippedname, strlen(strippedname));
</a><a href="#h2-1-1243" id="h2-1-1243" class="i">+  fputs(&quot;, branch HEAD&lt;/title&gt;\n&lt;subtitle&gt;&quot;, fp);
</a><a href="#h2-1-1244" id="h2-1-1244" class="i">+  xmlencode(fp, description, strlen(description));
</a><a href="#h2-1-1245" id="h2-1-1245" class="i">+  fputs(&quot;&lt;/subtitle&gt;\n&quot;, fp);
</a><a href="#h2-1-1246" id="h2-1-1246" class="i">+
</a><a href="#h2-1-1247" id="h2-1-1247" class="i">+  git_revwalk_new(&amp;w, repo);
</a><a href="#h2-1-1248" id="h2-1-1248" class="i">+  git_revwalk_push_head(w);
</a><a href="#h2-1-1249" id="h2-1-1249" class="i">+  git_revwalk_simplify_first_parent(w);
</a><a href="#h2-1-1250" id="h2-1-1250" class="i">+
</a><a href="#h2-1-1251" id="h2-1-1251" class="i">+  for (i = 0; i &lt; m &amp;&amp; !git_revwalk_next(&amp;id, w); i++) {
</a><a href="#h2-1-1252" id="h2-1-1252" class="i">+    if (!(ci = commitinfo_getbyoid(&amp;id)))
</a><a href="#h2-1-1253" id="h2-1-1253" class="i">+      break;
</a><a href="#h2-1-1254" id="h2-1-1254" class="i">+    printcommitatom(fp, ci);
</a><a href="#h2-1-1255" id="h2-1-1255" class="i">+    commitinfo_free(ci);
</a><a href="#h2-1-1256" id="h2-1-1256" class="i">+  }
</a><a href="#h2-1-1257" id="h2-1-1257" class="i">+  git_revwalk_free(w);
</a><a href="#h2-1-1258" id="h2-1-1258" class="i">+
</a><a href="#h2-1-1259" id="h2-1-1259" class="i">+  fputs(&quot;&lt;/feed&gt;\n&quot;, fp);
</a><a href="#h2-1-1260" id="h2-1-1260" class="i">+
</a><a href="#h2-1-1261" id="h2-1-1261" class="i">+  return 0;
</a> }
 
 int
 writeblob(git_object *obj, const char *fpath, const char *filename, git_off_t filesize)
 {
<a href="#h2-1-1267" id="h2-1-1267" class="d">-	char tmp[PATH_MAX] = &quot;&quot;, *d;
</a><a href="#h2-1-1268" id="h2-1-1268" class="d">-	const char *p;
</a><a href="#h2-1-1269" id="h2-1-1269" class="d">-	int lc = 0;
</a><a href="#h2-1-1270" id="h2-1-1270" class="d">-	FILE *fp;
</a><a href="#h2-1-1271" id="h2-1-1271" class="d">-
</a><a href="#h2-1-1272" id="h2-1-1272" class="d">-	if (strlcpy(tmp, fpath, sizeof(tmp)) &gt;= sizeof(tmp))
</a><a href="#h2-1-1273" id="h2-1-1273" class="d">-		errx(1, &quot;path truncated: &#39;%s&#39;&quot;, fpath);
</a><a href="#h2-1-1274" id="h2-1-1274" class="d">-	if (!(d = dirname(tmp)))
</a><a href="#h2-1-1275" id="h2-1-1275" class="d">-		err(1, &quot;dirname&quot;);
</a><a href="#h2-1-1276" id="h2-1-1276" class="d">-	if (mkdirp(d))
</a><a href="#h2-1-1277" id="h2-1-1277" class="d">-		return -1;
</a><a href="#h2-1-1278" id="h2-1-1278" class="d">-
</a><a href="#h2-1-1279" id="h2-1-1279" class="d">-	for (p = fpath, tmp[0] = &#39;\0&#39;; *p; p++) {
</a><a href="#h2-1-1280" id="h2-1-1280" class="d">-		if (*p == &#39;/&#39; &amp;&amp; strlcat(tmp, &quot;../&quot;, sizeof(tmp)) &gt;= sizeof(tmp))
</a><a href="#h2-1-1281" id="h2-1-1281" class="d">-			errx(1, &quot;path truncated: &#39;../%s&#39;&quot;, tmp);
</a><a href="#h2-1-1282" id="h2-1-1282" class="d">-	}
</a><a href="#h2-1-1283" id="h2-1-1283" class="d">-	relpath = tmp;
</a><a href="#h2-1-1284" id="h2-1-1284" class="d">-
</a><a href="#h2-1-1285" id="h2-1-1285" class="d">-	fp = efopen(fpath, &quot;w&quot;);
</a><a href="#h2-1-1286" id="h2-1-1286" class="d">-	writeheader(fp, filename);
</a><a href="#h2-1-1287" id="h2-1-1287" class="d">-	fputs(&quot;&lt;p&gt; &quot;, fp);
</a><a href="#h2-1-1288" id="h2-1-1288" class="d">-	xmlencode(fp, filename, strlen(filename));
</a><a href="#h2-1-1289" id="h2-1-1289" class="d">-	fprintf(fp, &quot; (%juB)&quot;, (uintmax_t)filesize);
</a><a href="#h2-1-1290" id="h2-1-1290" class="d">-	fputs(&quot;&lt;/p&gt;&lt;hr/&gt;&quot;, fp);
</a><a href="#h2-1-1291" id="h2-1-1291" class="d">-
</a><a href="#h2-1-1292" id="h2-1-1292" class="d">-	if (git_blob_is_binary((git_blob *)obj)) {
</a><a href="#h2-1-1293" id="h2-1-1293" class="d">-		fputs(&quot;&lt;p&gt;Binary file.&lt;/p&gt;\n&quot;, fp);
</a><a href="#h2-1-1294" id="h2-1-1294" class="d">-	} else {
</a><a href="#h2-1-1295" id="h2-1-1295" class="d">-		lc = writeblobhtml(fp, (git_blob *)obj);
</a><a href="#h2-1-1296" id="h2-1-1296" class="d">-		if (ferror(fp))
</a><a href="#h2-1-1297" id="h2-1-1297" class="d">-			err(1, &quot;fwrite&quot;);
</a><a href="#h2-1-1298" id="h2-1-1298" class="d">-	}
</a><a href="#h2-1-1299" id="h2-1-1299" class="d">-	writefooter(fp);
</a><a href="#h2-1-1300" id="h2-1-1300" class="d">-	fclose(fp);
</a><a href="#h2-1-1301" id="h2-1-1301" class="d">-
</a><a href="#h2-1-1302" id="h2-1-1302" class="d">-	relpath = &quot;&quot;;
</a><a href="#h2-1-1303" id="h2-1-1303" class="d">-
</a><a href="#h2-1-1304" id="h2-1-1304" class="d">-	return lc;
</a><a href="#h2-1-1305" id="h2-1-1305" class="i">+  char tmp[PATH_MAX] = &quot;&quot;, *d;
</a><a href="#h2-1-1306" id="h2-1-1306" class="i">+  const char *p;
</a><a href="#h2-1-1307" id="h2-1-1307" class="i">+  int lc = 0;
</a><a href="#h2-1-1308" id="h2-1-1308" class="i">+  FILE *fp;
</a><a href="#h2-1-1309" id="h2-1-1309" class="i">+
</a><a href="#h2-1-1310" id="h2-1-1310" class="i">+  if (strlcpy(tmp, fpath, sizeof(tmp)) &gt;= sizeof(tmp))
</a><a href="#h2-1-1311" id="h2-1-1311" class="i">+    errx(1, &quot;path truncated: &#39;%s&#39;&quot;, fpath);
</a><a href="#h2-1-1312" id="h2-1-1312" class="i">+  if (!(d = dirname(tmp)))
</a><a href="#h2-1-1313" id="h2-1-1313" class="i">+    err(1, &quot;dirname&quot;);
</a><a href="#h2-1-1314" id="h2-1-1314" class="i">+  if (mkdirp(d))
</a><a href="#h2-1-1315" id="h2-1-1315" class="i">+    return -1;
</a><a href="#h2-1-1316" id="h2-1-1316" class="i">+
</a><a href="#h2-1-1317" id="h2-1-1317" class="i">+  for (p = fpath, tmp[0] = &#39;\0&#39;; *p; p++) {
</a><a href="#h2-1-1318" id="h2-1-1318" class="i">+    if (*p == &#39;/&#39; &amp;&amp; strlcat(tmp, &quot;../&quot;, sizeof(tmp)) &gt;= sizeof(tmp))
</a><a href="#h2-1-1319" id="h2-1-1319" class="i">+      errx(1, &quot;path truncated: &#39;../%s&#39;&quot;, tmp);
</a><a href="#h2-1-1320" id="h2-1-1320" class="i">+  }
</a><a href="#h2-1-1321" id="h2-1-1321" class="i">+  relpath = tmp;
</a><a href="#h2-1-1322" id="h2-1-1322" class="i">+
</a><a href="#h2-1-1323" id="h2-1-1323" class="i">+  fp = efopen(fpath, &quot;w&quot;);
</a><a href="#h2-1-1324" id="h2-1-1324" class="i">+  writeheader(fp, filename);
</a><a href="#h2-1-1325" id="h2-1-1325" class="i">+  fputs(&quot;&lt;p&gt; &quot;, fp);
</a><a href="#h2-1-1326" id="h2-1-1326" class="i">+  xmlencode(fp, filename, strlen(filename));
</a><a href="#h2-1-1327" id="h2-1-1327" class="i">+  fprintf(fp, &quot; (%juB)&quot;, (uintmax_t)filesize);
</a><a href="#h2-1-1328" id="h2-1-1328" class="i">+  fputs(&quot;&lt;/p&gt;&lt;hr/&gt;&quot;, fp);
</a><a href="#h2-1-1329" id="h2-1-1329" class="i">+
</a><a href="#h2-1-1330" id="h2-1-1330" class="i">+  if (git_blob_is_binary((git_blob *)obj)) {
</a><a href="#h2-1-1331" id="h2-1-1331" class="i">+    fputs(&quot;&lt;p&gt;Binary file.&lt;/p&gt;\n&quot;, fp);
</a><a href="#h2-1-1332" id="h2-1-1332" class="i">+  } else {
</a><a href="#h2-1-1333" id="h2-1-1333" class="i">+    lc = writeblobhtml(fp, (git_blob *)obj);
</a><a href="#h2-1-1334" id="h2-1-1334" class="i">+    if (ferror(fp))
</a><a href="#h2-1-1335" id="h2-1-1335" class="i">+      err(1, &quot;fwrite&quot;);
</a><a href="#h2-1-1336" id="h2-1-1336" class="i">+  }
</a><a href="#h2-1-1337" id="h2-1-1337" class="i">+  writefooter(fp);
</a><a href="#h2-1-1338" id="h2-1-1338" class="i">+  fclose(fp);
</a><a href="#h2-1-1339" id="h2-1-1339" class="i">+
</a><a href="#h2-1-1340" id="h2-1-1340" class="i">+  relpath = &quot;&quot;;
</a><a href="#h2-1-1341" id="h2-1-1341" class="i">+
</a><a href="#h2-1-1342" id="h2-1-1342" class="i">+  return lc;
</a> }
 
 const char *
 filemode(git_filemode_t m)
 {
<a href="#h2-1-1348" id="h2-1-1348" class="d">-	static char mode[11];
</a><a href="#h2-1-1349" id="h2-1-1349" class="d">-
</a><a href="#h2-1-1350" id="h2-1-1350" class="d">-	memset(mode, &#39;-&#39;, sizeof(mode) - 1);
</a><a href="#h2-1-1351" id="h2-1-1351" class="d">-	mode[10] = &#39;\0&#39;;
</a><a href="#h2-1-1352" id="h2-1-1352" class="d">-
</a><a href="#h2-1-1353" id="h2-1-1353" class="d">-	if (S_ISREG(m))
</a><a href="#h2-1-1354" id="h2-1-1354" class="d">-		mode[0] = &#39;-&#39;;
</a><a href="#h2-1-1355" id="h2-1-1355" class="d">-	else if (S_ISBLK(m))
</a><a href="#h2-1-1356" id="h2-1-1356" class="d">-		mode[0] = &#39;b&#39;;
</a><a href="#h2-1-1357" id="h2-1-1357" class="d">-	else if (S_ISCHR(m))
</a><a href="#h2-1-1358" id="h2-1-1358" class="d">-		mode[0] = &#39;c&#39;;
</a><a href="#h2-1-1359" id="h2-1-1359" class="d">-	else if (S_ISDIR(m))
</a><a href="#h2-1-1360" id="h2-1-1360" class="d">-		mode[0] = &#39;d&#39;;
</a><a href="#h2-1-1361" id="h2-1-1361" class="d">-	else if (S_ISFIFO(m))
</a><a href="#h2-1-1362" id="h2-1-1362" class="d">-		mode[0] = &#39;p&#39;;
</a><a href="#h2-1-1363" id="h2-1-1363" class="d">-	else if (S_ISLNK(m))
</a><a href="#h2-1-1364" id="h2-1-1364" class="d">-		mode[0] = &#39;l&#39;;
</a><a href="#h2-1-1365" id="h2-1-1365" class="d">-	else if (S_ISSOCK(m))
</a><a href="#h2-1-1366" id="h2-1-1366" class="d">-		mode[0] = &#39;s&#39;;
</a><a href="#h2-1-1367" id="h2-1-1367" class="d">-	else
</a><a href="#h2-1-1368" id="h2-1-1368" class="d">-		mode[0] = &#39;?&#39;;
</a><a href="#h2-1-1369" id="h2-1-1369" class="d">-
</a><a href="#h2-1-1370" id="h2-1-1370" class="d">-	if (m &amp; S_IRUSR) mode[1] = &#39;r&#39;;
</a><a href="#h2-1-1371" id="h2-1-1371" class="d">-	if (m &amp; S_IWUSR) mode[2] = &#39;w&#39;;
</a><a href="#h2-1-1372" id="h2-1-1372" class="d">-	if (m &amp; S_IXUSR) mode[3] = &#39;x&#39;;
</a><a href="#h2-1-1373" id="h2-1-1373" class="d">-	if (m &amp; S_IRGRP) mode[4] = &#39;r&#39;;
</a><a href="#h2-1-1374" id="h2-1-1374" class="d">-	if (m &amp; S_IWGRP) mode[5] = &#39;w&#39;;
</a><a href="#h2-1-1375" id="h2-1-1375" class="d">-	if (m &amp; S_IXGRP) mode[6] = &#39;x&#39;;
</a><a href="#h2-1-1376" id="h2-1-1376" class="d">-	if (m &amp; S_IROTH) mode[7] = &#39;r&#39;;
</a><a href="#h2-1-1377" id="h2-1-1377" class="d">-	if (m &amp; S_IWOTH) mode[8] = &#39;w&#39;;
</a><a href="#h2-1-1378" id="h2-1-1378" class="d">-	if (m &amp; S_IXOTH) mode[9] = &#39;x&#39;;
</a><a href="#h2-1-1379" id="h2-1-1379" class="d">-
</a><a href="#h2-1-1380" id="h2-1-1380" class="d">-	if (m &amp; S_ISUID) mode[3] = (mode[3] == &#39;x&#39;) ? &#39;s&#39; : &#39;S&#39;;
</a><a href="#h2-1-1381" id="h2-1-1381" class="d">-	if (m &amp; S_ISGID) mode[6] = (mode[6] == &#39;x&#39;) ? &#39;s&#39; : &#39;S&#39;;
</a><a href="#h2-1-1382" id="h2-1-1382" class="d">-	if (m &amp; S_ISVTX) mode[9] = (mode[9] == &#39;x&#39;) ? &#39;t&#39; : &#39;T&#39;;
</a><a href="#h2-1-1383" id="h2-1-1383" class="d">-
</a><a href="#h2-1-1384" id="h2-1-1384" class="d">-	return mode;
</a><a href="#h2-1-1385" id="h2-1-1385" class="i">+  static char mode[11];
</a><a href="#h2-1-1386" id="h2-1-1386" class="i">+
</a><a href="#h2-1-1387" id="h2-1-1387" class="i">+  memset(mode, &#39;-&#39;, sizeof(mode) - 1);
</a><a href="#h2-1-1388" id="h2-1-1388" class="i">+  mode[10] = &#39;\0&#39;;
</a><a href="#h2-1-1389" id="h2-1-1389" class="i">+
</a><a href="#h2-1-1390" id="h2-1-1390" class="i">+  if (S_ISREG(m))
</a><a href="#h2-1-1391" id="h2-1-1391" class="i">+    mode[0] = &#39;-&#39;;
</a><a href="#h2-1-1392" id="h2-1-1392" class="i">+  else if (S_ISBLK(m))
</a><a href="#h2-1-1393" id="h2-1-1393" class="i">+    mode[0] = &#39;b&#39;;
</a><a href="#h2-1-1394" id="h2-1-1394" class="i">+  else if (S_ISCHR(m))
</a><a href="#h2-1-1395" id="h2-1-1395" class="i">+    mode[0] = &#39;c&#39;;
</a><a href="#h2-1-1396" id="h2-1-1396" class="i">+  else if (S_ISDIR(m))
</a><a href="#h2-1-1397" id="h2-1-1397" class="i">+    mode[0] = &#39;d&#39;;
</a><a href="#h2-1-1398" id="h2-1-1398" class="i">+  else if (S_ISFIFO(m))
</a><a href="#h2-1-1399" id="h2-1-1399" class="i">+    mode[0] = &#39;p&#39;;
</a><a href="#h2-1-1400" id="h2-1-1400" class="i">+  else if (S_ISLNK(m))
</a><a href="#h2-1-1401" id="h2-1-1401" class="i">+    mode[0] = &#39;l&#39;;
</a><a href="#h2-1-1402" id="h2-1-1402" class="i">+  else if (S_ISSOCK(m))
</a><a href="#h2-1-1403" id="h2-1-1403" class="i">+    mode[0] = &#39;s&#39;;
</a><a href="#h2-1-1404" id="h2-1-1404" class="i">+  else
</a><a href="#h2-1-1405" id="h2-1-1405" class="i">+    mode[0] = &#39;?&#39;;
</a><a href="#h2-1-1406" id="h2-1-1406" class="i">+
</a><a href="#h2-1-1407" id="h2-1-1407" class="i">+  if (m &amp; S_IRUSR) mode[1] = &#39;r&#39;;
</a><a href="#h2-1-1408" id="h2-1-1408" class="i">+  if (m &amp; S_IWUSR) mode[2] = &#39;w&#39;;
</a><a href="#h2-1-1409" id="h2-1-1409" class="i">+  if (m &amp; S_IXUSR) mode[3] = &#39;x&#39;;
</a><a href="#h2-1-1410" id="h2-1-1410" class="i">+  if (m &amp; S_IRGRP) mode[4] = &#39;r&#39;;
</a><a href="#h2-1-1411" id="h2-1-1411" class="i">+  if (m &amp; S_IWGRP) mode[5] = &#39;w&#39;;
</a><a href="#h2-1-1412" id="h2-1-1412" class="i">+  if (m &amp; S_IXGRP) mode[6] = &#39;x&#39;;
</a><a href="#h2-1-1413" id="h2-1-1413" class="i">+  if (m &amp; S_IROTH) mode[7] = &#39;r&#39;;
</a><a href="#h2-1-1414" id="h2-1-1414" class="i">+  if (m &amp; S_IWOTH) mode[8] = &#39;w&#39;;
</a><a href="#h2-1-1415" id="h2-1-1415" class="i">+  if (m &amp; S_IXOTH) mode[9] = &#39;x&#39;;
</a><a href="#h2-1-1416" id="h2-1-1416" class="i">+
</a><a href="#h2-1-1417" id="h2-1-1417" class="i">+  if (m &amp; S_ISUID) mode[3] = (mode[3] == &#39;x&#39;) ? &#39;s&#39; : &#39;S&#39;;
</a><a href="#h2-1-1418" id="h2-1-1418" class="i">+  if (m &amp; S_ISGID) mode[6] = (mode[6] == &#39;x&#39;) ? &#39;s&#39; : &#39;S&#39;;
</a><a href="#h2-1-1419" id="h2-1-1419" class="i">+  if (m &amp; S_ISVTX) mode[9] = (mode[9] == &#39;x&#39;) ? &#39;t&#39; : &#39;T&#39;;
</a><a href="#h2-1-1420" id="h2-1-1420" class="i">+
</a><a href="#h2-1-1421" id="h2-1-1421" class="i">+  return mode;
</a> }
 
 int
 writefilestree(FILE *fp, git_tree *tree, const char *path)
 {
<a href="#h2-1-1427" id="h2-1-1427" class="d">-	const git_tree_entry *entry = NULL;
</a><a href="#h2-1-1428" id="h2-1-1428" class="d">-	git_submodule *module = NULL;
</a><a href="#h2-1-1429" id="h2-1-1429" class="d">-	git_object *obj = NULL;
</a><a href="#h2-1-1430" id="h2-1-1430" class="d">-	git_off_t filesize;
</a><a href="#h2-1-1431" id="h2-1-1431" class="d">-	const char *entryname;
</a><a href="#h2-1-1432" id="h2-1-1432" class="d">-	char filepath[PATH_MAX], entrypath[PATH_MAX];
</a><a href="#h2-1-1433" id="h2-1-1433" class="d">-	size_t count, i;
</a><a href="#h2-1-1434" id="h2-1-1434" class="d">-	int lc, r, ret;
</a><a href="#h2-1-1435" id="h2-1-1435" class="d">-
</a><a href="#h2-1-1436" id="h2-1-1436" class="d">-	count = git_tree_entrycount(tree);
</a><a href="#h2-1-1437" id="h2-1-1437" class="d">-	for (i = 0; i &lt; count; i++) {
</a><a href="#h2-1-1438" id="h2-1-1438" class="d">-		if (!(entry = git_tree_entry_byindex(tree, i)) ||
</a><a href="#h2-1-1439" id="h2-1-1439" class="d">-		    !(entryname = git_tree_entry_name(entry)))
</a><a href="#h2-1-1440" id="h2-1-1440" class="d">-			return -1;
</a><a href="#h2-1-1441" id="h2-1-1441" class="d">-		joinpath(entrypath, sizeof(entrypath), path, entryname);
</a><a href="#h2-1-1442" id="h2-1-1442" class="d">-
</a><a href="#h2-1-1443" id="h2-1-1443" class="d">-		r = snprintf(filepath, sizeof(filepath), &quot;file/%s.html&quot;,
</a><a href="#h2-1-1444" id="h2-1-1444" class="d">-		         entrypath);
</a><a href="#h2-1-1445" id="h2-1-1445" class="d">-		if (r &lt; 0 || (size_t)r &gt;= sizeof(filepath))
</a><a href="#h2-1-1446" id="h2-1-1446" class="d">-			errx(1, &quot;path truncated: &#39;file/%s.html&#39;&quot;, entrypath);
</a><a href="#h2-1-1447" id="h2-1-1447" class="d">-
</a><a href="#h2-1-1448" id="h2-1-1448" class="d">-		if (!git_tree_entry_to_object(&amp;obj, repo, entry)) {
</a><a href="#h2-1-1449" id="h2-1-1449" class="d">-			switch (git_object_type(obj)) {
</a><a href="#h2-1-1450" id="h2-1-1450" class="d">-			case GIT_OBJ_BLOB:
</a><a href="#h2-1-1451" id="h2-1-1451" class="d">-				break;
</a><a href="#h2-1-1452" id="h2-1-1452" class="d">-			case GIT_OBJ_TREE:
</a><a href="#h2-1-1453" id="h2-1-1453" class="d">-				/* NOTE: recurses */
</a><a href="#h2-1-1454" id="h2-1-1454" class="d">-				ret = writefilestree(fp, (git_tree *)obj,
</a><a href="#h2-1-1455" id="h2-1-1455" class="d">-				                     entrypath);
</a><a href="#h2-1-1456" id="h2-1-1456" class="d">-				git_object_free(obj);
</a><a href="#h2-1-1457" id="h2-1-1457" class="d">-				if (ret)
</a><a href="#h2-1-1458" id="h2-1-1458" class="d">-					return ret;
</a><a href="#h2-1-1459" id="h2-1-1459" class="d">-				continue;
</a><a href="#h2-1-1460" id="h2-1-1460" class="d">-			default:
</a><a href="#h2-1-1461" id="h2-1-1461" class="d">-				git_object_free(obj);
</a><a href="#h2-1-1462" id="h2-1-1462" class="d">-				continue;
</a><a href="#h2-1-1463" id="h2-1-1463" class="d">-			}
</a><a href="#h2-1-1464" id="h2-1-1464" class="d">-
</a><a href="#h2-1-1465" id="h2-1-1465" class="d">-			filesize = git_blob_rawsize((git_blob *)obj);
</a><a href="#h2-1-1466" id="h2-1-1466" class="d">-			lc = writeblob(obj, filepath, entryname, filesize);
</a><a href="#h2-1-1467" id="h2-1-1467" class="d">-
</a><a href="#h2-1-1468" id="h2-1-1468" class="d">-			fputs(&quot;&lt;tr&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-1469" id="h2-1-1469" class="d">-			fputs(filemode(git_tree_entry_filemode(entry)), fp);
</a><a href="#h2-1-1470" id="h2-1-1470" class="d">-			fprintf(fp, &quot;&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;%s&quot;, relpath);
</a><a href="#h2-1-1471" id="h2-1-1471" class="d">-			xmlencode(fp, filepath, strlen(filepath));
</a><a href="#h2-1-1472" id="h2-1-1472" class="d">-			fputs(&quot;\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-1473" id="h2-1-1473" class="d">-			xmlencode(fp, entrypath, strlen(entrypath));
</a><a href="#h2-1-1474" id="h2-1-1474" class="d">-			fputs(&quot;&lt;/a&gt;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-1475" id="h2-1-1475" class="d">-			if (lc &gt; 0)
</a><a href="#h2-1-1476" id="h2-1-1476" class="d">-				fprintf(fp, &quot;%dL&quot;, lc);
</a><a href="#h2-1-1477" id="h2-1-1477" class="d">-			else
</a><a href="#h2-1-1478" id="h2-1-1478" class="d">-				fprintf(fp, &quot;%juB&quot;, (uintmax_t)filesize);
</a><a href="#h2-1-1479" id="h2-1-1479" class="d">-			fputs(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-1480" id="h2-1-1480" class="d">-			git_object_free(obj);
</a><a href="#h2-1-1481" id="h2-1-1481" class="d">-		} else if (!git_submodule_lookup(&amp;module, repo, entryname)) {
</a><a href="#h2-1-1482" id="h2-1-1482" class="d">-			fprintf(fp, &quot;&lt;tr&gt;&lt;td&gt;m---------&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;%sfile/.gitmodules.html\&quot;&gt;&quot;,
</a><a href="#h2-1-1483" id="h2-1-1483" class="d">-				relpath);
</a><a href="#h2-1-1484" id="h2-1-1484" class="d">-			xmlencode(fp, entrypath, strlen(entrypath));
</a><a href="#h2-1-1485" id="h2-1-1485" class="d">-			git_submodule_free(module);
</a><a href="#h2-1-1486" id="h2-1-1486" class="d">-			fputs(&quot;&lt;/a&gt;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-1487" id="h2-1-1487" class="d">-		}
</a><a href="#h2-1-1488" id="h2-1-1488" class="d">-	}
</a><a href="#h2-1-1489" id="h2-1-1489" class="d">-
</a><a href="#h2-1-1490" id="h2-1-1490" class="d">-	return 0;
</a><a href="#h2-1-1491" id="h2-1-1491" class="i">+  const git_tree_entry *entry = NULL;
</a><a href="#h2-1-1492" id="h2-1-1492" class="i">+  git_submodule *module = NULL;
</a><a href="#h2-1-1493" id="h2-1-1493" class="i">+  git_object *obj = NULL;
</a><a href="#h2-1-1494" id="h2-1-1494" class="i">+  git_off_t filesize;
</a><a href="#h2-1-1495" id="h2-1-1495" class="i">+  const char *entryname;
</a><a href="#h2-1-1496" id="h2-1-1496" class="i">+  char filepath[PATH_MAX], entrypath[PATH_MAX];
</a><a href="#h2-1-1497" id="h2-1-1497" class="i">+  size_t count, i;
</a><a href="#h2-1-1498" id="h2-1-1498" class="i">+  int lc, r, ret;
</a><a href="#h2-1-1499" id="h2-1-1499" class="i">+
</a><a href="#h2-1-1500" id="h2-1-1500" class="i">+  count = git_tree_entrycount(tree);
</a><a href="#h2-1-1501" id="h2-1-1501" class="i">+  for (i = 0; i &lt; count; i++) {
</a><a href="#h2-1-1502" id="h2-1-1502" class="i">+    if (!(entry = git_tree_entry_byindex(tree, i)) ||
</a><a href="#h2-1-1503" id="h2-1-1503" class="i">+        !(entryname = git_tree_entry_name(entry)))
</a><a href="#h2-1-1504" id="h2-1-1504" class="i">+      return -1;
</a><a href="#h2-1-1505" id="h2-1-1505" class="i">+    joinpath(entrypath, sizeof(entrypath), path, entryname);
</a><a href="#h2-1-1506" id="h2-1-1506" class="i">+
</a><a href="#h2-1-1507" id="h2-1-1507" class="i">+    r = snprintf(filepath, sizeof(filepath), &quot;file/%s.html&quot;,
</a><a href="#h2-1-1508" id="h2-1-1508" class="i">+             entrypath);
</a><a href="#h2-1-1509" id="h2-1-1509" class="i">+    if (r &lt; 0 || (size_t)r &gt;= sizeof(filepath))
</a><a href="#h2-1-1510" id="h2-1-1510" class="i">+      errx(1, &quot;path truncated: &#39;file/%s.html&#39;&quot;, entrypath);
</a><a href="#h2-1-1511" id="h2-1-1511" class="i">+
</a><a href="#h2-1-1512" id="h2-1-1512" class="i">+    if (!git_tree_entry_to_object(&amp;obj, repo, entry)) {
</a><a href="#h2-1-1513" id="h2-1-1513" class="i">+      switch (git_object_type(obj)) {
</a><a href="#h2-1-1514" id="h2-1-1514" class="i">+      case GIT_OBJ_BLOB:
</a><a href="#h2-1-1515" id="h2-1-1515" class="i">+        break;
</a><a href="#h2-1-1516" id="h2-1-1516" class="i">+      case GIT_OBJ_TREE:
</a><a href="#h2-1-1517" id="h2-1-1517" class="i">+        /* NOTE: recurses */
</a><a href="#h2-1-1518" id="h2-1-1518" class="i">+        ret = writefilestree(fp, (git_tree *)obj,
</a><a href="#h2-1-1519" id="h2-1-1519" class="i">+                             entrypath);
</a><a href="#h2-1-1520" id="h2-1-1520" class="i">+        git_object_free(obj);
</a><a href="#h2-1-1521" id="h2-1-1521" class="i">+        if (ret)
</a><a href="#h2-1-1522" id="h2-1-1522" class="i">+          return ret;
</a><a href="#h2-1-1523" id="h2-1-1523" class="i">+        continue;
</a><a href="#h2-1-1524" id="h2-1-1524" class="i">+      default:
</a><a href="#h2-1-1525" id="h2-1-1525" class="i">+        git_object_free(obj);
</a><a href="#h2-1-1526" id="h2-1-1526" class="i">+        continue;
</a><a href="#h2-1-1527" id="h2-1-1527" class="i">+      }
</a><a href="#h2-1-1528" id="h2-1-1528" class="i">+
</a><a href="#h2-1-1529" id="h2-1-1529" class="i">+      filesize = git_blob_rawsize((git_blob *)obj);
</a><a href="#h2-1-1530" id="h2-1-1530" class="i">+      lc = writeblob(obj, filepath, entryname, filesize);
</a><a href="#h2-1-1531" id="h2-1-1531" class="i">+
</a><a href="#h2-1-1532" id="h2-1-1532" class="i">+      fputs(&quot;&lt;tr&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-1533" id="h2-1-1533" class="i">+      fputs(filemode(git_tree_entry_filemode(entry)), fp);
</a><a href="#h2-1-1534" id="h2-1-1534" class="i">+      fprintf(fp, &quot;&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;%s&quot;, relpath);
</a><a href="#h2-1-1535" id="h2-1-1535" class="i">+      xmlencode(fp, filepath, strlen(filepath));
</a><a href="#h2-1-1536" id="h2-1-1536" class="i">+      fputs(&quot;\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-1537" id="h2-1-1537" class="i">+      xmlencode(fp, entrypath, strlen(entrypath));
</a><a href="#h2-1-1538" id="h2-1-1538" class="i">+      fputs(&quot;&lt;/a&gt;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&quot;, fp);
</a><a href="#h2-1-1539" id="h2-1-1539" class="i">+      if (lc &gt; 0)
</a><a href="#h2-1-1540" id="h2-1-1540" class="i">+        fprintf(fp, &quot;%dL&quot;, lc);
</a><a href="#h2-1-1541" id="h2-1-1541" class="i">+      else
</a><a href="#h2-1-1542" id="h2-1-1542" class="i">+        fprintf(fp, &quot;%juB&quot;, (uintmax_t)filesize);
</a><a href="#h2-1-1543" id="h2-1-1543" class="i">+      fputs(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-1544" id="h2-1-1544" class="i">+      git_object_free(obj);
</a><a href="#h2-1-1545" id="h2-1-1545" class="i">+    } else if (!git_submodule_lookup(&amp;module, repo, entryname)) {
</a><a href="#h2-1-1546" id="h2-1-1546" class="i">+      fprintf(fp, &quot;&lt;tr&gt;&lt;td&gt;m---------&lt;/td&gt;&lt;td&gt;&lt;a href=\&quot;%sfile/.gitmodules.html\&quot;&gt;&quot;,
</a><a href="#h2-1-1547" id="h2-1-1547" class="i">+        relpath);
</a><a href="#h2-1-1548" id="h2-1-1548" class="i">+      xmlencode(fp, entrypath, strlen(entrypath));
</a><a href="#h2-1-1549" id="h2-1-1549" class="i">+      git_submodule_free(module);
</a><a href="#h2-1-1550" id="h2-1-1550" class="i">+      fputs(&quot;&lt;/a&gt;&lt;/td&gt;&lt;td class=\&quot;num\&quot;&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-1551" id="h2-1-1551" class="i">+    }
</a><a href="#h2-1-1552" id="h2-1-1552" class="i">+  }
</a><a href="#h2-1-1553" id="h2-1-1553" class="i">+
</a><a href="#h2-1-1554" id="h2-1-1554" class="i">+  return 0;
</a> }
 
 int
 writefiles(FILE *fp, const git_oid *id)
 {
<a href="#h2-1-1560" id="h2-1-1560" class="d">-	git_tree *tree = NULL;
</a><a href="#h2-1-1561" id="h2-1-1561" class="d">-	git_commit *commit = NULL;
</a><a href="#h2-1-1562" id="h2-1-1562" class="d">-	int ret = -1;
</a><a href="#h2-1-1563" id="h2-1-1563" class="i">+  git_tree *tree = NULL;
</a><a href="#h2-1-1564" id="h2-1-1564" class="i">+  git_commit *commit = NULL;
</a><a href="#h2-1-1565" id="h2-1-1565" class="i">+  int ret = -1;
</a> 
<a href="#h2-1-1567" id="h2-1-1567" class="d">-	fputs(&quot;&lt;div id=\&quot;table-scroll\&quot;&gt;&lt;table id=\&quot;files\&quot;&gt;&lt;thead&gt;\n&lt;tr&gt;&quot;
</a><a href="#h2-1-1568" id="h2-1-1568" class="d">-	      &quot;&lt;th&gt;Mode&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&quot;
</a><a href="#h2-1-1569" id="h2-1-1569" class="d">-	      &quot;&lt;th class=\&quot;num\&quot;&gt;Size&lt;/th&gt;&quot;
</a><a href="#h2-1-1570" id="h2-1-1570" class="d">-	      &quot;&lt;/tr&gt;\n&lt;/thead&gt;&lt;tbody&gt;\n&quot;, fp);
</a><a href="#h2-1-1571" id="h2-1-1571" class="i">+  fputs(&quot;&lt;div id=\&quot;table-scroll\&quot;&gt;&lt;table id=\&quot;files\&quot;&gt;&lt;thead&gt;\n&lt;tr&gt;&quot;
</a><a href="#h2-1-1572" id="h2-1-1572" class="i">+        &quot;&lt;th&gt;Mode&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&quot;
</a><a href="#h2-1-1573" id="h2-1-1573" class="i">+        &quot;&lt;th class=\&quot;num\&quot;&gt;Size&lt;/th&gt;&quot;
</a><a href="#h2-1-1574" id="h2-1-1574" class="i">+        &quot;&lt;/tr&gt;\n&lt;/thead&gt;&lt;tbody&gt;\n&quot;, fp);
</a> 
<a href="#h2-1-1576" id="h2-1-1576" class="d">-	if (!git_commit_lookup(&amp;commit, repo, id) &amp;&amp;
</a><a href="#h2-1-1577" id="h2-1-1577" class="d">-	    !git_commit_tree(&amp;tree, commit))
</a><a href="#h2-1-1578" id="h2-1-1578" class="d">-		ret = writefilestree(fp, tree, &quot;&quot;);
</a><a href="#h2-1-1579" id="h2-1-1579" class="i">+  if (!git_commit_lookup(&amp;commit, repo, id) &amp;&amp;
</a><a href="#h2-1-1580" id="h2-1-1580" class="i">+      !git_commit_tree(&amp;tree, commit))
</a><a href="#h2-1-1581" id="h2-1-1581" class="i">+    ret = writefilestree(fp, tree, &quot;&quot;);
</a> 
<a href="#h2-1-1583" id="h2-1-1583" class="d">-	fputs(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&quot;, fp);
</a><a href="#h2-1-1584" id="h2-1-1584" class="i">+  fputs(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&quot;, fp);
</a> 
<a href="#h2-1-1586" id="h2-1-1586" class="d">-	git_commit_free(commit);
</a><a href="#h2-1-1587" id="h2-1-1587" class="d">-	git_tree_free(tree);
</a><a href="#h2-1-1588" id="h2-1-1588" class="i">+  git_commit_free(commit);
</a><a href="#h2-1-1589" id="h2-1-1589" class="i">+  git_tree_free(tree);
</a> 
<a href="#h2-1-1591" id="h2-1-1591" class="d">-	return ret;
</a><a href="#h2-1-1592" id="h2-1-1592" class="i">+  return ret;
</a> }
 
 int
 refs_cmp(const void *v1, const void *v2)
 {
<a href="#h2-1-1598" id="h2-1-1598" class="d">-	git_reference *r1 = (*(git_reference **)v1);
</a><a href="#h2-1-1599" id="h2-1-1599" class="d">-	git_reference *r2 = (*(git_reference **)v2);
</a><a href="#h2-1-1600" id="h2-1-1600" class="d">-	int r;
</a><a href="#h2-1-1601" id="h2-1-1601" class="i">+  git_reference *r1 = (*(git_reference **)v1);
</a><a href="#h2-1-1602" id="h2-1-1602" class="i">+  git_reference *r2 = (*(git_reference **)v2);
</a><a href="#h2-1-1603" id="h2-1-1603" class="i">+  int r;
</a> 
<a href="#h2-1-1605" id="h2-1-1605" class="d">-	if ((r = git_reference_is_branch(r1) - git_reference_is_branch(r2)))
</a><a href="#h2-1-1606" id="h2-1-1606" class="d">-		return r;
</a><a href="#h2-1-1607" id="h2-1-1607" class="i">+  if ((r = git_reference_is_branch(r1) - git_reference_is_branch(r2)))
</a><a href="#h2-1-1608" id="h2-1-1608" class="i">+    return r;
</a> 
<a href="#h2-1-1610" id="h2-1-1610" class="d">-	return strcmp(git_reference_shorthand(r1),
</a><a href="#h2-1-1611" id="h2-1-1611" class="d">-	              git_reference_shorthand(r2));
</a><a href="#h2-1-1612" id="h2-1-1612" class="i">+  return strcmp(git_reference_shorthand(r1),
</a><a href="#h2-1-1613" id="h2-1-1613" class="i">+                git_reference_shorthand(r2));
</a> }
 
 int
 writerefs(FILE *fp)
 {
<a href="#h2-1-1619" id="h2-1-1619" class="d">-	struct commitinfo *ci;
</a><a href="#h2-1-1620" id="h2-1-1620" class="d">-	const git_oid *id = NULL;
</a><a href="#h2-1-1621" id="h2-1-1621" class="d">-	git_object *obj = NULL;
</a><a href="#h2-1-1622" id="h2-1-1622" class="d">-	git_reference *dref = NULL, *r, *ref = NULL;
</a><a href="#h2-1-1623" id="h2-1-1623" class="d">-	git_reference_iterator *it = NULL;
</a><a href="#h2-1-1624" id="h2-1-1624" class="d">-	git_reference **refs = NULL;
</a><a href="#h2-1-1625" id="h2-1-1625" class="d">-	size_t count, i, j, refcount;
</a><a href="#h2-1-1626" id="h2-1-1626" class="d">-	const char *titles[] = { &quot;Branches&quot;, &quot;Tags&quot; };
</a><a href="#h2-1-1627" id="h2-1-1627" class="d">-	const char *ids[] = { &quot;branches&quot;, &quot;tags&quot; };
</a><a href="#h2-1-1628" id="h2-1-1628" class="d">-	const char *name;
</a><a href="#h2-1-1629" id="h2-1-1629" class="d">-
</a><a href="#h2-1-1630" id="h2-1-1630" class="d">-	if (git_reference_iterator_new(&amp;it, repo))
</a><a href="#h2-1-1631" id="h2-1-1631" class="d">-		return -1;
</a><a href="#h2-1-1632" id="h2-1-1632" class="d">-
</a><a href="#h2-1-1633" id="h2-1-1633" class="d">-	for (refcount = 0; !git_reference_next(&amp;ref, it); refcount++) {
</a><a href="#h2-1-1634" id="h2-1-1634" class="d">-		if (!(refs = reallocarray(refs, refcount + 1, sizeof(git_reference *))))
</a><a href="#h2-1-1635" id="h2-1-1635" class="d">-			err(1, &quot;realloc&quot;);
</a><a href="#h2-1-1636" id="h2-1-1636" class="d">-		refs[refcount] = ref;
</a><a href="#h2-1-1637" id="h2-1-1637" class="d">-	}
</a><a href="#h2-1-1638" id="h2-1-1638" class="d">-	git_reference_iterator_free(it);
</a><a href="#h2-1-1639" id="h2-1-1639" class="d">-
</a><a href="#h2-1-1640" id="h2-1-1640" class="d">-	/* sort by type then shorthand name */
</a><a href="#h2-1-1641" id="h2-1-1641" class="d">-	qsort(refs, refcount, sizeof(git_reference *), refs_cmp);
</a><a href="#h2-1-1642" id="h2-1-1642" class="d">-
</a><a href="#h2-1-1643" id="h2-1-1643" class="d">-	for (j = 0; j &lt; 2; j++) {
</a><a href="#h2-1-1644" id="h2-1-1644" class="d">-		for (i = 0, count = 0; i &lt; refcount; i++) {
</a><a href="#h2-1-1645" id="h2-1-1645" class="d">-			if (!(git_reference_is_branch(refs[i]) &amp;&amp; j == 0) &amp;&amp;
</a><a href="#h2-1-1646" id="h2-1-1646" class="d">-			    !(git_reference_is_tag(refs[i]) &amp;&amp; j == 1))
</a><a href="#h2-1-1647" id="h2-1-1647" class="d">-				continue;
</a><a href="#h2-1-1648" id="h2-1-1648" class="d">-
</a><a href="#h2-1-1649" id="h2-1-1649" class="d">-			switch (git_reference_type(refs[i])) {
</a><a href="#h2-1-1650" id="h2-1-1650" class="d">-			case GIT_REF_SYMBOLIC:
</a><a href="#h2-1-1651" id="h2-1-1651" class="d">-				if (git_reference_resolve(&amp;dref, refs[i]))
</a><a href="#h2-1-1652" id="h2-1-1652" class="d">-					goto err;
</a><a href="#h2-1-1653" id="h2-1-1653" class="d">-				r = dref;
</a><a href="#h2-1-1654" id="h2-1-1654" class="d">-				break;
</a><a href="#h2-1-1655" id="h2-1-1655" class="d">-			case GIT_REF_OID:
</a><a href="#h2-1-1656" id="h2-1-1656" class="d">-				r = refs[i];
</a><a href="#h2-1-1657" id="h2-1-1657" class="d">-				break;
</a><a href="#h2-1-1658" id="h2-1-1658" class="d">-			default:
</a><a href="#h2-1-1659" id="h2-1-1659" class="d">-				continue;
</a><a href="#h2-1-1660" id="h2-1-1660" class="d">-			}
</a><a href="#h2-1-1661" id="h2-1-1661" class="d">-			if (!git_reference_target(r) ||
</a><a href="#h2-1-1662" id="h2-1-1662" class="d">-			    git_reference_peel(&amp;obj, r, GIT_OBJ_ANY))
</a><a href="#h2-1-1663" id="h2-1-1663" class="d">-				goto err;
</a><a href="#h2-1-1664" id="h2-1-1664" class="d">-			if (!(id = git_object_id(obj)))
</a><a href="#h2-1-1665" id="h2-1-1665" class="d">-				goto err;
</a><a href="#h2-1-1666" id="h2-1-1666" class="d">-			if (!(ci = commitinfo_getbyoid(id)))
</a><a href="#h2-1-1667" id="h2-1-1667" class="d">-				break;
</a><a href="#h2-1-1668" id="h2-1-1668" class="d">-
</a><a href="#h2-1-1669" id="h2-1-1669" class="d">-			/* print header if it has an entry (first). */
</a><a href="#h2-1-1670" id="h2-1-1670" class="d">-			if (++count == 1) {
</a><a href="#h2-1-1671" id="h2-1-1671" class="d">-				fprintf(fp, &quot;&lt;h2&gt;%s&lt;/h2&gt;&lt;div id=\&quot;table-scroll\&quot;&gt;&lt;table id=\&quot;%s\&quot;&gt;&quot;
</a><a href="#h2-1-1672" id="h2-1-1672" class="d">-			                &quot;&lt;thead&gt;\n&lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&quot;
</a><a href="#h2-1-1673" id="h2-1-1673" class="d">-				        &quot;&lt;th&gt;Last commit date&lt;/th&gt;&quot;
</a><a href="#h2-1-1674" id="h2-1-1674" class="d">-				        &quot;&lt;th&gt;Author&lt;/th&gt;\n&lt;/tr&gt;\n&quot;
</a><a href="#h2-1-1675" id="h2-1-1675" class="d">-				        &quot;&lt;/thead&gt;&lt;tbody&gt;\n&quot;,
</a><a href="#h2-1-1676" id="h2-1-1676" class="d">-				         titles[j], ids[j]);
</a><a href="#h2-1-1677" id="h2-1-1677" class="d">-			}
</a><a href="#h2-1-1678" id="h2-1-1678" class="d">-
</a><a href="#h2-1-1679" id="h2-1-1679" class="d">-			relpath = &quot;&quot;;
</a><a href="#h2-1-1680" id="h2-1-1680" class="d">-			name = git_reference_shorthand(r);
</a><a href="#h2-1-1681" id="h2-1-1681" class="d">-
</a><a href="#h2-1-1682" id="h2-1-1682" class="d">-			fputs(&quot;&lt;tr&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-1683" id="h2-1-1683" class="d">-			xmlencode(fp, name, strlen(name));
</a><a href="#h2-1-1684" id="h2-1-1684" class="d">-			fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-1685" id="h2-1-1685" class="d">-			if (ci-&gt;author)
</a><a href="#h2-1-1686" id="h2-1-1686" class="d">-				printtimeshort(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-1687" id="h2-1-1687" class="d">-			fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-1688" id="h2-1-1688" class="d">-			if (ci-&gt;author)
</a><a href="#h2-1-1689" id="h2-1-1689" class="d">-				xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-1690" id="h2-1-1690" class="d">-			fputs(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-1691" id="h2-1-1691" class="d">-
</a><a href="#h2-1-1692" id="h2-1-1692" class="d">-			relpath = &quot;../&quot;;
</a><a href="#h2-1-1693" id="h2-1-1693" class="d">-
</a><a href="#h2-1-1694" id="h2-1-1694" class="d">-			commitinfo_free(ci);
</a><a href="#h2-1-1695" id="h2-1-1695" class="d">-			git_object_free(obj);
</a><a href="#h2-1-1696" id="h2-1-1696" class="d">-			obj = NULL;
</a><a href="#h2-1-1697" id="h2-1-1697" class="d">-			git_reference_free(dref);
</a><a href="#h2-1-1698" id="h2-1-1698" class="d">-			dref = NULL;
</a><a href="#h2-1-1699" id="h2-1-1699" class="d">-		}
</a><a href="#h2-1-1700" id="h2-1-1700" class="d">-		/* table footer */
</a><a href="#h2-1-1701" id="h2-1-1701" class="d">-		if (count)
</a><a href="#h2-1-1702" id="h2-1-1702" class="d">-			fputs(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;br/&gt;&quot;, fp);
</a><a href="#h2-1-1703" id="h2-1-1703" class="d">-	}
</a><a href="#h2-1-1704" id="h2-1-1704" class="i">+  struct commitinfo *ci;
</a><a href="#h2-1-1705" id="h2-1-1705" class="i">+  const git_oid *id = NULL;
</a><a href="#h2-1-1706" id="h2-1-1706" class="i">+  git_object *obj = NULL;
</a><a href="#h2-1-1707" id="h2-1-1707" class="i">+  git_reference *dref = NULL, *r, *ref = NULL;
</a><a href="#h2-1-1708" id="h2-1-1708" class="i">+  git_reference_iterator *it = NULL;
</a><a href="#h2-1-1709" id="h2-1-1709" class="i">+  git_reference **refs = NULL;
</a><a href="#h2-1-1710" id="h2-1-1710" class="i">+  size_t count, i, j, refcount;
</a><a href="#h2-1-1711" id="h2-1-1711" class="i">+  const char *titles[] = { &quot;Branches&quot;, &quot;Tags&quot; };
</a><a href="#h2-1-1712" id="h2-1-1712" class="i">+  const char *ids[] = { &quot;branches&quot;, &quot;tags&quot; };
</a><a href="#h2-1-1713" id="h2-1-1713" class="i">+  const char *name;
</a><a href="#h2-1-1714" id="h2-1-1714" class="i">+
</a><a href="#h2-1-1715" id="h2-1-1715" class="i">+  if (git_reference_iterator_new(&amp;it, repo))
</a><a href="#h2-1-1716" id="h2-1-1716" class="i">+    return -1;
</a><a href="#h2-1-1717" id="h2-1-1717" class="i">+
</a><a href="#h2-1-1718" id="h2-1-1718" class="i">+  for (refcount = 0; !git_reference_next(&amp;ref, it); refcount++) {
</a><a href="#h2-1-1719" id="h2-1-1719" class="i">+    if (!(refs = reallocarray(refs, refcount + 1, sizeof(git_reference *))))
</a><a href="#h2-1-1720" id="h2-1-1720" class="i">+      err(1, &quot;realloc&quot;);
</a><a href="#h2-1-1721" id="h2-1-1721" class="i">+    refs[refcount] = ref;
</a><a href="#h2-1-1722" id="h2-1-1722" class="i">+  }
</a><a href="#h2-1-1723" id="h2-1-1723" class="i">+  git_reference_iterator_free(it);
</a><a href="#h2-1-1724" id="h2-1-1724" class="i">+
</a><a href="#h2-1-1725" id="h2-1-1725" class="i">+  /* sort by type then shorthand name */
</a><a href="#h2-1-1726" id="h2-1-1726" class="i">+  qsort(refs, refcount, sizeof(git_reference *), refs_cmp);
</a><a href="#h2-1-1727" id="h2-1-1727" class="i">+
</a><a href="#h2-1-1728" id="h2-1-1728" class="i">+  for (j = 0; j &lt; 2; j++) {
</a><a href="#h2-1-1729" id="h2-1-1729" class="i">+    for (i = 0, count = 0; i &lt; refcount; i++) {
</a><a href="#h2-1-1730" id="h2-1-1730" class="i">+      if (!(git_reference_is_branch(refs[i]) &amp;&amp; j == 0) &amp;&amp;
</a><a href="#h2-1-1731" id="h2-1-1731" class="i">+          !(git_reference_is_tag(refs[i]) &amp;&amp; j == 1))
</a><a href="#h2-1-1732" id="h2-1-1732" class="i">+        continue;
</a><a href="#h2-1-1733" id="h2-1-1733" class="i">+
</a><a href="#h2-1-1734" id="h2-1-1734" class="i">+      switch (git_reference_type(refs[i])) {
</a><a href="#h2-1-1735" id="h2-1-1735" class="i">+      case GIT_REF_SYMBOLIC:
</a><a href="#h2-1-1736" id="h2-1-1736" class="i">+        if (git_reference_resolve(&amp;dref, refs[i]))
</a><a href="#h2-1-1737" id="h2-1-1737" class="i">+          goto err;
</a><a href="#h2-1-1738" id="h2-1-1738" class="i">+        r = dref;
</a><a href="#h2-1-1739" id="h2-1-1739" class="i">+        break;
</a><a href="#h2-1-1740" id="h2-1-1740" class="i">+      case GIT_REF_OID:
</a><a href="#h2-1-1741" id="h2-1-1741" class="i">+        r = refs[i];
</a><a href="#h2-1-1742" id="h2-1-1742" class="i">+        break;
</a><a href="#h2-1-1743" id="h2-1-1743" class="i">+      default:
</a><a href="#h2-1-1744" id="h2-1-1744" class="i">+        continue;
</a><a href="#h2-1-1745" id="h2-1-1745" class="i">+      }
</a><a href="#h2-1-1746" id="h2-1-1746" class="i">+      if (!git_reference_target(r) ||
</a><a href="#h2-1-1747" id="h2-1-1747" class="i">+          git_reference_peel(&amp;obj, r, GIT_OBJ_ANY))
</a><a href="#h2-1-1748" id="h2-1-1748" class="i">+        goto err;
</a><a href="#h2-1-1749" id="h2-1-1749" class="i">+      if (!(id = git_object_id(obj)))
</a><a href="#h2-1-1750" id="h2-1-1750" class="i">+        goto err;
</a><a href="#h2-1-1751" id="h2-1-1751" class="i">+      if (!(ci = commitinfo_getbyoid(id)))
</a><a href="#h2-1-1752" id="h2-1-1752" class="i">+        break;
</a><a href="#h2-1-1753" id="h2-1-1753" class="i">+
</a><a href="#h2-1-1754" id="h2-1-1754" class="i">+      /* print header if it has an entry (first). */
</a><a href="#h2-1-1755" id="h2-1-1755" class="i">+      if (++count == 1) {
</a><a href="#h2-1-1756" id="h2-1-1756" class="i">+        fprintf(fp, &quot;&lt;h2&gt;%s&lt;/h2&gt;&lt;div id=\&quot;table-scroll\&quot;&gt;&lt;table id=\&quot;%s\&quot;&gt;&quot;
</a><a href="#h2-1-1757" id="h2-1-1757" class="i">+                      &quot;&lt;thead&gt;\n&lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&quot;
</a><a href="#h2-1-1758" id="h2-1-1758" class="i">+                &quot;&lt;th&gt;Last commit date&lt;/th&gt;&quot;
</a><a href="#h2-1-1759" id="h2-1-1759" class="i">+                &quot;&lt;th&gt;Author&lt;/th&gt;\n&lt;/tr&gt;\n&quot;
</a><a href="#h2-1-1760" id="h2-1-1760" class="i">+                &quot;&lt;/thead&gt;&lt;tbody&gt;\n&quot;,
</a><a href="#h2-1-1761" id="h2-1-1761" class="i">+                 titles[j], ids[j]);
</a><a href="#h2-1-1762" id="h2-1-1762" class="i">+      }
</a><a href="#h2-1-1763" id="h2-1-1763" class="i">+
</a><a href="#h2-1-1764" id="h2-1-1764" class="i">+      relpath = &quot;&quot;;
</a><a href="#h2-1-1765" id="h2-1-1765" class="i">+      name = git_reference_shorthand(r);
</a><a href="#h2-1-1766" id="h2-1-1766" class="i">+
</a><a href="#h2-1-1767" id="h2-1-1767" class="i">+      fputs(&quot;&lt;tr&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-1768" id="h2-1-1768" class="i">+      xmlencode(fp, name, strlen(name));
</a><a href="#h2-1-1769" id="h2-1-1769" class="i">+      fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-1770" id="h2-1-1770" class="i">+      if (ci-&gt;author)
</a><a href="#h2-1-1771" id="h2-1-1771" class="i">+        printtimeshort(fp, &amp;(ci-&gt;author-&gt;when));
</a><a href="#h2-1-1772" id="h2-1-1772" class="i">+      fputs(&quot;&lt;/td&gt;&lt;td&gt;&quot;, fp);
</a><a href="#h2-1-1773" id="h2-1-1773" class="i">+      if (ci-&gt;author)
</a><a href="#h2-1-1774" id="h2-1-1774" class="i">+        xmlencode(fp, ci-&gt;author-&gt;name, strlen(ci-&gt;author-&gt;name));
</a><a href="#h2-1-1775" id="h2-1-1775" class="i">+      fputs(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;, fp);
</a><a href="#h2-1-1776" id="h2-1-1776" class="i">+
</a><a href="#h2-1-1777" id="h2-1-1777" class="i">+      relpath = &quot;../&quot;;
</a><a href="#h2-1-1778" id="h2-1-1778" class="i">+
</a><a href="#h2-1-1779" id="h2-1-1779" class="i">+      commitinfo_free(ci);
</a><a href="#h2-1-1780" id="h2-1-1780" class="i">+      git_object_free(obj);
</a><a href="#h2-1-1781" id="h2-1-1781" class="i">+      obj = NULL;
</a><a href="#h2-1-1782" id="h2-1-1782" class="i">+      git_reference_free(dref);
</a><a href="#h2-1-1783" id="h2-1-1783" class="i">+      dref = NULL;
</a><a href="#h2-1-1784" id="h2-1-1784" class="i">+    }
</a><a href="#h2-1-1785" id="h2-1-1785" class="i">+    /* table footer */
</a><a href="#h2-1-1786" id="h2-1-1786" class="i">+    if (count)
</a><a href="#h2-1-1787" id="h2-1-1787" class="i">+      fputs(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;br/&gt;&quot;, fp);
</a><a href="#h2-1-1788" id="h2-1-1788" class="i">+  }
</a> 
 err:
<a href="#h2-1-1791" id="h2-1-1791" class="d">-	git_object_free(obj);
</a><a href="#h2-1-1792" id="h2-1-1792" class="d">-	git_reference_free(dref);
</a><a href="#h2-1-1793" id="h2-1-1793" class="i">+  git_object_free(obj);
</a><a href="#h2-1-1794" id="h2-1-1794" class="i">+  git_reference_free(dref);
</a> 
<a href="#h2-1-1796" id="h2-1-1796" class="d">-	for (i = 0; i &lt; refcount; i++)
</a><a href="#h2-1-1797" id="h2-1-1797" class="d">-		git_reference_free(refs[i]);
</a><a href="#h2-1-1798" id="h2-1-1798" class="d">-	free(refs);
</a><a href="#h2-1-1799" id="h2-1-1799" class="i">+  for (i = 0; i &lt; refcount; i++)
</a><a href="#h2-1-1800" id="h2-1-1800" class="i">+    git_reference_free(refs[i]);
</a><a href="#h2-1-1801" id="h2-1-1801" class="i">+  free(refs);
</a> 
<a href="#h2-1-1803" id="h2-1-1803" class="d">-	return 0;
</a><a href="#h2-1-1804" id="h2-1-1804" class="i">+  return 0;
</a> }
 
 void
 usage(char *argv0)
 {
<a href="#h2-1-1810" id="h2-1-1810" class="d">-	fprintf(stderr, &quot;%s [-c cachefile | -l commits] repodir\n&quot;, argv0);
</a><a href="#h2-1-1811" id="h2-1-1811" class="d">-	exit(1);
</a><a href="#h2-1-1812" id="h2-1-1812" class="i">+  fprintf(stderr, &quot;%s [-c cachefile | -l commits] repodir\n&quot;, argv0);
</a><a href="#h2-1-1813" id="h2-1-1813" class="i">+  exit(1);
</a> }
 
 int
 main(int argc, char *argv[])
 {
<a href="#h2-1-1819" id="h2-1-1819" class="d">-	git_object *obj = NULL;
</a><a href="#h2-1-1820" id="h2-1-1820" class="d">-	const git_oid *head = NULL;
</a><a href="#h2-1-1821" id="h2-1-1821" class="d">-	mode_t mask;
</a><a href="#h2-1-1822" id="h2-1-1822" class="d">-	FILE *fp, *fpread;
</a><a href="#h2-1-1823" id="h2-1-1823" class="d">-	char path[PATH_MAX], repodirabs[PATH_MAX + 1], *p;
</a><a href="#h2-1-1824" id="h2-1-1824" class="d">-	char tmppath[64] = &quot;cache.XXXXXXXXXXXX&quot;, buf[BUFSIZ];
</a><a href="#h2-1-1825" id="h2-1-1825" class="d">-	size_t n;
</a><a href="#h2-1-1826" id="h2-1-1826" class="d">-	int i, fd;
</a><a href="#h2-1-1827" id="h2-1-1827" class="d">-
</a><a href="#h2-1-1828" id="h2-1-1828" class="d">-	for (i = 1; i &lt; argc; i++) {
</a><a href="#h2-1-1829" id="h2-1-1829" class="d">-		if (argv[i][0] != &#39;-&#39;) {
</a><a href="#h2-1-1830" id="h2-1-1830" class="d">-			if (repodir)
</a><a href="#h2-1-1831" id="h2-1-1831" class="d">-				usage(argv[0]);
</a><a href="#h2-1-1832" id="h2-1-1832" class="d">-			repodir = argv[i];
</a><a href="#h2-1-1833" id="h2-1-1833" class="d">-		} else if (argv[i][1] == &#39;c&#39;) {
</a><a href="#h2-1-1834" id="h2-1-1834" class="d">-			if (nlogcommits &gt; 0 || i + 1 &gt;= argc)
</a><a href="#h2-1-1835" id="h2-1-1835" class="d">-				usage(argv[0]);
</a><a href="#h2-1-1836" id="h2-1-1836" class="d">-			cachefile = argv[++i];
</a><a href="#h2-1-1837" id="h2-1-1837" class="d">-		} else if (argv[i][1] == &#39;l&#39;) {
</a><a href="#h2-1-1838" id="h2-1-1838" class="d">-			if (cachefile || i + 1 &gt;= argc)
</a><a href="#h2-1-1839" id="h2-1-1839" class="d">-				usage(argv[0]);
</a><a href="#h2-1-1840" id="h2-1-1840" class="d">-			errno = 0;
</a><a href="#h2-1-1841" id="h2-1-1841" class="d">-			nlogcommits = strtoll(argv[++i], &amp;p, 10);
</a><a href="#h2-1-1842" id="h2-1-1842" class="d">-			if (argv[i][0] == &#39;\0&#39; || *p != &#39;\0&#39; ||
</a><a href="#h2-1-1843" id="h2-1-1843" class="d">-			    nlogcommits &lt;= 0 || errno)
</a><a href="#h2-1-1844" id="h2-1-1844" class="d">-				usage(argv[0]);
</a><a href="#h2-1-1845" id="h2-1-1845" class="d">-		}
</a><a href="#h2-1-1846" id="h2-1-1846" class="d">-	}
</a><a href="#h2-1-1847" id="h2-1-1847" class="d">-	if (!repodir)
</a><a href="#h2-1-1848" id="h2-1-1848" class="d">-		usage(argv[0]);
</a><a href="#h2-1-1849" id="h2-1-1849" class="d">-
</a><a href="#h2-1-1850" id="h2-1-1850" class="d">-	if (!realpath(repodir, repodirabs))
</a><a href="#h2-1-1851" id="h2-1-1851" class="d">-		err(1, &quot;realpath&quot;);
</a><a href="#h2-1-1852" id="h2-1-1852" class="d">-
</a><a href="#h2-1-1853" id="h2-1-1853" class="d">-	git_libgit2_init();
</a><a href="#h2-1-1854" id="h2-1-1854" class="i">+  git_object *obj = NULL;
</a><a href="#h2-1-1855" id="h2-1-1855" class="i">+  const git_oid *head = NULL;
</a><a href="#h2-1-1856" id="h2-1-1856" class="i">+  mode_t mask;
</a><a href="#h2-1-1857" id="h2-1-1857" class="i">+  FILE *fp, *fpread;
</a><a href="#h2-1-1858" id="h2-1-1858" class="i">+  char path[PATH_MAX], repodirabs[PATH_MAX + 1], *p;
</a><a href="#h2-1-1859" id="h2-1-1859" class="i">+  char tmppath[64] = &quot;cache.XXXXXXXXXXXX&quot;, buf[BUFSIZ];
</a><a href="#h2-1-1860" id="h2-1-1860" class="i">+  size_t n;
</a><a href="#h2-1-1861" id="h2-1-1861" class="i">+  int i, fd;
</a><a href="#h2-1-1862" id="h2-1-1862" class="i">+
</a><a href="#h2-1-1863" id="h2-1-1863" class="i">+  for (i = 1; i &lt; argc; i++) {
</a><a href="#h2-1-1864" id="h2-1-1864" class="i">+    if (argv[i][0] != &#39;-&#39;) {
</a><a href="#h2-1-1865" id="h2-1-1865" class="i">+      if (repodir)
</a><a href="#h2-1-1866" id="h2-1-1866" class="i">+        usage(argv[0]);
</a><a href="#h2-1-1867" id="h2-1-1867" class="i">+      repodir = argv[i];
</a><a href="#h2-1-1868" id="h2-1-1868" class="i">+    } else if (argv[i][1] == &#39;c&#39;) {
</a><a href="#h2-1-1869" id="h2-1-1869" class="i">+      if (nlogcommits &gt; 0 || i + 1 &gt;= argc)
</a><a href="#h2-1-1870" id="h2-1-1870" class="i">+        usage(argv[0]);
</a><a href="#h2-1-1871" id="h2-1-1871" class="i">+      cachefile = argv[++i];
</a><a href="#h2-1-1872" id="h2-1-1872" class="i">+    } else if (argv[i][1] == &#39;l&#39;) {
</a><a href="#h2-1-1873" id="h2-1-1873" class="i">+      if (cachefile || i + 1 &gt;= argc)
</a><a href="#h2-1-1874" id="h2-1-1874" class="i">+        usage(argv[0]);
</a><a href="#h2-1-1875" id="h2-1-1875" class="i">+      errno = 0;
</a><a href="#h2-1-1876" id="h2-1-1876" class="i">+      nlogcommits = strtoll(argv[++i], &amp;p, 10);
</a><a href="#h2-1-1877" id="h2-1-1877" class="i">+      if (argv[i][0] == &#39;\0&#39; || *p != &#39;\0&#39; ||
</a><a href="#h2-1-1878" id="h2-1-1878" class="i">+          nlogcommits &lt;= 0 || errno)
</a><a href="#h2-1-1879" id="h2-1-1879" class="i">+        usage(argv[0]);
</a><a href="#h2-1-1880" id="h2-1-1880" class="i">+    }
</a><a href="#h2-1-1881" id="h2-1-1881" class="i">+  }
</a><a href="#h2-1-1882" id="h2-1-1882" class="i">+  if (!repodir)
</a><a href="#h2-1-1883" id="h2-1-1883" class="i">+    usage(argv[0]);
</a><a href="#h2-1-1884" id="h2-1-1884" class="i">+
</a><a href="#h2-1-1885" id="h2-1-1885" class="i">+  if (!realpath(repodir, repodirabs))
</a><a href="#h2-1-1886" id="h2-1-1886" class="i">+    err(1, &quot;realpath&quot;);
</a><a href="#h2-1-1887" id="h2-1-1887" class="i">+
</a><a href="#h2-1-1888" id="h2-1-1888" class="i">+  git_libgit2_init();
</a> 
 #ifdef __OpenBSD__
<a href="#h2-1-1891" id="h2-1-1891" class="d">-	if (unveil(repodir, &quot;r&quot;) == -1)
</a><a href="#h2-1-1892" id="h2-1-1892" class="d">-		err(1, &quot;unveil: %s&quot;, repodir);
</a><a href="#h2-1-1893" id="h2-1-1893" class="d">-	if (unveil(&quot;.&quot;, &quot;rwc&quot;) == -1)
</a><a href="#h2-1-1894" id="h2-1-1894" class="d">-		err(1, &quot;unveil: .&quot;);
</a><a href="#h2-1-1895" id="h2-1-1895" class="d">-	if (cachefile &amp;&amp; unveil(cachefile, &quot;rwc&quot;) == -1)
</a><a href="#h2-1-1896" id="h2-1-1896" class="d">-		err(1, &quot;unveil: %s&quot;, cachefile);
</a><a href="#h2-1-1897" id="h2-1-1897" class="d">-
</a><a href="#h2-1-1898" id="h2-1-1898" class="d">-	if (cachefile) {
</a><a href="#h2-1-1899" id="h2-1-1899" class="d">-		if (pledge(&quot;stdio rpath wpath cpath fattr&quot;, NULL) == -1)
</a><a href="#h2-1-1900" id="h2-1-1900" class="d">-			err(1, &quot;pledge&quot;);
</a><a href="#h2-1-1901" id="h2-1-1901" class="d">-	} else {
</a><a href="#h2-1-1902" id="h2-1-1902" class="d">-		if (pledge(&quot;stdio rpath wpath cpath&quot;, NULL) == -1)
</a><a href="#h2-1-1903" id="h2-1-1903" class="d">-			err(1, &quot;pledge&quot;);
</a><a href="#h2-1-1904" id="h2-1-1904" class="d">-	}
</a><a href="#h2-1-1905" id="h2-1-1905" class="i">+  if (unveil(repodir, &quot;r&quot;) == -1)
</a><a href="#h2-1-1906" id="h2-1-1906" class="i">+    err(1, &quot;unveil: %s&quot;, repodir);
</a><a href="#h2-1-1907" id="h2-1-1907" class="i">+  if (unveil(&quot;.&quot;, &quot;rwc&quot;) == -1)
</a><a href="#h2-1-1908" id="h2-1-1908" class="i">+    err(1, &quot;unveil: .&quot;);
</a><a href="#h2-1-1909" id="h2-1-1909" class="i">+  if (cachefile &amp;&amp; unveil(cachefile, &quot;rwc&quot;) == -1)
</a><a href="#h2-1-1910" id="h2-1-1910" class="i">+    err(1, &quot;unveil: %s&quot;, cachefile);
</a><a href="#h2-1-1911" id="h2-1-1911" class="i">+
</a><a href="#h2-1-1912" id="h2-1-1912" class="i">+  if (cachefile) {
</a><a href="#h2-1-1913" id="h2-1-1913" class="i">+    if (pledge(&quot;stdio rpath wpath cpath fattr&quot;, NULL) == -1)
</a><a href="#h2-1-1914" id="h2-1-1914" class="i">+      err(1, &quot;pledge&quot;);
</a><a href="#h2-1-1915" id="h2-1-1915" class="i">+  } else {
</a><a href="#h2-1-1916" id="h2-1-1916" class="i">+    if (pledge(&quot;stdio rpath wpath cpath&quot;, NULL) == -1)
</a><a href="#h2-1-1917" id="h2-1-1917" class="i">+      err(1, &quot;pledge&quot;);
</a><a href="#h2-1-1918" id="h2-1-1918" class="i">+  }
</a> #endif
 
<a href="#h2-1-1921" id="h2-1-1921" class="d">-	if (git_repository_open_ext(&amp;repo, repodir,
</a><a href="#h2-1-1922" id="h2-1-1922" class="d">-		GIT_REPOSITORY_OPEN_NO_SEARCH, NULL) &lt; 0) {
</a><a href="#h2-1-1923" id="h2-1-1923" class="d">-		fprintf(stderr, &quot;%s: cannot open repository\n&quot;, argv[0]);
</a><a href="#h2-1-1924" id="h2-1-1924" class="d">-		return 1;
</a><a href="#h2-1-1925" id="h2-1-1925" class="d">-	}
</a><a href="#h2-1-1926" id="h2-1-1926" class="d">-
</a><a href="#h2-1-1927" id="h2-1-1927" class="d">-	/* find HEAD */
</a><a href="#h2-1-1928" id="h2-1-1928" class="d">-	if (!git_revparse_single(&amp;obj, repo, &quot;HEAD&quot;))
</a><a href="#h2-1-1929" id="h2-1-1929" class="d">-		head = git_object_id(obj);
</a><a href="#h2-1-1930" id="h2-1-1930" class="d">-	git_object_free(obj);
</a><a href="#h2-1-1931" id="h2-1-1931" class="d">-
</a><a href="#h2-1-1932" id="h2-1-1932" class="d">-	/* use directory name as name */
</a><a href="#h2-1-1933" id="h2-1-1933" class="d">-	if ((name = strrchr(repodirabs, &#39;/&#39;)))
</a><a href="#h2-1-1934" id="h2-1-1934" class="d">-		name++;
</a><a href="#h2-1-1935" id="h2-1-1935" class="d">-	else
</a><a href="#h2-1-1936" id="h2-1-1936" class="d">-		name = &quot;&quot;;
</a><a href="#h2-1-1937" id="h2-1-1937" class="d">-
</a><a href="#h2-1-1938" id="h2-1-1938" class="d">-	/* strip .git suffix */
</a><a href="#h2-1-1939" id="h2-1-1939" class="d">-	if (!(strippedname = strdup(name)))
</a><a href="#h2-1-1940" id="h2-1-1940" class="d">-		err(1, &quot;strdup&quot;);
</a><a href="#h2-1-1941" id="h2-1-1941" class="d">-	if ((p = strrchr(strippedname, &#39;.&#39;)))
</a><a href="#h2-1-1942" id="h2-1-1942" class="d">-		if (!strcmp(p, &quot;.git&quot;))
</a><a href="#h2-1-1943" id="h2-1-1943" class="d">-			*p = &#39;\0&#39;;
</a><a href="#h2-1-1944" id="h2-1-1944" class="d">-
</a><a href="#h2-1-1945" id="h2-1-1945" class="d">-	/* read description or .git/description */
</a><a href="#h2-1-1946" id="h2-1-1946" class="d">-	joinpath(path, sizeof(path), repodir, &quot;description&quot;);
</a><a href="#h2-1-1947" id="h2-1-1947" class="d">-	if (!(fpread = fopen(path, &quot;r&quot;))) {
</a><a href="#h2-1-1948" id="h2-1-1948" class="d">-		joinpath(path, sizeof(path), repodir, &quot;.git/description&quot;);
</a><a href="#h2-1-1949" id="h2-1-1949" class="d">-		fpread = fopen(path, &quot;r&quot;);
</a><a href="#h2-1-1950" id="h2-1-1950" class="d">-	}
</a><a href="#h2-1-1951" id="h2-1-1951" class="d">-	if (fpread) {
</a><a href="#h2-1-1952" id="h2-1-1952" class="d">-		if (!fgets(description, sizeof(description), fpread))
</a><a href="#h2-1-1953" id="h2-1-1953" class="d">-			description[0] = &#39;\0&#39;;
</a><a href="#h2-1-1954" id="h2-1-1954" class="d">-		fclose(fpread);
</a><a href="#h2-1-1955" id="h2-1-1955" class="d">-	}
</a><a href="#h2-1-1956" id="h2-1-1956" class="d">-
</a><a href="#h2-1-1957" id="h2-1-1957" class="d">-	/* read url or .git/url */
</a><a href="#h2-1-1958" id="h2-1-1958" class="d">-	joinpath(path, sizeof(path), repodir, &quot;url&quot;);
</a><a href="#h2-1-1959" id="h2-1-1959" class="d">-	if (!(fpread = fopen(path, &quot;r&quot;))) {
</a><a href="#h2-1-1960" id="h2-1-1960" class="d">-		joinpath(path, sizeof(path), repodir, &quot;.git/url&quot;);
</a><a href="#h2-1-1961" id="h2-1-1961" class="d">-		fpread = fopen(path, &quot;r&quot;);
</a><a href="#h2-1-1962" id="h2-1-1962" class="d">-	}
</a><a href="#h2-1-1963" id="h2-1-1963" class="d">-	if (fpread) {
</a><a href="#h2-1-1964" id="h2-1-1964" class="d">-		if (!fgets(cloneurl, sizeof(cloneurl), fpread))
</a><a href="#h2-1-1965" id="h2-1-1965" class="d">-			cloneurl[0] = &#39;\0&#39;;
</a><a href="#h2-1-1966" id="h2-1-1966" class="d">-		cloneurl[strcspn(cloneurl, &quot;\n&quot;)] = &#39;\0&#39;;
</a><a href="#h2-1-1967" id="h2-1-1967" class="d">-		fclose(fpread);
</a><a href="#h2-1-1968" id="h2-1-1968" class="d">-	}
</a><a href="#h2-1-1969" id="h2-1-1969" class="d">-
</a><a href="#h2-1-1970" id="h2-1-1970" class="d">-	/* check LICENSE */
</a><a href="#h2-1-1971" id="h2-1-1971" class="d">-	for (i = 0; i &lt; sizeof(licensefiles) / sizeof(*licensefiles) &amp;&amp; !license; i++) {
</a><a href="#h2-1-1972" id="h2-1-1972" class="d">-		if (!git_revparse_single(&amp;obj, repo, licensefiles[i]) &amp;&amp;
</a><a href="#h2-1-1973" id="h2-1-1973" class="d">-		    git_object_type(obj) == GIT_OBJ_BLOB)
</a><a href="#h2-1-1974" id="h2-1-1974" class="d">-			license = licensefiles[i] + strlen(&quot;HEAD:&quot;);
</a><a href="#h2-1-1975" id="h2-1-1975" class="d">-		git_object_free(obj);
</a><a href="#h2-1-1976" id="h2-1-1976" class="d">-	}
</a><a href="#h2-1-1977" id="h2-1-1977" class="d">-
</a><a href="#h2-1-1978" id="h2-1-1978" class="d">-	/* check README */
</a><a href="#h2-1-1979" id="h2-1-1979" class="d">-	for (i = 0; i &lt; sizeof(readmefiles) / sizeof(*readmefiles) &amp;&amp; !readme; i++) {
</a><a href="#h2-1-1980" id="h2-1-1980" class="d">-		if (!git_revparse_single(&amp;obj, repo, readmefiles[i]) &amp;&amp;
</a><a href="#h2-1-1981" id="h2-1-1981" class="d">-		    git_object_type(obj) == GIT_OBJ_BLOB)
</a><a href="#h2-1-1982" id="h2-1-1982" class="d">-			readme = readmefiles[i] + strlen(&quot;HEAD:&quot;);
</a><a href="#h2-1-1983" id="h2-1-1983" class="d">-		git_object_free(obj);
</a><a href="#h2-1-1984" id="h2-1-1984" class="d">-	}
</a><a href="#h2-1-1985" id="h2-1-1985" class="d">-
</a><a href="#h2-1-1986" id="h2-1-1986" class="d">-	if (!git_revparse_single(&amp;obj, repo, &quot;HEAD:.gitmodules&quot;) &amp;&amp;
</a><a href="#h2-1-1987" id="h2-1-1987" class="d">-	    git_object_type(obj) == GIT_OBJ_BLOB)
</a><a href="#h2-1-1988" id="h2-1-1988" class="d">-		submodules = &quot;.gitmodules&quot;;
</a><a href="#h2-1-1989" id="h2-1-1989" class="d">-	git_object_free(obj);
</a><a href="#h2-1-1990" id="h2-1-1990" class="d">-
</a><a href="#h2-1-1991" id="h2-1-1991" class="d">-	/* log for HEAD */
</a><a href="#h2-1-1992" id="h2-1-1992" class="d">-	fp = efopen(&quot;index.html&quot;, &quot;w&quot;);
</a><a href="#h2-1-1993" id="h2-1-1993" class="d">-	relpath = &quot;&quot;;
</a><a href="#h2-1-1994" id="h2-1-1994" class="d">-	mkdir(&quot;commit&quot;, S_IRWXU | S_IRWXG | S_IRWXO);
</a><a href="#h2-1-1995" id="h2-1-1995" class="d">-	writeheader(fp, &quot;Log&quot;);
</a><a href="#h2-1-1996" id="h2-1-1996" class="d">-	fputs(&quot;&lt;div id=\&quot;table-scroll\&quot;&gt;&lt;table id=\&quot;log\&quot;&gt;&lt;thead&gt;\n&lt;tr&gt;&lt;th&gt;&quot;
</a><a href="#h2-1-1997" id="h2-1-1997" class="d">-				&quot;&lt;a href=\&quot;#\&quot;&gt;🔗&lt;/a&gt;&lt;/th&gt;&lt;th&gt;Date&lt;/th&gt;&quot;
</a><a href="#h2-1-1998" id="h2-1-1998" class="d">-	      &quot;&lt;th&gt;Commit message&lt;/th&gt;&quot;
</a><a href="#h2-1-1999" id="h2-1-1999" class="d">-	      &quot;&lt;th&gt;Author&lt;/th&gt;&lt;td class=\&quot;num\&quot;&gt;&lt;b&gt;Files&lt;/th&gt;&quot;
</a><a href="#h2-1-2000" id="h2-1-2000" class="d">-	      &quot;&lt;td class=\&quot;num\&quot; id=\&quot;plus\&quot;&gt;&lt;b&gt;+&lt;/th&gt;&quot;
</a><a href="#h2-1-2001" id="h2-1-2001" class="d">-	      &quot;&lt;td class=\&quot;num\&quot; id=\&quot;min\&quot;&gt;&lt;b&gt;-&lt;/th&gt;&lt;/tr&gt;\n&lt;/thead&gt;&lt;tbody&gt;\n&quot;, fp);
</a><a href="#h2-1-2002" id="h2-1-2002" class="d">-
</a><a href="#h2-1-2003" id="h2-1-2003" class="d">-	if (cachefile &amp;&amp; head) {
</a><a href="#h2-1-2004" id="h2-1-2004" class="d">-		/* read from cache file (does not need to exist) */
</a><a href="#h2-1-2005" id="h2-1-2005" class="d">-		if ((rcachefp = fopen(cachefile, &quot;r&quot;))) {
</a><a href="#h2-1-2006" id="h2-1-2006" class="d">-			if (!fgets(lastoidstr, sizeof(lastoidstr), rcachefp))
</a><a href="#h2-1-2007" id="h2-1-2007" class="d">-				errx(1, &quot;%s: no object id&quot;, cachefile);
</a><a href="#h2-1-2008" id="h2-1-2008" class="d">-			if (git_oid_fromstr(&amp;lastoid, lastoidstr))
</a><a href="#h2-1-2009" id="h2-1-2009" class="d">-				errx(1, &quot;%s: invalid object id&quot;, cachefile);
</a><a href="#h2-1-2010" id="h2-1-2010" class="d">-		}
</a><a href="#h2-1-2011" id="h2-1-2011" class="d">-
</a><a href="#h2-1-2012" id="h2-1-2012" class="d">-		/* write log to (temporary) cache */
</a><a href="#h2-1-2013" id="h2-1-2013" class="d">-		if ((fd = mkstemp(tmppath)) == -1)
</a><a href="#h2-1-2014" id="h2-1-2014" class="d">-			err(1, &quot;mkstemp&quot;);
</a><a href="#h2-1-2015" id="h2-1-2015" class="d">-		if (!(wcachefp = fdopen(fd, &quot;w&quot;)))
</a><a href="#h2-1-2016" id="h2-1-2016" class="d">-			err(1, &quot;fdopen: &#39;%s&#39;&quot;, tmppath);
</a><a href="#h2-1-2017" id="h2-1-2017" class="d">-		/* write last commit id (HEAD) */
</a><a href="#h2-1-2018" id="h2-1-2018" class="d">-		git_oid_tostr(buf, sizeof(buf), head);
</a><a href="#h2-1-2019" id="h2-1-2019" class="d">-		fprintf(wcachefp, &quot;%s\n&quot;, buf);
</a><a href="#h2-1-2020" id="h2-1-2020" class="d">-
</a><a href="#h2-1-2021" id="h2-1-2021" class="d">-		writelog(fp, head);
</a><a href="#h2-1-2022" id="h2-1-2022" class="d">-
</a><a href="#h2-1-2023" id="h2-1-2023" class="d">-		if (rcachefp) {
</a><a href="#h2-1-2024" id="h2-1-2024" class="d">-			/* append previous log to index.html and the new cache */
</a><a href="#h2-1-2025" id="h2-1-2025" class="d">-			while (!feof(rcachefp)) {
</a><a href="#h2-1-2026" id="h2-1-2026" class="d">-				n = fread(buf, 1, sizeof(buf), rcachefp);
</a><a href="#h2-1-2027" id="h2-1-2027" class="d">-				if (ferror(rcachefp))
</a><a href="#h2-1-2028" id="h2-1-2028" class="d">-					err(1, &quot;fread&quot;);
</a><a href="#h2-1-2029" id="h2-1-2029" class="d">-				if (fwrite(buf, 1, n, fp) != n ||
</a><a href="#h2-1-2030" id="h2-1-2030" class="d">-				    fwrite(buf, 1, n, wcachefp) != n)
</a><a href="#h2-1-2031" id="h2-1-2031" class="d">-					err(1, &quot;fwrite&quot;);
</a><a href="#h2-1-2032" id="h2-1-2032" class="d">-			}
</a><a href="#h2-1-2033" id="h2-1-2033" class="d">-			fclose(rcachefp);
</a><a href="#h2-1-2034" id="h2-1-2034" class="d">-		}
</a><a href="#h2-1-2035" id="h2-1-2035" class="d">-		fclose(wcachefp);
</a><a href="#h2-1-2036" id="h2-1-2036" class="d">-	} else {
</a><a href="#h2-1-2037" id="h2-1-2037" class="d">-		if (head)
</a><a href="#h2-1-2038" id="h2-1-2038" class="d">-			writelog(fp, head);
</a><a href="#h2-1-2039" id="h2-1-2039" class="d">-	}
</a><a href="#h2-1-2040" id="h2-1-2040" class="d">-
</a><a href="#h2-1-2041" id="h2-1-2041" class="d">-	fputs(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&quot;, fp);
</a><a href="#h2-1-2042" id="h2-1-2042" class="d">-	writefooter(fp);
</a><a href="#h2-1-2043" id="h2-1-2043" class="d">-	fclose(fp);
</a><a href="#h2-1-2044" id="h2-1-2044" class="d">-
</a><a href="#h2-1-2045" id="h2-1-2045" class="d">-	/* files for HEAD */
</a><a href="#h2-1-2046" id="h2-1-2046" class="d">-	fp = efopen(&quot;files.html&quot;, &quot;w&quot;);
</a><a href="#h2-1-2047" id="h2-1-2047" class="d">-	writeheader(fp, &quot;Files&quot;);
</a><a href="#h2-1-2048" id="h2-1-2048" class="d">-	if (head)
</a><a href="#h2-1-2049" id="h2-1-2049" class="d">-		writefiles(fp, head);
</a><a href="#h2-1-2050" id="h2-1-2050" class="d">-	writefooter(fp);
</a><a href="#h2-1-2051" id="h2-1-2051" class="d">-	fclose(fp);
</a><a href="#h2-1-2052" id="h2-1-2052" class="d">-
</a><a href="#h2-1-2053" id="h2-1-2053" class="d">-	/* summary page with branches and tags */
</a><a href="#h2-1-2054" id="h2-1-2054" class="d">-	fp = efopen(&quot;refs.html&quot;, &quot;w&quot;);
</a><a href="#h2-1-2055" id="h2-1-2055" class="d">-	writeheader(fp, &quot;Refs&quot;);
</a><a href="#h2-1-2056" id="h2-1-2056" class="d">-	writerefs(fp);
</a><a href="#h2-1-2057" id="h2-1-2057" class="d">-	writefooter(fp);
</a><a href="#h2-1-2058" id="h2-1-2058" class="d">-	fclose(fp);
</a><a href="#h2-1-2059" id="h2-1-2059" class="d">-
</a><a href="#h2-1-2060" id="h2-1-2060" class="d">-	/* Atom feed */
</a><a href="#h2-1-2061" id="h2-1-2061" class="d">-	fp = efopen(&quot;atom.xml&quot;, &quot;w&quot;);
</a><a href="#h2-1-2062" id="h2-1-2062" class="d">-	writeatom(fp);
</a><a href="#h2-1-2063" id="h2-1-2063" class="d">-	fclose(fp);
</a><a href="#h2-1-2064" id="h2-1-2064" class="d">-
</a><a href="#h2-1-2065" id="h2-1-2065" class="d">-	/* rename new cache file on success */
</a><a href="#h2-1-2066" id="h2-1-2066" class="d">-	if (cachefile &amp;&amp; head) {
</a><a href="#h2-1-2067" id="h2-1-2067" class="d">-		if (rename(tmppath, cachefile))
</a><a href="#h2-1-2068" id="h2-1-2068" class="d">-			err(1, &quot;rename: &#39;%s&#39; to &#39;%s&#39;&quot;, tmppath, cachefile);
</a><a href="#h2-1-2069" id="h2-1-2069" class="d">-		umask((mask = umask(0)));
</a><a href="#h2-1-2070" id="h2-1-2070" class="d">-		if (chmod(cachefile,
</a><a href="#h2-1-2071" id="h2-1-2071" class="d">-		    (S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP|S_IROTH|S_IWOTH) &amp; ~mask))
</a><a href="#h2-1-2072" id="h2-1-2072" class="d">-			err(1, &quot;chmod: &#39;%s&#39;&quot;, cachefile);
</a><a href="#h2-1-2073" id="h2-1-2073" class="d">-	}
</a><a href="#h2-1-2074" id="h2-1-2074" class="d">-
</a><a href="#h2-1-2075" id="h2-1-2075" class="d">-	/* cleanup */
</a><a href="#h2-1-2076" id="h2-1-2076" class="d">-	git_repository_free(repo);
</a><a href="#h2-1-2077" id="h2-1-2077" class="d">-	git_libgit2_shutdown();
</a><a href="#h2-1-2078" id="h2-1-2078" class="d">-
</a><a href="#h2-1-2079" id="h2-1-2079" class="d">-	return 0;
</a><a href="#h2-1-2080" id="h2-1-2080" class="i">+  if (git_repository_open_ext(&amp;repo, repodir,
</a><a href="#h2-1-2081" id="h2-1-2081" class="i">+    GIT_REPOSITORY_OPEN_NO_SEARCH, NULL) &lt; 0) {
</a><a href="#h2-1-2082" id="h2-1-2082" class="i">+    fprintf(stderr, &quot;%s: cannot open repository\n&quot;, argv[0]);
</a><a href="#h2-1-2083" id="h2-1-2083" class="i">+    return 1;
</a><a href="#h2-1-2084" id="h2-1-2084" class="i">+  }
</a><a href="#h2-1-2085" id="h2-1-2085" class="i">+
</a><a href="#h2-1-2086" id="h2-1-2086" class="i">+  /* find HEAD */
</a><a href="#h2-1-2087" id="h2-1-2087" class="i">+  if (!git_revparse_single(&amp;obj, repo, &quot;HEAD&quot;))
</a><a href="#h2-1-2088" id="h2-1-2088" class="i">+    head = git_object_id(obj);
</a><a href="#h2-1-2089" id="h2-1-2089" class="i">+  git_object_free(obj);
</a><a href="#h2-1-2090" id="h2-1-2090" class="i">+
</a><a href="#h2-1-2091" id="h2-1-2091" class="i">+  /* use directory name as name */
</a><a href="#h2-1-2092" id="h2-1-2092" class="i">+  if ((name = strrchr(repodirabs, &#39;/&#39;)))
</a><a href="#h2-1-2093" id="h2-1-2093" class="i">+    name++;
</a><a href="#h2-1-2094" id="h2-1-2094" class="i">+  else
</a><a href="#h2-1-2095" id="h2-1-2095" class="i">+    name = &quot;&quot;;
</a><a href="#h2-1-2096" id="h2-1-2096" class="i">+
</a><a href="#h2-1-2097" id="h2-1-2097" class="i">+  /* strip .git suffix */
</a><a href="#h2-1-2098" id="h2-1-2098" class="i">+  if (!(strippedname = strdup(name)))
</a><a href="#h2-1-2099" id="h2-1-2099" class="i">+    err(1, &quot;strdup&quot;);
</a><a href="#h2-1-2100" id="h2-1-2100" class="i">+  if ((p = strrchr(strippedname, &#39;.&#39;)))
</a><a href="#h2-1-2101" id="h2-1-2101" class="i">+    if (!strcmp(p, &quot;.git&quot;))
</a><a href="#h2-1-2102" id="h2-1-2102" class="i">+      *p = &#39;\0&#39;;
</a><a href="#h2-1-2103" id="h2-1-2103" class="i">+
</a><a href="#h2-1-2104" id="h2-1-2104" class="i">+  /* read description or .git/description */
</a><a href="#h2-1-2105" id="h2-1-2105" class="i">+  joinpath(path, sizeof(path), repodir, &quot;description&quot;);
</a><a href="#h2-1-2106" id="h2-1-2106" class="i">+  if (!(fpread = fopen(path, &quot;r&quot;))) {
</a><a href="#h2-1-2107" id="h2-1-2107" class="i">+    joinpath(path, sizeof(path), repodir, &quot;.git/description&quot;);
</a><a href="#h2-1-2108" id="h2-1-2108" class="i">+    fpread = fopen(path, &quot;r&quot;);
</a><a href="#h2-1-2109" id="h2-1-2109" class="i">+  }
</a><a href="#h2-1-2110" id="h2-1-2110" class="i">+  if (fpread) {
</a><a href="#h2-1-2111" id="h2-1-2111" class="i">+    if (!fgets(description, sizeof(description), fpread))
</a><a href="#h2-1-2112" id="h2-1-2112" class="i">+      description[0] = &#39;\0&#39;;
</a><a href="#h2-1-2113" id="h2-1-2113" class="i">+    fclose(fpread);
</a><a href="#h2-1-2114" id="h2-1-2114" class="i">+  }
</a><a href="#h2-1-2115" id="h2-1-2115" class="i">+
</a><a href="#h2-1-2116" id="h2-1-2116" class="i">+  /* read url or .git/url */
</a><a href="#h2-1-2117" id="h2-1-2117" class="i">+  joinpath(path, sizeof(path), repodir, &quot;url&quot;);
</a><a href="#h2-1-2118" id="h2-1-2118" class="i">+  if (!(fpread = fopen(path, &quot;r&quot;))) {
</a><a href="#h2-1-2119" id="h2-1-2119" class="i">+    joinpath(path, sizeof(path), repodir, &quot;.git/url&quot;);
</a><a href="#h2-1-2120" id="h2-1-2120" class="i">+    fpread = fopen(path, &quot;r&quot;);
</a><a href="#h2-1-2121" id="h2-1-2121" class="i">+  }
</a><a href="#h2-1-2122" id="h2-1-2122" class="i">+  if (fpread) {
</a><a href="#h2-1-2123" id="h2-1-2123" class="i">+    if (!fgets(cloneurl, sizeof(cloneurl), fpread))
</a><a href="#h2-1-2124" id="h2-1-2124" class="i">+      cloneurl[0] = &#39;\0&#39;;
</a><a href="#h2-1-2125" id="h2-1-2125" class="i">+    cloneurl[strcspn(cloneurl, &quot;\n&quot;)] = &#39;\0&#39;;
</a><a href="#h2-1-2126" id="h2-1-2126" class="i">+    fclose(fpread);
</a><a href="#h2-1-2127" id="h2-1-2127" class="i">+  }
</a><a href="#h2-1-2128" id="h2-1-2128" class="i">+
</a><a href="#h2-1-2129" id="h2-1-2129" class="i">+  /* check LICENSE */
</a><a href="#h2-1-2130" id="h2-1-2130" class="i">+  for (i = 0; i &lt; sizeof(licensefiles) / sizeof(*licensefiles) &amp;&amp; !license; i++) {
</a><a href="#h2-1-2131" id="h2-1-2131" class="i">+    if (!git_revparse_single(&amp;obj, repo, licensefiles[i]) &amp;&amp;
</a><a href="#h2-1-2132" id="h2-1-2132" class="i">+        git_object_type(obj) == GIT_OBJ_BLOB)
</a><a href="#h2-1-2133" id="h2-1-2133" class="i">+      license = licensefiles[i] + strlen(&quot;HEAD:&quot;);
</a><a href="#h2-1-2134" id="h2-1-2134" class="i">+    git_object_free(obj);
</a><a href="#h2-1-2135" id="h2-1-2135" class="i">+  }
</a><a href="#h2-1-2136" id="h2-1-2136" class="i">+
</a><a href="#h2-1-2137" id="h2-1-2137" class="i">+  /* check README */
</a><a href="#h2-1-2138" id="h2-1-2138" class="i">+  for (i = 0; i &lt; sizeof(readmefiles) / sizeof(*readmefiles) &amp;&amp; !readme; i++) {
</a><a href="#h2-1-2139" id="h2-1-2139" class="i">+    if (!git_revparse_single(&amp;obj, repo, readmefiles[i]) &amp;&amp;
</a><a href="#h2-1-2140" id="h2-1-2140" class="i">+        git_object_type(obj) == GIT_OBJ_BLOB)
</a><a href="#h2-1-2141" id="h2-1-2141" class="i">+      readme = readmefiles[i] + strlen(&quot;HEAD:&quot;);
</a><a href="#h2-1-2142" id="h2-1-2142" class="i">+    git_object_free(obj);
</a><a href="#h2-1-2143" id="h2-1-2143" class="i">+  }
</a><a href="#h2-1-2144" id="h2-1-2144" class="i">+
</a><a href="#h2-1-2145" id="h2-1-2145" class="i">+  if (!git_revparse_single(&amp;obj, repo, &quot;HEAD:.gitmodules&quot;) &amp;&amp;
</a><a href="#h2-1-2146" id="h2-1-2146" class="i">+      git_object_type(obj) == GIT_OBJ_BLOB)
</a><a href="#h2-1-2147" id="h2-1-2147" class="i">+    submodules = &quot;.gitmodules&quot;;
</a><a href="#h2-1-2148" id="h2-1-2148" class="i">+  git_object_free(obj);
</a><a href="#h2-1-2149" id="h2-1-2149" class="i">+
</a><a href="#h2-1-2150" id="h2-1-2150" class="i">+  /* log for HEAD */
</a><a href="#h2-1-2151" id="h2-1-2151" class="i">+  fp = efopen(&quot;index.html&quot;, &quot;w&quot;);
</a><a href="#h2-1-2152" id="h2-1-2152" class="i">+  relpath = &quot;&quot;;
</a><a href="#h2-1-2153" id="h2-1-2153" class="i">+  mkdir(&quot;commit&quot;, S_IRWXU | S_IRWXG | S_IRWXO);
</a><a href="#h2-1-2154" id="h2-1-2154" class="i">+  writeheader(fp, &quot;Log&quot;);
</a><a href="#h2-1-2155" id="h2-1-2155" class="i">+  fputs(&quot;&lt;div id=\&quot;table-scroll\&quot;&gt;&lt;table id=\&quot;log\&quot;&gt;&lt;thead&gt;\n&lt;tr&gt;&lt;th&gt;&quot;
</a><a href="#h2-1-2156" id="h2-1-2156" class="i">+        &quot;&lt;a href=\&quot;#\&quot;&gt;🔗&lt;/a&gt;&lt;/th&gt;&lt;th&gt;Date&lt;/th&gt;&quot;
</a><a href="#h2-1-2157" id="h2-1-2157" class="i">+        &quot;&lt;th&gt;Commit message&lt;/th&gt;&quot;
</a><a href="#h2-1-2158" id="h2-1-2158" class="i">+        &quot;&lt;th&gt;Author&lt;/th&gt;&lt;td class=\&quot;num\&quot;&gt;&lt;b&gt;Files&lt;/th&gt;&quot;
</a><a href="#h2-1-2159" id="h2-1-2159" class="i">+        &quot;&lt;td class=\&quot;num\&quot; id=\&quot;plus\&quot;&gt;&lt;b&gt;+&lt;/th&gt;&quot;
</a><a href="#h2-1-2160" id="h2-1-2160" class="i">+        &quot;&lt;td class=\&quot;num\&quot; id=\&quot;min\&quot;&gt;&lt;b&gt;-&lt;/th&gt;&lt;/tr&gt;\n&lt;/thead&gt;&lt;tbody&gt;\n&quot;, fp);
</a><a href="#h2-1-2161" id="h2-1-2161" class="i">+
</a><a href="#h2-1-2162" id="h2-1-2162" class="i">+  if (cachefile &amp;&amp; head) {
</a><a href="#h2-1-2163" id="h2-1-2163" class="i">+    /* read from cache file (does not need to exist) */
</a><a href="#h2-1-2164" id="h2-1-2164" class="i">+    if ((rcachefp = fopen(cachefile, &quot;r&quot;))) {
</a><a href="#h2-1-2165" id="h2-1-2165" class="i">+      if (!fgets(lastoidstr, sizeof(lastoidstr), rcachefp))
</a><a href="#h2-1-2166" id="h2-1-2166" class="i">+        errx(1, &quot;%s: no object id&quot;, cachefile);
</a><a href="#h2-1-2167" id="h2-1-2167" class="i">+      if (git_oid_fromstr(&amp;lastoid, lastoidstr))
</a><a href="#h2-1-2168" id="h2-1-2168" class="i">+        errx(1, &quot;%s: invalid object id&quot;, cachefile);
</a><a href="#h2-1-2169" id="h2-1-2169" class="i">+    }
</a><a href="#h2-1-2170" id="h2-1-2170" class="i">+
</a><a href="#h2-1-2171" id="h2-1-2171" class="i">+    /* write log to (temporary) cache */
</a><a href="#h2-1-2172" id="h2-1-2172" class="i">+    if ((fd = mkstemp(tmppath)) == -1)
</a><a href="#h2-1-2173" id="h2-1-2173" class="i">+      err(1, &quot;mkstemp&quot;);
</a><a href="#h2-1-2174" id="h2-1-2174" class="i">+    if (!(wcachefp = fdopen(fd, &quot;w&quot;)))
</a><a href="#h2-1-2175" id="h2-1-2175" class="i">+      err(1, &quot;fdopen: &#39;%s&#39;&quot;, tmppath);
</a><a href="#h2-1-2176" id="h2-1-2176" class="i">+    /* write last commit id (HEAD) */
</a><a href="#h2-1-2177" id="h2-1-2177" class="i">+    git_oid_tostr(buf, sizeof(buf), head);
</a><a href="#h2-1-2178" id="h2-1-2178" class="i">+    fprintf(wcachefp, &quot;%s\n&quot;, buf);
</a><a href="#h2-1-2179" id="h2-1-2179" class="i">+
</a><a href="#h2-1-2180" id="h2-1-2180" class="i">+    writelog(fp, head);
</a><a href="#h2-1-2181" id="h2-1-2181" class="i">+
</a><a href="#h2-1-2182" id="h2-1-2182" class="i">+    if (rcachefp) {
</a><a href="#h2-1-2183" id="h2-1-2183" class="i">+      /* append previous log to index.html and the new cache */
</a><a href="#h2-1-2184" id="h2-1-2184" class="i">+      while (!feof(rcachefp)) {
</a><a href="#h2-1-2185" id="h2-1-2185" class="i">+        n = fread(buf, 1, sizeof(buf), rcachefp);
</a><a href="#h2-1-2186" id="h2-1-2186" class="i">+        if (ferror(rcachefp))
</a><a href="#h2-1-2187" id="h2-1-2187" class="i">+          err(1, &quot;fread&quot;);
</a><a href="#h2-1-2188" id="h2-1-2188" class="i">+        if (fwrite(buf, 1, n, fp) != n ||
</a><a href="#h2-1-2189" id="h2-1-2189" class="i">+            fwrite(buf, 1, n, wcachefp) != n)
</a><a href="#h2-1-2190" id="h2-1-2190" class="i">+          err(1, &quot;fwrite&quot;);
</a><a href="#h2-1-2191" id="h2-1-2191" class="i">+      }
</a><a href="#h2-1-2192" id="h2-1-2192" class="i">+      fclose(rcachefp);
</a><a href="#h2-1-2193" id="h2-1-2193" class="i">+    }
</a><a href="#h2-1-2194" id="h2-1-2194" class="i">+    fclose(wcachefp);
</a><a href="#h2-1-2195" id="h2-1-2195" class="i">+  } else {
</a><a href="#h2-1-2196" id="h2-1-2196" class="i">+    if (head)
</a><a href="#h2-1-2197" id="h2-1-2197" class="i">+      writelog(fp, head);
</a><a href="#h2-1-2198" id="h2-1-2198" class="i">+  }
</a><a href="#h2-1-2199" id="h2-1-2199" class="i">+
</a><a href="#h2-1-2200" id="h2-1-2200" class="i">+  fputs(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&quot;, fp);
</a><a href="#h2-1-2201" id="h2-1-2201" class="i">+  writefooter(fp);
</a><a href="#h2-1-2202" id="h2-1-2202" class="i">+  fclose(fp);
</a><a href="#h2-1-2203" id="h2-1-2203" class="i">+
</a><a href="#h2-1-2204" id="h2-1-2204" class="i">+  /* files for HEAD */
</a><a href="#h2-1-2205" id="h2-1-2205" class="i">+  fp = efopen(&quot;files.html&quot;, &quot;w&quot;);
</a><a href="#h2-1-2206" id="h2-1-2206" class="i">+  writeheader(fp, &quot;Files&quot;);
</a><a href="#h2-1-2207" id="h2-1-2207" class="i">+  if (head)
</a><a href="#h2-1-2208" id="h2-1-2208" class="i">+    writefiles(fp, head);
</a><a href="#h2-1-2209" id="h2-1-2209" class="i">+  writefooter(fp);
</a><a href="#h2-1-2210" id="h2-1-2210" class="i">+  fclose(fp);
</a><a href="#h2-1-2211" id="h2-1-2211" class="i">+
</a><a href="#h2-1-2212" id="h2-1-2212" class="i">+  /* summary page with branches and tags */
</a><a href="#h2-1-2213" id="h2-1-2213" class="i">+  fp = efopen(&quot;refs.html&quot;, &quot;w&quot;);
</a><a href="#h2-1-2214" id="h2-1-2214" class="i">+  writeheader(fp, &quot;Refs&quot;);
</a><a href="#h2-1-2215" id="h2-1-2215" class="i">+  writerefs(fp);
</a><a href="#h2-1-2216" id="h2-1-2216" class="i">+  writefooter(fp);
</a><a href="#h2-1-2217" id="h2-1-2217" class="i">+  fclose(fp);
</a><a href="#h2-1-2218" id="h2-1-2218" class="i">+
</a><a href="#h2-1-2219" id="h2-1-2219" class="i">+  /* Atom feed */
</a><a href="#h2-1-2220" id="h2-1-2220" class="i">+  fp = efopen(&quot;atom.xml&quot;, &quot;w&quot;);
</a><a href="#h2-1-2221" id="h2-1-2221" class="i">+  writeatom(fp);
</a><a href="#h2-1-2222" id="h2-1-2222" class="i">+  fclose(fp);
</a><a href="#h2-1-2223" id="h2-1-2223" class="i">+
</a><a href="#h2-1-2224" id="h2-1-2224" class="i">+  /* rename new cache file on success */
</a><a href="#h2-1-2225" id="h2-1-2225" class="i">+  if (cachefile &amp;&amp; head) {
</a><a href="#h2-1-2226" id="h2-1-2226" class="i">+    if (rename(tmppath, cachefile))
</a><a href="#h2-1-2227" id="h2-1-2227" class="i">+      err(1, &quot;rename: &#39;%s&#39; to &#39;%s&#39;&quot;, tmppath, cachefile);
</a><a href="#h2-1-2228" id="h2-1-2228" class="i">+    umask((mask = umask(0)));
</a><a href="#h2-1-2229" id="h2-1-2229" class="i">+    if (chmod(cachefile,
</a><a href="#h2-1-2230" id="h2-1-2230" class="i">+        (S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP|S_IROTH|S_IWOTH) &amp; ~mask))
</a><a href="#h2-1-2231" id="h2-1-2231" class="i">+      err(1, &quot;chmod: &#39;%s&#39;&quot;, cachefile);
</a><a href="#h2-1-2232" id="h2-1-2232" class="i">+  }
</a><a href="#h2-1-2233" id="h2-1-2233" class="i">+
</a><a href="#h2-1-2234" id="h2-1-2234" class="i">+  /* cleanup */
</a><a href="#h2-1-2235" id="h2-1-2235" class="i">+  git_repository_free(repo);
</a><a href="#h2-1-2236" id="h2-1-2236" class="i">+  git_libgit2_shutdown();
</a><a href="#h2-1-2237" id="h2-1-2237" class="i">+
</a><a href="#h2-1-2238" id="h2-1-2238" class="i">+  return 0;
</a> }
<b>diff --git a/<a id="h3" href="../file/strlcat.c.html">strlcat.c</a> b/<a href="../file/strlcat.c.html">strlcat.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-/*	$OpenBSD: strlcat.c,v 1.15 2015/03/02 21:41:08 millert Exp $	*/
</a><a href="#h3-0-1" id="h3-0-1" class="i">+/*  $OpenBSD: strlcat.c,v 1.15 2015/03/02 21:41:08 millert Exp $  */
</a> 
 /*
  * Copyright (c) 1998, 2015 Todd C. Miller &lt;Todd.Miller@courtesan.com&gt;
<a href="#h3-1" id="h3-1" class="h">@@ -31,27 +31,27 @@
</a> size_t
 strlcat(char *dst, const char *src, size_t dsize)
 {
<a href="#h3-1-3" id="h3-1-3" class="d">-	const char *odst = dst;
</a><a href="#h3-1-4" id="h3-1-4" class="d">-	const char *osrc = src;
</a><a href="#h3-1-5" id="h3-1-5" class="d">-	size_t n = dsize;
</a><a href="#h3-1-6" id="h3-1-6" class="d">-	size_t dlen;
</a><a href="#h3-1-7" id="h3-1-7" class="i">+  const char *odst = dst;
</a><a href="#h3-1-8" id="h3-1-8" class="i">+  const char *osrc = src;
</a><a href="#h3-1-9" id="h3-1-9" class="i">+  size_t n = dsize;
</a><a href="#h3-1-10" id="h3-1-10" class="i">+  size_t dlen;
</a> 
<a href="#h3-1-12" id="h3-1-12" class="d">-	/* Find the end of dst and adjust bytes left but don&#39;t go past end. */
</a><a href="#h3-1-13" id="h3-1-13" class="d">-	while (n-- != 0 &amp;&amp; *dst != &#39;\0&#39;)
</a><a href="#h3-1-14" id="h3-1-14" class="d">-		dst++;
</a><a href="#h3-1-15" id="h3-1-15" class="d">-	dlen = dst - odst;
</a><a href="#h3-1-16" id="h3-1-16" class="d">-	n = dsize - dlen;
</a><a href="#h3-1-17" id="h3-1-17" class="i">+  /* Find the end of dst and adjust bytes left but don&#39;t go past end. */
</a><a href="#h3-1-18" id="h3-1-18" class="i">+  while (n-- != 0 &amp;&amp; *dst != &#39;\0&#39;)
</a><a href="#h3-1-19" id="h3-1-19" class="i">+    dst++;
</a><a href="#h3-1-20" id="h3-1-20" class="i">+  dlen = dst - odst;
</a><a href="#h3-1-21" id="h3-1-21" class="i">+  n = dsize - dlen;
</a> 
<a href="#h3-1-23" id="h3-1-23" class="d">-	if (n-- == 0)
</a><a href="#h3-1-24" id="h3-1-24" class="d">-		return(dlen + strlen(src));
</a><a href="#h3-1-25" id="h3-1-25" class="d">-	while (*src != &#39;\0&#39;) {
</a><a href="#h3-1-26" id="h3-1-26" class="d">-		if (n != 0) {
</a><a href="#h3-1-27" id="h3-1-27" class="d">-			*dst++ = *src;
</a><a href="#h3-1-28" id="h3-1-28" class="d">-			n--;
</a><a href="#h3-1-29" id="h3-1-29" class="d">-		}
</a><a href="#h3-1-30" id="h3-1-30" class="d">-		src++;
</a><a href="#h3-1-31" id="h3-1-31" class="d">-	}
</a><a href="#h3-1-32" id="h3-1-32" class="d">-	*dst = &#39;\0&#39;;
</a><a href="#h3-1-33" id="h3-1-33" class="i">+  if (n-- == 0)
</a><a href="#h3-1-34" id="h3-1-34" class="i">+    return(dlen + strlen(src));
</a><a href="#h3-1-35" id="h3-1-35" class="i">+  while (*src != &#39;\0&#39;) {
</a><a href="#h3-1-36" id="h3-1-36" class="i">+    if (n != 0) {
</a><a href="#h3-1-37" id="h3-1-37" class="i">+      *dst++ = *src;
</a><a href="#h3-1-38" id="h3-1-38" class="i">+      n--;
</a><a href="#h3-1-39" id="h3-1-39" class="i">+    }
</a><a href="#h3-1-40" id="h3-1-40" class="i">+    src++;
</a><a href="#h3-1-41" id="h3-1-41" class="i">+  }
</a><a href="#h3-1-42" id="h3-1-42" class="i">+  *dst = &#39;\0&#39;;
</a> 
<a href="#h3-1-44" id="h3-1-44" class="d">-	return(dlen + (src - osrc));	/* count does not include NUL */
</a><a href="#h3-1-45" id="h3-1-45" class="i">+  return(dlen + (src - osrc));  /* count does not include NUL */
</a> }
<b>diff --git a/<a id="h4" href="../file/strlcpy.c.html">strlcpy.c</a> b/<a href="../file/strlcpy.c.html">strlcpy.c</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-/*	$OpenBSD: strlcpy.c,v 1.12 2015/01/15 03:54:12 millert Exp $	*/
</a><a href="#h4-0-1" id="h4-0-1" class="i">+/*  $OpenBSD: strlcpy.c,v 1.12 2015/01/15 03:54:12 millert Exp $  */
</a> 
 /*
  * Copyright (c) 1998, 2015 Todd C. Miller &lt;Todd.Miller@courtesan.com&gt;
<a href="#h4-1" id="h4-1" class="h">@@ -29,24 +29,24 @@
</a> size_t
 strlcpy(char *dst, const char *src, size_t dsize)
 {
<a href="#h4-1-3" id="h4-1-3" class="d">-	const char *osrc = src;
</a><a href="#h4-1-4" id="h4-1-4" class="d">-	size_t nleft = dsize;
</a><a href="#h4-1-5" id="h4-1-5" class="i">+  const char *osrc = src;
</a><a href="#h4-1-6" id="h4-1-6" class="i">+  size_t nleft = dsize;
</a> 
<a href="#h4-1-8" id="h4-1-8" class="d">-	/* Copy as many bytes as will fit. */
</a><a href="#h4-1-9" id="h4-1-9" class="d">-	if (nleft != 0) {
</a><a href="#h4-1-10" id="h4-1-10" class="d">-		while (--nleft != 0) {
</a><a href="#h4-1-11" id="h4-1-11" class="d">-			if ((*dst++ = *src++) == &#39;\0&#39;)
</a><a href="#h4-1-12" id="h4-1-12" class="d">-				break;
</a><a href="#h4-1-13" id="h4-1-13" class="d">-		}
</a><a href="#h4-1-14" id="h4-1-14" class="d">-	}
</a><a href="#h4-1-15" id="h4-1-15" class="i">+  /* Copy as many bytes as will fit. */
</a><a href="#h4-1-16" id="h4-1-16" class="i">+  if (nleft != 0) {
</a><a href="#h4-1-17" id="h4-1-17" class="i">+    while (--nleft != 0) {
</a><a href="#h4-1-18" id="h4-1-18" class="i">+      if ((*dst++ = *src++) == &#39;\0&#39;)
</a><a href="#h4-1-19" id="h4-1-19" class="i">+        break;
</a><a href="#h4-1-20" id="h4-1-20" class="i">+    }
</a><a href="#h4-1-21" id="h4-1-21" class="i">+  }
</a> 
<a href="#h4-1-23" id="h4-1-23" class="d">-	/* Not enough room in dst, add NUL and traverse rest of src. */
</a><a href="#h4-1-24" id="h4-1-24" class="d">-	if (nleft == 0) {
</a><a href="#h4-1-25" id="h4-1-25" class="d">-		if (dsize != 0)
</a><a href="#h4-1-26" id="h4-1-26" class="d">-			*dst = &#39;\0&#39;;		/* NUL-terminate dst */
</a><a href="#h4-1-27" id="h4-1-27" class="d">-		while (*src++)
</a><a href="#h4-1-28" id="h4-1-28" class="d">-			;
</a><a href="#h4-1-29" id="h4-1-29" class="d">-	}
</a><a href="#h4-1-30" id="h4-1-30" class="i">+  /* Not enough room in dst, add NUL and traverse rest of src. */
</a><a href="#h4-1-31" id="h4-1-31" class="i">+  if (nleft == 0) {
</a><a href="#h4-1-32" id="h4-1-32" class="i">+    if (dsize != 0)
</a><a href="#h4-1-33" id="h4-1-33" class="i">+      *dst = &#39;\0&#39;;    /* NUL-terminate dst */
</a><a href="#h4-1-34" id="h4-1-34" class="i">+    while (*src++)
</a><a href="#h4-1-35" id="h4-1-35" class="i">+      ;
</a><a href="#h4-1-36" id="h4-1-36" class="i">+  }
</a> 
<a href="#h4-1-38" id="h4-1-38" class="d">-	return(src - osrc - 1);	/* count does not include NUL */
</a><a href="#h4-1-39" id="h4-1-39" class="i">+  return(src - osrc - 1);  /* count does not include NUL */
</a> }
<b>diff --git a/<a id="h5" href="../file/style.css.html">style.css</a> b/<a href="../file/style.css.html">style.css</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,74 +1,75 @@
</a> body {
<a href="#h5-0-1" id="h5-0-1" class="d">-	color: #E3E0D7;
</a><a href="#h5-0-2" id="h5-0-2" class="d">-	background-color: #242424;
</a><a href="#h5-0-3" id="h5-0-3" class="d">-	font-family: monospace;
</a><a href="#h5-0-4" id="h5-0-4" class="d">-	-webkit-text-size-adjust: none;
</a><a href="#h5-0-5" id="h5-0-5" class="i">+  color: #E3E0D7;
</a><a href="#h5-0-6" id="h5-0-6" class="i">+  background-color: #242424;
</a><a href="#h5-0-7" id="h5-0-7" class="i">+  font-family: monospace;
</a><a href="#h5-0-8" id="h5-0-8" class="i">+  -webkit-text-size-adjust: none;
</a> }
 
 h1, h2, h3, h4, h5, h6 {
<a href="#h5-0-12" id="h5-0-12" class="d">-	font-size: 1em;
</a><a href="#h5-0-13" id="h5-0-13" class="d">-	margin: 0;
</a><a href="#h5-0-14" id="h5-0-14" class="i">+  font-size: 1em;
</a><a href="#h5-0-15" id="h5-0-15" class="i">+  margin: 0;
</a> }
 
 img, h1, h2 {
<a href="#h5-0-19" id="h5-0-19" class="d">-	vertical-align: middle;
</a><a href="#h5-0-20" id="h5-0-20" class="i">+  vertical-align: middle;
</a> }
 
 img {
<a href="#h5-0-24" id="h5-0-24" class="d">-	border: 0;
</a><a href="#h5-0-25" id="h5-0-25" class="i">+  border: 0;
</a> }
 
 a {
<a href="#h5-0-29" id="h5-0-29" class="d">-	color: #8dbfff;
</a><a href="#h5-0-30" id="h5-0-30" class="i">+  color: #8dbfff;
</a> }
 
 min, a:hover {
<a href="#h5-0-34" id="h5-0-34" class="d">-	color: #F9690E;
</a><a href="#h5-0-35" id="h5-0-35" class="i">+  color: #F9690E;
</a> }
 
 a:target, tr:target {
<a href="#h5-0-39" id="h5-0-39" class="d">-	background-color: #303030;
</a><a href="#h5-0-40" id="h5-0-40" class="i">+  outline: 0.03em solid grey;
</a><a href="#h5-0-41" id="h5-0-41" class="i">+  background-color: #303030;
</a> }
 
 a.d,
 a.h,
 a.i,
 a.line {
<a href="#h5-0-48" id="h5-0-48" class="d">-	text-decoration: none;
</a><a href="#h5-0-49" id="h5-0-49" class="i">+  text-decoration: none;
</a> }
 
 #blob a {
<a href="#h5-0-53" id="h5-0-53" class="d">-	color: #777;
</a><a href="#h5-0-54" id="h5-0-54" class="i">+  color: #777;
</a> }
 
 #blob a:hover {
<a href="#h5-0-58" id="h5-0-58" class="d">-	color: #F9690E;
</a><a href="#h5-0-59" id="h5-0-59" class="d">-	background-color: #303030;
</a><a href="#h5-0-60" id="h5-0-60" class="d">-	text-decoration: none;
</a><a href="#h5-0-61" id="h5-0-61" class="i">+  color: #F9690E;
</a><a href="#h5-0-62" id="h5-0-62" class="i">+  background-color: #303030;
</a><a href="#h5-0-63" id="h5-0-63" class="i">+  text-decoration: none;
</a> }
 
 table th {
<a href="#h5-0-67" id="h5-0-67" class="d">-	font-weight: bold;
</a><a href="#h5-0-68" id="h5-0-68" class="d">-	text-align: left;
</a><a href="#h5-0-69" id="h5-0-69" class="i">+  font-weight: bold;
</a><a href="#h5-0-70" id="h5-0-70" class="i">+  text-align: left;
</a> }
 @media screen and (min-width: 600px) {
<a href="#h5-0-73" id="h5-0-73" class="d">-	table:not(#branches) th {
</a><a href="#h5-0-74" id="h5-0-74" class="d">-		text-align: center;
</a><a href="#h5-0-75" id="h5-0-75" class="d">-	}
</a><a href="#h5-0-76" id="h5-0-76" class="i">+  table:not(#branches) th {
</a><a href="#h5-0-77" id="h5-0-77" class="i">+    text-align: center;
</a><a href="#h5-0-78" id="h5-0-78" class="i">+  }
</a> }
 
 table td, table th {
<a href="#h5-0-82" id="h5-0-82" class="d">-	padding: 0 0.4em;
</a><a href="#h5-0-83" id="h5-0-83" class="i">+  padding: 0 0.4em;
</a> }
 
 #blob, div#table-scroll, div#pre-scroll {
<a href="#h5-0-87" id="h5-0-87" class="d">-	overflow: scroll;
</a><a href="#h5-0-88" id="h5-0-88" class="d">-	padding-bottom: 3em;
</a><a href="#h5-0-89" id="h5-0-89" class="i">+  overflow: scroll;
</a><a href="#h5-0-90" id="h5-0-90" class="i">+  padding-bottom: 3em;
</a> }
 
 #content table td, #content table th {
<a href="#h5-0-94" id="h5-0-94" class="d">-	vertical-align: top;
</a><a href="#h5-0-95" id="h5-0-95" class="d">-	white-space: nowrap;
</a><a href="#h5-0-96" id="h5-0-96" class="i">+  vertical-align: top;
</a><a href="#h5-0-97" id="h5-0-97" class="i">+  white-space: nowrap;
</a> }
 
 #branches tr:hover td,
<a href="#h5-1" id="h5-1" class="h">@@ -76,54 +77,54 @@ table td, table th {
</a> #index tr:hover td,
 #log tr:hover td,
 #files tr:hover td {
<a href="#h5-1-3" id="h5-1-3" class="d">-	background-color: #303030;
</a><a href="#h5-1-4" id="h5-1-4" class="i">+  background-color: #303030;
</a> }
 
 #index tr td:nth-child(2),
 #tags tr td:nth-child(3),
 #branches tr td:nth-child(3),
 #log tr td:nth-child(2) {
<a href="#h5-1-11" id="h5-1-11" class="d">-	white-space: normal;
</a><a href="#h5-1-12" id="h5-1-12" class="i">+  white-space: normal;
</a> }
 
 th.num, td.num {
<a href="#h5-1-16" id="h5-1-16" class="d">-	text-align: right;
</a><a href="#h5-1-17" id="h5-1-17" class="i">+  text-align: right;
</a> }
 
 .desc {
<a href="#h5-1-21" id="h5-1-21" class="d">-	color: #777;
</a><a href="#h5-1-22" id="h5-1-22" class="i">+  color: #777;
</a> }
 
 hr {
<a href="#h5-1-26" id="h5-1-26" class="d">-	border: 0;
</a><a href="#h5-1-27" id="h5-1-27" class="d">-	border-top: 1px solid #777;
</a><a href="#h5-1-28" id="h5-1-28" class="d">-	height: 1px;
</a><a href="#h5-1-29" id="h5-1-29" class="i">+  border: 0;
</a><a href="#h5-1-30" id="h5-1-30" class="i">+  border-top: 1px solid #777;
</a><a href="#h5-1-31" id="h5-1-31" class="i">+  height: 1px;
</a> }
 
 pre {
<a href="#h5-1-35" id="h5-1-35" class="d">-	font-family: monospace;
</a><a href="#h5-1-36" id="h5-1-36" class="i">+  font-family: monospace;
</a> }
 
 pre a.h {
<a href="#h5-1-40" id="h5-1-40" class="d">-	color: #8DBFFF;
</a><a href="#h5-1-41" id="h5-1-41" class="i">+  color: #8DBFFF;
</a> }
 
 .A,
 #plus,
 span.i,
 pre a.i {
<a href="#h5-1-48" id="h5-1-48" class="d">-	color: #79D688;
</a><a href="#h5-1-49" id="h5-1-49" class="i">+  color: #79D688;
</a> }
 
 .D,
 #min,
 span.d,
 pre a.d {
<a href="#h5-1-56" id="h5-1-56" class="d">-	color: #F9690E;
</a><a href="#h5-1-57" id="h5-1-57" class="i">+  color: #F9690E;
</a> }
 
 pre a.h:hover,
 pre a.i:hover,
 pre a.d:hover {
<a href="#h5-1-63" id="h5-1-63" class="d">-	text-decoration: none;
</a><a href="#h5-1-64" id="h5-1-64" class="i">+  text-decoration: none;
</a> }
</pre>
</div>
</div>
</body>
</html>
